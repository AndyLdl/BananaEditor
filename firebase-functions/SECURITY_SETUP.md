# ğŸ” äº‘å‡½æ•°å®‰å…¨é…ç½®æŒ‡å—

## é—®é¢˜åˆ†æ

ä½ çš„äº‘å‡½æ•°ç›®å‰å­˜åœ¨ä»¥ä¸‹å®‰å…¨é£é™©ï¼š

1. **å®Œå…¨å¼€æ”¾** - ä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥è°ƒç”¨API
2. **æ˜æ–‡ä¼ è¾“** - è¯·æ±‚æ•°æ®æœªåŠ å¯†ï¼Œå®¹æ˜“è¢«æ‹¦æˆª
3. **æ— èº«ä»½éªŒè¯** - æ²¡æœ‰APIå¯†é’¥æˆ–ä»¤ç‰ŒéªŒè¯
4. **å®¹æ˜“è¢«æ»¥ç”¨** - æ²¡æœ‰é™æµæœºåˆ¶

## ğŸ›¡ï¸ è§£å†³æ–¹æ¡ˆï¼šè¯·æ±‚ä½“åŠ å¯†

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„åŠ å¯†æ–¹æ¡ˆï¼š

### 1. åŠ å¯†æµç¨‹

```
å®¢æˆ·ç«¯ â†’ åŠ å¯†è¯·æ±‚ä½“ â†’ æ·»åŠ ç­¾å â†’ å‘é€åˆ°äº‘å‡½æ•°
äº‘å‡½æ•° â†’ éªŒè¯ç­¾å â†’ è§£å¯†è¯·æ±‚ä½“ â†’ å¤„ç†è¯·æ±‚
```

### 2. å®‰å…¨ç‰¹æ€§

- âœ… **è¯·æ±‚ä½“åŠ å¯†** - ä½¿ç”¨AES-256-CBCåŠ å¯†
- âœ… **æ—¶é—´æˆ³éªŒè¯** - é˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
- âœ… **ç­¾åéªŒè¯** - ç¡®ä¿è¯·æ±‚å®Œæ•´æ€§
- âœ… **ç®€å•æ˜“ç”¨** - æœ€å°åŒ–ä»£ç æ”¹åŠ¨

## ğŸš€ å¿«é€Ÿé…ç½®

### æ­¥éª¤1ï¼šè®¾ç½®ç¯å¢ƒå˜é‡

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨é…ç½®è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

```bash
cd firebase-functions
node configure-security.js
```

#### æ–¹æ³•äºŒï¼šé€šè¿‡ Firebase CLI é…ç½®ï¼ˆæ¨èï¼‰

```bash
# è®¾ç½®åŠ å¯†å¯†é’¥
firebase functions:config:set app.encryption_key="your-32-character-secret-key-here!"

# è®¾ç½®å…è®¸çš„æ¥æº
firebase functions:config:set app.allowed_origins="https://yourdomain.com,https://www.yourdomain.com"

# éƒ¨ç½²é…ç½®
firebase deploy --only functions
```

#### æ–¹æ³•äºŒï¼šé€šè¿‡ .env æ–‡ä»¶é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

åœ¨ `firebase-functions/functions/.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
# åŠ å¯†å¯†é’¥ï¼ˆ32å­—ç¬¦ï¼‰
ENCRYPTION_KEY=your-32-character-secret-key-here!

# å…è®¸çš„æ¥æºï¼ˆå¼€å‘ç¯å¢ƒå¯ä»¥è®¾ç½®ä¸º * å…è®¸æ‰€æœ‰ï¼‰
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com,http://localhost:4321
```

### æ­¥éª¤2ï¼šç”ŸæˆåŠ å¯†å¯†é’¥

```bash
# ç”Ÿæˆ64ä½åå…­è¿›åˆ¶å¯†é’¥
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### æ­¥éª¤3ï¼šæ›´æ–°å‰ç«¯ä»£ç 

åœ¨ `BananaAIProcessor.astro` ä¸­ï¼š

```javascript
import { SecureBananaAIProcessor } from "../utils/secure-api-client.ts";

// æ›¿æ¢åŸæœ‰çš„è°ƒç”¨æ–¹å¼
const secureProcessor = new SecureBananaAIProcessor(this.cloudFunctionUrl);
const result = await secureProcessor.callCloudFunction(
  prompt,
  conversationHistory,
);
```

### æ­¥éª¤4ï¼šéƒ¨ç½²äº‘å‡½æ•°

```bash
cd firebase-functions
npm install
firebase deploy --only functions
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡å            | è¯´æ˜                   | ç¤ºä¾‹å€¼                               |
| ----------------- | ---------------------- | ------------------------------------ |
| `ENCRYPTION_KEY`  | åŠ å¯†å¯†é’¥ï¼ˆ32å­—ç¬¦ï¼‰     | `your-32-character-secret-key-here!` |
| `ALLOWED_ORIGINS` | å…è®¸çš„æ¥æºï¼ˆé€—å·åˆ†éš”ï¼‰ | `https://yourdomain.com`             |

### å®‰å…¨çº§åˆ«

| çº§åˆ«     | æè¿°                      | å®ç°éš¾åº¦ |
| -------- | ------------------------- | -------- |
| **åŸºç¡€** | è¯·æ±‚ä½“åŠ å¯† + ç­¾åéªŒè¯     | â­â­     |
| **ä¸­çº§** | åŸºç¡€ + APIå¯†é’¥ + é™æµ     | â­â­â­   |
| **é«˜çº§** | ä¸­çº§ + JWTè®¤è¯ + IPç™½åå• | â­â­â­â­ |

## ğŸš¨ å®‰å…¨å»ºè®®

### 1. å¯†é’¥ç®¡ç†

- âœ… ä½¿ç”¨å¼ºéšæœºå¯†é’¥
- âœ… å®šæœŸè½®æ¢å¯†é’¥
- âœ… ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥

### 2. ç›‘æ§å’Œæ—¥å¿—

- âœ… è®°å½•æ‰€æœ‰APIè°ƒç”¨
- âœ… ç›‘æ§å¼‚å¸¸è¯·æ±‚
- âœ… è®¾ç½®å‘Šè­¦æœºåˆ¶

### 3. éƒ¨ç½²å®‰å…¨

- âœ… ä½¿ç”¨HTTPS
- âœ… è®¾ç½®CORSç­–ç•¥
- âœ… å®šæœŸæ›´æ–°ä¾èµ–

## ğŸ“Š æ•ˆæœå¯¹æ¯”

| æ–¹é¢           | ä¿®æ”¹å‰      | ä¿®æ”¹å      |
| -------------- | ----------- | ----------- |
| **å®‰å…¨æ€§**     | âŒ å®Œå…¨å¼€æ”¾ | âœ… åŠ å¯†ä¿æŠ¤ |
| **é˜²æ»¥ç”¨**     | âŒ æ— é™åˆ¶   | âœ… ç­¾åéªŒè¯ |
| **æ•°æ®ä¿æŠ¤**   | âŒ æ˜æ–‡ä¼ è¾“ | âœ… åŠ å¯†ä¼ è¾“ |
| **å®ç°å¤æ‚åº¦** | -           | â­â­ ç®€å•   |

## ğŸ” æµ‹è¯•éªŒè¯

### æµ‹è¯• CORS é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

1. **æµ‹è¯•å…è®¸çš„æ¥æº**ï¼ˆåº”è¯¥æˆåŠŸï¼‰ï¼š

```bash
curl -H "Origin: https://yourdomain.com" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     https://your-function-url
```

2. **æµ‹è¯•ä¸å…è®¸çš„æ¥æº**ï¼ˆåº”è¯¥å¤±è´¥ï¼‰ï¼š

```bash
curl -H "Origin: https://malicious-site.com" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     https://your-function-url
```

### æµ‹è¯•åŠ å¯†æ˜¯å¦ç”Ÿæ•ˆ

1. **ç›´æ¥è°ƒç”¨æµ‹è¯•**ï¼ˆåº”è¯¥å¤±è´¥ï¼‰ï¼š

```bash
curl -X POST https://your-function-url \
  -H "Content-Type: application/json" \
  -d '{"prompt":"test"}'
```

2. **åŠ å¯†è°ƒç”¨æµ‹è¯•**ï¼ˆåº”è¯¥æˆåŠŸï¼‰ï¼š

```javascript
import { secureApiCall } from "./utils/secure-api-client.ts";
const response = await secureApiCall(url, { prompt: "test" });
```

### éªŒè¯ç¯å¢ƒå˜é‡é…ç½®

åœ¨äº‘å‡½æ•°æ—¥å¿—ä¸­æŸ¥çœ‹ï¼š

```bash
firebase functions:log
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š

```
ğŸ” CORSæ£€æŸ¥: {
  requestOrigin: "https://yourdomain.com",
  allowedOrigins: ["https://yourdomain.com", "https://www.yourdomain.com"],
  isAllowed: true
}
```

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"ç¼ºå°‘åŠ å¯†è¯·æ±‚å¤´"**
   - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†åŠ å¯†å®¢æˆ·ç«¯
   - ç¡®è®¤è¯·æ±‚å¤´è®¾ç½®æ­£ç¡®

2. **"è¯·æ±‚ç­¾åéªŒè¯å¤±è´¥"**
   - æ£€æŸ¥åŠ å¯†å¯†é’¥æ˜¯å¦ä¸€è‡´
   - ç¡®è®¤æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆ

3. **"è¯·æ±‚æ—¶é—´æˆ³æ— æ•ˆ"**
   - æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦åŒæ­¥
   - ç¡®è®¤æ—¶é—´æˆ³åœ¨5åˆ†é’Ÿæœ‰æ•ˆæœŸå†…

### è°ƒè¯•æ¨¡å¼

åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š

```javascript
// åœ¨äº‘å‡½æ•°ä¸­æ·»åŠ 
console.log("ğŸ” åŠ å¯†éªŒè¯:", {
  hasEncryptedData: !!encryptedData,
  hasSignature: !!signature,
  hasTimestamp: !!timestamp,
  timestampValid: isTimestampValid(parseInt(timestamp)),
});
```

## ğŸ“ˆ æ€§èƒ½å½±å“

- **åŠ å¯†å¼€é”€**: ~5-10ms
- **ç½‘ç»œä¼ è¾“**: æ•°æ®é‡å¢åŠ çº¦20%
- **æ€»ä½“å½±å“**: å‡ ä¹æ— æ„ŸçŸ¥

## ğŸ”„ å‡çº§è·¯å¾„

å¦‚æœå°†æ¥éœ€è¦æ›´é«˜çº§çš„å®‰å…¨åŠŸèƒ½ï¼š

1. **æ·»åŠ APIå¯†é’¥éªŒè¯**
2. **å®ç°JWTè®¤è¯**
3. **æ·»åŠ é™æµæœºåˆ¶**
4. **é›†æˆIPç™½åå•**

è¿™ä¸ªæ–¹æ¡ˆæ—¢ç®€å•åˆæœ‰æ•ˆï¼Œèƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢APIè¢«ç›´æ¥è°ƒç”¨å’Œæ»¥ç”¨ï¼
