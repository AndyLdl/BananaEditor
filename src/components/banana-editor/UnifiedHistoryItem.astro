---
// BananaEditor ç»Ÿä¸€å†å²é¡¹ç›®ç»„ä»¶
// æ—¢å¯ä»¥ä½œä¸ºç¼©ç•¥å›¾æ˜¾ç¤ºï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

export interface Props {
  className?: string;
  mode?: "thumbnail" | "detailed";
}

const { className = "", mode = "thumbnail" } = Astro.props;
---

<div class={`unified-history-item ${className}`} id="unified-history-item">
  <!-- å†å²è®°å½•å®¹å™¨ -->
  <div id="history-list" class="history-list"></div>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <div id="history-empty" class="history-empty" style="display: none;">
    <div class="empty-content">
      <svg
        width="48"
        height="48"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21,15 16,10 5,21"></polyline>
      </svg>
      <p>No images generated yet</p>
      <p class="empty-subtitle">Start creating amazing images with AI</p>
    </div>
  </div>

  <!-- ç»Ÿä¸€å†å²é¡¹ç›®æ¨¡æ¿ -->
  <template id="unified-history-item-template">
    <div class="history-item" data-id="" data-mode="thumbnail">
      <!-- å›¾ç‰‡åŒºåŸŸ -->
      <div class="item-image">
        <img src="" alt="History image" />
        <div class="item-overlay">
          <button class="overlay-btn view-btn" title="View large image">
            <svg
              class="btn-icon"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
          </button>
          <button class="overlay-btn use-btn" title="Use this image">
            <svg
              class="btn-icon"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
          </button>
          <button class="overlay-btn delete-btn" title="Delete">
            <svg
              class="btn-icon"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
          </button>
        </div>
        <div class="item-status current" style="display: none;"></div>
      </div>

      <!-- è¯¦ç»†ä¿¡æ¯åŒºåŸŸï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ -->
      <div class="item-details">
        <div class="item-prompt">
          <span class="prompt-text"></span>
        </div>
        <div class="item-meta">
          <span class="meta-time"></span>
          <span class="meta-size"></span>
        </div>
        <div class="item-actions">
          <button class="action-btn primary use-btn-detailed">
            <svg
              class="btn-icon"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
            <span class="btn-text">Use</span>
          </button>
          <button class="action-btn secondary more-btn">
            <svg
              class="btn-icon"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <circle cx="12" cy="12" r="1"></circle>
              <circle cx="19" cy="12" r="1"></circle>
              <circle cx="5" cy="12" r="1"></circle>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </template>
</div>

<style>
  /* ç»Ÿä¸€å†å²é¡¹ç›®ç»„ä»¶æ ·å¼ */
  .unified-history-item {
    width: 100%;
    height: 100%;
  }

  /* å†å²è®°å½•å®¹å™¨ */
  .history-list {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding: 16px;
    min-height: 200px;
    overflow-y: auto;
  }

  /* ç©ºçŠ¶æ€æ ·å¼ */
  .history-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    color: #666;
    text-align: center;
  }

  .empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .empty-content svg {
    opacity: 0.5;
  }

  .empty-content p {
    margin: 0;
    font-size: 16px;
    font-weight: 500;
  }

  .empty-subtitle {
    font-size: 14px;
    opacity: 0.7;
  }

  /* åŸºç¡€å†å²é¡¹ç›®æ ·å¼ */
  .history-item {
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    background: white;
    display: flex;
    flex-direction: column;
  }

  .history-item:hover {
    border-color: #ffd700;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .history-item.current {
    border-color: #ffd700;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
  }

  /* ç¼©ç•¥å›¾æ¨¡å¼ */
  .history-item[data-mode="thumbnail"] {
    width: 150px;
    height: 150px;
    flex-shrink: 0;
  }

  .history-item[data-mode="thumbnail"]:hover {
    transform: scale(1.05);
  }

  .history-item[data-mode="thumbnail"] .item-details {
    display: none;
  }

  /* è¯¦ç»†æ¨¡å¼ */
  .history-item[data-mode="detailed"] {
    width: 100%;
    min-height: 120px;
    flex-direction: row;
    gap: 12px;
    padding: 12px;
    margin-bottom: 12px;
  }

  .history-item[data-mode="detailed"]:hover {
    transform: translateY(-2px);
  }

  .history-item[data-mode="detailed"] .item-image {
    width: 96px;
    height: 96px;
    flex-shrink: 0;
  }

  .history-item[data-mode="detailed"] .item-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0;
  }

  /* å›¾ç‰‡åŒºåŸŸ */
  .item-image {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 6px;
    overflow: hidden;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
  }

  .item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* æ‚¬åœæ“ä½œæŒ‰é’® */
  .item-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      135deg,
      rgba(0, 0, 0, 0.7) 0%,
      rgba(0, 0, 0, 0.5) 100%
    );
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 6px;
  }

  .history-item:hover .item-overlay {
    opacity: 1;
  }

  .overlay-btn {
    width: 36px;
    height: 36px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    color: #64748b;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
  }

  .overlay-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 215, 0, 0.3),
      transparent
    );
    transition: left 0.5s ease;
  }

  .overlay-btn:hover::before {
    left: 100%;
  }

  .overlay-btn:hover {
    background: rgba(255, 248, 220, 0.98);
    border-color: #ffd700;
    color: #2d1810;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }

  .overlay-btn:active {
    transform: translateY(0) scale(1);
  }

  .overlay-btn.delete-btn:hover {
    background: rgba(254, 226, 226, 0.98);
    border-color: #ef4444;
    color: #dc2626;
  }

  /* ç¼©ç•¥å›¾æ¨¡å¼çš„overlayè°ƒæ•´ */
  .history-item[data-mode="thumbnail"] .overlay-btn {
    width: 28px;
    height: 28px;
  }

  .history-item[data-mode="thumbnail"] .overlay-btn .btn-icon {
    width: 12px;
    height: 12px;
  }

  .history-item[data-mode="thumbnail"] .item-overlay {
    gap: 8px;
  }

  /* å½“å‰é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨ */
  .item-status {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 10px;
    height: 10px;
    background: #ffd700;
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  /* è¯¦ç»†ä¿¡æ¯åŒºåŸŸ */
  .item-details {
    display: none;
  }

  .item-prompt {
    flex: 1;
    font-size: 14px;
    line-height: 1.4;
    color: #374151;
    overflow: hidden;
  }

  .prompt-text {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .item-meta {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: #6b7280;
  }

  .item-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .action-btn.primary {
    background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
    border-color: #ffd700;
    color: #2d1810;
  }

  .action-btn.primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
  }

  .action-btn.secondary {
    background: white;
    color: #6b7280;
    width: 32px;
    height: 32px;
    padding: 0;
    justify-content: center;
  }

  .action-btn.secondary:hover {
    border-color: #ffd700;
    background: rgba(255, 248, 220, 0.5);
  }

  .btn-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
  }

  .btn-text {
    font-size: 11px;
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .history-item[data-mode="detailed"] {
      flex-direction: column;
      gap: 8px;
    }

    .history-item[data-mode="detailed"] .item-image {
      width: 100%;
      height: 120px;
    }

    .item-actions {
      flex-direction: column;
      gap: 6px;
    }

    .action-btn {
      width: 100%;
      justify-content: center;
    }

    .action-btn.secondary {
      width: 100%;
    }
  }
</style>

<script>
  // ç»Ÿä¸€å†å²ç®¡ç†ç±»
  class UnifiedHistoryManager {
    galleryScroll: HTMLElement | null = null;
    galleryEmpty: HTMLElement | null = null;
    template: HTMLTemplateElement | null = null;
    items: any[] = [];
    currentId: string | null = null;
    displayMode: string = "thumbnail";

    constructor() {
      this.galleryScroll = null;
      this.galleryEmpty = null;
      this.template = null;
      this.items = [];
      this.currentId = null;
      this.displayMode = "thumbnail"; // 'thumbnail' æˆ– 'detailed'

      // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå‡†å¤‡å¥½
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () =>
          this.initializeElements()
        );
      } else {
        this.initializeElements();
      }
    }

    initializeElements() {
      this.galleryScroll = document.getElementById("history-list");
      this.galleryEmpty = document.getElementById("history-empty");
      this.template = document.getElementById(
        "unified-history-item-template"
      ) as HTMLTemplateElement;

      if (!this.galleryScroll) {
        console.warn("history-list element not found, retrying...");
        setTimeout(() => this.initializeElements(), 100);
        return;
      }

      this.init();
    }

    init() {
      // ç›‘å¬å†å²ç›¸å…³äº‹ä»¶
      // æ³¨æ„ï¼šä¸å†ç›‘å¬ imageGenerated äº‹ä»¶ï¼Œé¿å…é‡å¤æ·»åŠ 
      // æ”¹ä¸ºç»Ÿä¸€ä½¿ç”¨ messageUpdate äº‹ä»¶æ¥å¤„ç†æ–°å›¾ç‰‡

      window.addEventListener("imageSelected", (e: any) => {
        this.setCurrentItem(e.detail.id);
      });

      // ç›‘å¬æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢
      window.addEventListener("historyDisplayModeChange", (e: any) => {
        this.setDisplayMode(e.detail.mode);
      });

      // ç›‘å¬æ–°æ¶ˆæ¯æ·»åŠ  - æ™ºèƒ½æ›´æ–°å†å²åˆ—è¡¨
      window.addEventListener("messageUpdate", (e: any) => {
        const { sessionId, message } = e.detail;
        // åªå¤„ç†å½“å‰ä¼šè¯çš„æ¶ˆæ¯
        if (
          window.sessionManager &&
          sessionId === window.sessionManager.currentSessionId
        ) {
          // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŒ…å«å›¾ç‰‡ï¼Œæ·»åŠ åˆ°å†å²åˆ—è¡¨æœ€å‰é¢
          if (message.role === "model" && message.imageUrl) {
            console.log(
              "ğŸ–¼ï¸ [UnifiedHistoryManager] New image detected, adding to history"
            );
            const session = window.sessionManager.getCurrentSession();
            const prevMsgIndex = session.messages.indexOf(message) - 1;
            const prevMsg =
              prevMsgIndex >= 0 ? session.messages[prevMsgIndex] : null;
            const prompt =
              prevMsg && prevMsg.role === "user"
                ? prevMsg.content
                : "Image generated";

            this.addHistoryItem({
              id:
                message.id ||
                `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              imageUrl: message.imageUrl,
              prompt: prompt,
              timestamp: message.timestamp || Date.now(),
              size: "1024x1024",
            });
          }
        }
      });

      // ç›‘å¬ä¼šè¯åˆ‡æ¢äº‹ä»¶
      window.addEventListener("sessionSwitch", (e) => {
        console.log("ğŸ–¼ï¸ [UnifiedHistoryManager] Session switch detected");
        this.renderSessionHistory();
      });

      // æ¸…ç©ºå†å²æŒ‰é’®
      const clearBtn = document.getElementById("clear-history");
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          this.clearHistory();
        });
      }

      // å¯¼å‡ºå…¨éƒ¨æŒ‰é’®
      const exportBtn = document.getElementById("export-all");
      if (exportBtn) {
        exportBtn.addEventListener("click", () => {
          this.exportAll();
        });
      }

      // ç­‰å¾… SessionManager åˆå§‹åŒ–ååŠ è½½å½“å‰ä¼šè¯çš„å†å²
      this.waitForSessionManagerAndLoad();
    }

    // ç­‰å¾… SessionManager å¹¶åŠ è½½å†å²
    waitForSessionManagerAndLoad() {
      const check = () => {
        if (window.sessionManager) {
          this.renderSessionHistory();
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    }

    // æ¸²æŸ“å½“å‰ä¼šè¯çš„å†å²è®°å½•
    renderSessionHistory() {
      if (!window.sessionManager) {
        console.warn("âš ï¸ [UnifiedHistoryManager] SessionManager not available");
        return;
      }

      const session = window.sessionManager.getCurrentSession();
      if (!session) {
        console.warn("âš ï¸ [UnifiedHistoryManager] No current session");
        this.clearHistoryDisplay();
        return;
      }

      console.log(
        `ğŸ–¼ï¸ [UnifiedHistoryManager] Rendering history for session: ${session.id}`
      );
      console.log(`   Messages in session: ${session.messages.length}`);

      // æ¸…ç©ºå½“å‰æ˜¾ç¤º
      this.clearHistoryDisplay();

      // ä»ä¼šè¯æ¶ˆæ¯ä¸­æå–æ‰€æœ‰å¸¦å›¾ç‰‡çš„è®°å½•
      const imagesWithPrompts = [];
      session.messages.forEach((msg, index) => {
        if (msg.role === "model" && msg.imageUrl) {
          // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æç¤ºè¯ï¼ˆå‰ä¸€æ¡æ¶ˆæ¯ï¼‰
          const prevMsg = index > 0 ? session.messages[index - 1] : null;
          const prompt =
            prevMsg && prevMsg.role === "user"
              ? prevMsg.content
              : "Image generated";

          imagesWithPrompts.push({
            id:
              msg.id ||
              `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            imageUrl: msg.imageUrl,
            prompt: prompt,
            timestamp: msg.timestamp || Date.now(),
            size: "1024x1024", // é»˜è®¤å¤§å°
          });
        }
      });

      console.log(`   Found ${imagesWithPrompts.length} images in history`);

      // æ¸²æŸ“æ‰€æœ‰å›¾ç‰‡ï¼ˆä»åå¾€å‰éå†ï¼Œæœ€æ–°çš„åœ¨å·¦è¾¹ï¼‰
      for (let i = imagesWithPrompts.length - 1; i >= 0; i--) {
        this.addHistoryItemToDOM(imagesWithPrompts[i]);
      }

      this.updateVisibility();

      // å¦‚æœæœ‰å›¾ç‰‡ï¼Œè‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€å¼ ï¼ˆæœ€æ–°çš„é‚£å¼ ï¼‰
      // ä½¿ç”¨ setTimeout ç¡®ä¿ BananaAIProcessor çš„äº‹ä»¶ç›‘å¬å™¨å·²ç»è®¾ç½®å¥½
      if (imagesWithPrompts.length > 0) {
        const firstImage = imagesWithPrompts[imagesWithPrompts.length - 1];
        console.log(
          `ğŸ¯ [UnifiedHistoryManager] Auto-selecting first image: ${firstImage.id}`,
          firstImage.imageUrl
        );
        setTimeout(() => {
          this.selectItem(firstImage.id);
          console.log("âœ… [UnifiedHistoryManager] First image selected");
        }, 300);
      }
    }

    // æ¸…ç©ºå†å²æ˜¾ç¤ºï¼ˆä¸è§¦å‘äº‹ä»¶ï¼‰
    clearHistoryDisplay() {
      this.items = [];
      this.currentId = null;
      if (this.galleryScroll) {
        this.galleryScroll.innerHTML = "";
      }
    }

    // æ·»åŠ å†å²é¡¹ç›®åˆ° DOMï¼ˆä¸æ·»åŠ åˆ° items æ•°ç»„ï¼Œå› ä¸ºæ•°æ®æ¥è‡ª sessionï¼‰
    addHistoryItemToDOM(data: any) {
      const { id, imageUrl, prompt, timestamp, size } = data;

      if (!this.template || !this.galleryScroll) return;

      // å…‹éš†æ¨¡æ¿
      const clone = this.template.content.cloneNode(true);
      const item = clone.querySelector(".history-item") as HTMLElement;

      // è®¾ç½®æ•°æ®
      item.dataset.id = id;
      item.dataset.mode = this.displayMode;

      const img = item.querySelector("img") as HTMLImageElement;
      img.src = imageUrl;
      img.alt = `Generated image: ${prompt}`;

      const promptText = item.querySelector(".prompt-text");
      if (promptText) {
        promptText.textContent = prompt;
      }

      const metaTime = item.querySelector(".meta-time");
      if (metaTime) {
        metaTime.textContent = this.formatTime(timestamp);
      }

      const metaSize = item.querySelector(".meta-size");
      if (metaSize) {
        metaSize.textContent = size || "--";
      }

      // ç»‘å®šäº‹ä»¶
      this.bindItemEvents(item, data);

      // æ’å…¥åˆ°åˆ—è¡¨
      this.galleryScroll.appendChild(item);

      // æ›´æ–°å†…éƒ¨æ•°ç»„
      this.items.push(data);
    }

    // è®¾ç½®æ˜¾ç¤ºæ¨¡å¼
    setDisplayMode(mode: string) {
      this.displayMode = mode;

      if (!this.galleryScroll) return;

      // æ›´æ–°æ‰€æœ‰ç°æœ‰é¡¹ç›®çš„æ˜¾ç¤ºæ¨¡å¼
      const items = this.galleryScroll.querySelectorAll(".history-item");
      items.forEach((item) => {
        (item as HTMLElement).dataset.mode = mode;
      });

      // è°ƒæ•´å®¹å™¨æ ·å¼
      if (mode === "detailed") {
        this.galleryScroll.style.flexDirection = "column";
        this.galleryScroll.style.alignItems = "stretch";
      } else {
        this.galleryScroll.style.flexDirection = "row";
        this.galleryScroll.style.alignItems = "center";
      }
    }

    // æ·»åŠ å†å²é¡¹ç›®
    addHistoryItem(data: any) {
      const { id, imageUrl, prompt, timestamp, size } = data;

      if (!this.template || !this.galleryScroll) return;

      // å…‹éš†æ¨¡æ¿
      const clone = this.template.content.cloneNode(true);
      const item = clone.querySelector(".history-item") as HTMLElement;

      // è®¾ç½®æ•°æ®
      item.dataset.id = id;
      item.dataset.mode = this.displayMode;

      const img = item.querySelector("img") as HTMLImageElement;
      img.src = imageUrl;
      img.alt = `Generated image: ${prompt}`;

      const promptText = item.querySelector(".prompt-text");
      if (promptText) {
        promptText.textContent = prompt;
      }

      const metaTime = item.querySelector(".meta-time");
      if (metaTime) {
        metaTime.textContent = this.formatTime(timestamp);
      }

      const metaSize = item.querySelector(".meta-size");
      if (metaSize) {
        metaSize.textContent = size || "--";
      }

      // ç»‘å®šäº‹ä»¶
      this.bindItemEvents(item, data);

      // æ’å…¥åˆ°åˆ—è¡¨å¼€å¤´
      this.galleryScroll.insertBefore(item, this.galleryScroll.firstChild);

      // æ›´æ–°çŠ¶æ€
      this.items.unshift(data);
      this.setCurrentItem(id);
      this.updateVisibility();

      // æ»šåŠ¨åˆ°æœ€å·¦è¾¹/é¡¶éƒ¨æ˜¾ç¤ºæ–°é¡¹ç›®
      if (this.displayMode === "thumbnail") {
        this.galleryScroll.scrollLeft = 0;
      } else {
        this.galleryScroll.scrollTop = 0;
      }
    }

    // ç»‘å®šé¡¹ç›®äº‹ä»¶
    bindItemEvents(item: HTMLElement, data: any) {
      const { id, imageUrl } = data;

      // ç‚¹å‡»é¡¹ç›®é€‰æ‹©
      item.addEventListener("click", (e: Event) => {
        const target = e.target as HTMLElement;
        if (!target.closest(".overlay-btn") && !target.closest(".action-btn")) {
          this.selectItem(id);
        }
      });

      // æŸ¥çœ‹å¤§å›¾æŒ‰é’®
      const viewBtns = item.querySelectorAll(".view-btn");
      viewBtns.forEach((btn) => {
        btn.addEventListener("click", (e: Event) => {
          e.stopPropagation();
          this.viewImage(imageUrl);
        });
      });

      // ä½¿ç”¨æ­¤å›¾ç‰‡æŒ‰é’®
      const useBtns = item.querySelectorAll(".use-btn, .use-btn-detailed");
      useBtns.forEach((btn) => {
        btn.addEventListener("click", (e: Event) => {
          e.stopPropagation();
          this.useImage(data);
        });
      });

      // åˆ é™¤æŒ‰é’®
      const deleteBtns = item.querySelectorAll(".delete-btn");
      deleteBtns.forEach((btn) => {
        btn.addEventListener("click", (e: Event) => {
          e.stopPropagation();
          this.deleteItem(id);
        });
      });

      // æ›´å¤šæ“ä½œæŒ‰é’®
      const moreBtns = item.querySelectorAll(".more-btn");
      moreBtns.forEach((btn) => {
        btn.addEventListener("click", (e: Event) => {
          e.stopPropagation();
          this.showMoreActions(data);
        });
      });
    }

    // é€‰æ‹©é¡¹ç›®
    selectItem(id: string) {
      // æ£€æŸ¥DOMæ˜¯å¦å‡†å¤‡å¥½
      if (!this.galleryScroll) {
        console.warn("DOM not ready, deferring selectItem");
        // å»¶è¿Ÿæ‰§è¡Œ
        setTimeout(() => this.selectItem(id), 100);
        return;
      }

      this.setCurrentItem(id);

      const item = this.items.find((item) => item.id === id);
      if (item) {
        // è§¦å‘å›¾ç‰‡é€‰æ‹©äº‹ä»¶
        window.dispatchEvent(
          new CustomEvent("historyImageSelected", {
            detail: item,
          })
        );
      }
    }

    // è®¾ç½®å½“å‰é¡¹ç›®
    setCurrentItem(id: string) {
      this.currentId = id;

      // æ£€æŸ¥galleryScrollæ˜¯å¦å­˜åœ¨
      if (!this.galleryScroll) {
        console.warn("galleryScroll not found, skipping setCurrentItem");
        return;
      }

      // æ›´æ–°UIçŠ¶æ€
      const items = this.galleryScroll.querySelectorAll(".history-item");
      items.forEach((item) => {
        const isCurrentItem = (item as HTMLElement).dataset.id === id;
        item.classList.toggle("current", isCurrentItem);

        const status = item.querySelector(".item-status");
        if (status) {
          (status as HTMLElement).style.display = isCurrentItem
            ? "block"
            : "none";
        }
      });
    }

    // æŸ¥çœ‹å›¾ç‰‡
    viewImage(imageUrl: string) {
      const modal = document.getElementById("modal-overlay");
      const fullscreenModal = document.getElementById("fullscreen-modal");
      const fullscreenImage = document.getElementById(
        "fullscreen-image"
      ) as HTMLImageElement;

      if (modal && fullscreenModal && fullscreenImage) {
        fullscreenImage.src = imageUrl;
        (modal as HTMLElement).style.display = "flex";
        (fullscreenModal as HTMLElement).style.display = "flex";
      }
    }

    // ä½¿ç”¨å›¾ç‰‡
    useImage(data: any) {
      // è§¦å‘ä½¿ç”¨å›¾ç‰‡äº‹ä»¶
      window.dispatchEvent(
        new CustomEvent("useHistoryImage", {
          detail: data,
        })
      );
    }

    // åˆ é™¤é¡¹ç›®
    deleteItem(id: string) {
      if (confirm("Are you sure you want to delete this image?")) {
        // ä»æ•°ç»„ä¸­ç§»é™¤
        this.items = this.items.filter((item) => item.id !== id);

        // ä»DOMä¸­ç§»é™¤
        if (this.galleryScroll) {
          const item = this.galleryScroll.querySelector(`[data-id="${id}"]`);
          if (item) {
            item.remove();
          }
        }

        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¡¹ç›®ï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ª
        if (this.currentId === id && this.items.length > 0) {
          this.setCurrentItem(this.items[0].id);
        }

        this.updateVisibility();

        // è§¦å‘åˆ é™¤äº‹ä»¶
        window.dispatchEvent(
          new CustomEvent("historyItemDeleted", {
            detail: { id },
          })
        );
      }
    }

    // æ˜¾ç¤ºæ›´å¤šæ“ä½œ
    showMoreActions(data: any) {
      // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæ›´å¤šæ“ä½œèœå•
      console.log("More actions for:", data);
    }

    // æ¸…ç©ºå†å²
    clearHistory() {
      if (this.items.length === 0) return;

      if (
        confirm(
          "Are you sure you want to clear all history? This action cannot be undone."
        )
      ) {
        this.items = [];
        this.currentId = null;
        if (this.galleryScroll) {
          this.galleryScroll.innerHTML = "";
        }
        this.updateVisibility();

        // è§¦å‘æ¸…ç©ºäº‹ä»¶
        window.dispatchEvent(new CustomEvent("historyCleared"));
      }
    }

    // å¯¼å‡ºå…¨éƒ¨
    exportAll() {
      if (this.items.length === 0) {
        alert("No images to export");
        return;
      }

      // è¿™é‡Œå¯ä»¥å®ç°æ‰¹é‡å¯¼å‡ºåŠŸèƒ½
      console.log("Export all images:", this.items);
      alert(`Ready to export ${this.items.length} images`);
    }

    // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
    updateVisibility() {
      if (!this.galleryScroll || !this.galleryEmpty) return;

      const hasItems = this.items.length > 0;
      this.galleryScroll.style.display = hasItems ? "flex" : "none";
      this.galleryEmpty.style.display = hasItems ? "none" : "flex";
    }

    // æ ¼å¼åŒ–æ—¶é—´
    formatTime(timestamp: number) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now.getTime() - date.getTime();

      if (diff < 60000) {
        // Within 1 minute
        return "Just now";
      } else if (diff < 3600000) {
        // Within 1 hour
        return `${Math.floor(diff / 60000)}m ago`;
      } else if (diff < 86400000) {
        // Within 1 day
        return `${Math.floor(diff / 3600000)}h ago`;
      } else {
        return date.toLocaleDateString();
      }
    }

    // è·å–å†å²æ•°æ®
    getHistory(): any[] {
      return this.items;
    }

    // è·å–å½“å‰é¡¹ç›®
    getCurrentItem(): any {
      return this.items.find((item) => item.id === this.currentId);
    }

    // åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
    toggleDisplayMode() {
      const newMode =
        this.displayMode === "thumbnail" ? "detailed" : "thumbnail";
      this.setDisplayMode(newMode);

      // è§¦å‘æ¨¡å¼åˆ‡æ¢äº‹ä»¶
      window.dispatchEvent(
        new CustomEvent("historyDisplayModeChanged", {
          detail: { mode: newMode },
        })
      );
    }
  }

  // åˆå§‹åŒ–ç»Ÿä¸€å†å²ç®¡ç†å™¨
  document.addEventListener("DOMContentLoaded", function () {
    (window as any).unifiedHistoryManager = new UnifiedHistoryManager();
  });
</script>
