---
// BananaEditor AIå›¾ç‰‡èåˆæ¨¡å—
// ä¸“ä¸ºBananaEditorè®¾è®¡çš„å›¾ç‰‡èåˆç•Œé¢ç»„ä»¶

import PromptOptimizer from "./PromptOptimizer.astro";

export interface Props {
  className?: string;
  mode?: "standalone" | "integrated";
}

const { className = "", mode = "integrated" } = Astro.props;
---

<div class={`banana-image-fusion ${className}`} id="banana-image-fusion">
  <!-- èåˆå™¨å¤´éƒ¨ -->
  <div class="fusion-header">
    <div class="header-content">
      <div class="header-icon">ğŸ”€</div>
      <div class="header-text">
        <h2 class="fusion-title">AIå›¾ç‰‡èåˆ</h2>
        <p class="fusion-subtitle">ä½¿ç”¨nano banana AIæŠ€æœ¯èåˆä¸¤å¼ å›¾ç‰‡</p>
      </div>
    </div>
  </div>

  <!-- èåˆå™¨ä¸»ä½“ -->
  <div class="fusion-body">
    <!-- åŒå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-section">
      <div class="section-header">
        <h3 class="section-title">
          <span class="title-icon">ğŸ“·</span>
          ä¸Šä¼ å›¾ç‰‡è¿›è¡Œèåˆ
        </h3>
        <span class="section-badge">å¿…éœ€</span>
      </div>

      <div class="dual-upload-container">
        <!-- ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šä¼  -->
        <div class="upload-group">
          <div class="upload-label">
            <span class="label-icon">ğŸ–¼ï¸</span>
            <span class="label-text">ä¸»å›¾ç‰‡</span>
          </div>
          <div class="upload-area" id="upload-area-1" data-target="image1">
            <div class="upload-content">
              <div class="upload-icon">ğŸ“</div>
              <h4>æ‹–æ‹½ç¬¬ä¸€å¼ å›¾ç‰‡</h4>
              <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
              <div class="upload-formats">
                <span class="format-tag">JPG</span>
                <span class="format-tag">PNG</span>
                <span class="format-tag">WebP</span>
              </div>
            </div>
            <input
              type="file"
              id="image-upload-1"
              accept="image/*"
              style="display: none;"
            />
          </div>

          <!-- ç¬¬ä¸€å¼ å›¾ç‰‡é¢„è§ˆ -->
          <div
            class="uploaded-preview"
            id="uploaded-preview-1"
            style="display: none;">
            <div class="preview-container">
              <img id="preview-image-1" alt="ä¸»å›¾ç‰‡é¢„è§ˆ" />
              <div class="preview-overlay">
                <button
                  class="preview-action"
                  id="remove-image-1"
                  title="ç§»é™¤å›¾ç‰‡">
                  <span class="icon">ğŸ—‘ï¸</span>
                </button>
                <button
                  class="preview-action"
                  id="replace-image-1"
                  title="æ›¿æ¢å›¾ç‰‡">
                  <span class="icon">ğŸ”„</span>
                </button>
              </div>
            </div>
            <div class="preview-info">
              <span class="info-item" id="image-name-1">--</span>
              <span class="info-item" id="image-size-1">--</span>
            </div>
          </div>
        </div>

        <!-- èåˆæŒ‡ç¤ºå™¨ -->
        <div class="fusion-indicator">
          <div class="fusion-arrow">
            <span class="arrow-icon">â•</span>
            <span class="arrow-text">èåˆ</span>
          </div>
        </div>

        <!-- ç¬¬äºŒå¼ å›¾ç‰‡ä¸Šä¼  -->
        <div class="upload-group">
          <div class="upload-label">
            <span class="label-icon">ğŸ¨</span>
            <span class="label-text">è¾…åŠ©å›¾ç‰‡</span>
          </div>
          <div class="upload-area" id="upload-area-2" data-target="image2">
            <div class="upload-content">
              <div class="upload-icon">ğŸ“</div>
              <h4>æ‹–æ‹½ç¬¬äºŒå¼ å›¾ç‰‡</h4>
              <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
              <div class="upload-formats">
                <span class="format-tag">JPG</span>
                <span class="format-tag">PNG</span>
                <span class="format-tag">WebP</span>
              </div>
            </div>
            <input
              type="file"
              id="image-upload-2"
              accept="image/*"
              style="display: none;"
            />
          </div>

          <!-- ç¬¬äºŒå¼ å›¾ç‰‡é¢„è§ˆ -->
          <div
            class="uploaded-preview"
            id="uploaded-preview-2"
            style="display: none;">
            <div class="preview-container">
              <img id="preview-image-2" alt="è¾…åŠ©å›¾ç‰‡é¢„è§ˆ" />
              <div class="preview-overlay">
                <button
                  class="preview-action"
                  id="remove-image-2"
                  title="ç§»é™¤å›¾ç‰‡">
                  <span class="icon">ğŸ—‘ï¸</span>
                </button>
                <button
                  class="preview-action"
                  id="replace-image-2"
                  title="æ›¿æ¢å›¾ç‰‡">
                  <span class="icon">ğŸ”„</span>
                </button>
              </div>
            </div>
            <div class="preview-info">
              <span class="info-item" id="image-name-2">--</span>
              <span class="info-item" id="image-size-2">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- å°ºå¯¸åŒ¹é…å»ºè®® -->
      <div class="size-suggestion" id="size-suggestion" style="display: none;">
        <div class="suggestion-content">
          <div class="suggestion-icon">ğŸ’¡</div>
          <div class="suggestion-text">
            <strong>å°ºå¯¸å»ºè®®ï¼š</strong>
            <span id="suggestion-message"
              >ä¸ºè·å¾—æœ€ä½³èåˆæ•ˆæœï¼Œå»ºè®®ä¸¤å¼ å›¾ç‰‡å°ºå¯¸ç›¸è¿‘</span
            >
          </div>
          <button class="auto-resize-btn" id="auto-resize-btn">
            <span class="icon">ğŸ“</span>
            è‡ªåŠ¨è°ƒæ•´
          </button>
        </div>
      </div>
    </div>

    <!-- èåˆå‚æ•°æ§åˆ¶é¢æ¿ -->
    <div class="params-section">
      <div class="section-header">
        <h3 class="section-title">
          <span class="title-icon">âš™ï¸</span>
          èåˆå‚æ•°
        </h3>
        <button class="preset-btn" id="preset-btn" title="é¢„è®¾å‚æ•°">
          <span class="icon">ğŸ¯</span>
          é¢„è®¾
        </button>
      </div>

      <div class="params-grid">
        <!-- èåˆæ¯”ä¾‹æ§åˆ¶ -->
        <div class="param-group fusion-ratio-group">
          <label for="fusion-ratio" class="param-label">
            èåˆæ¯”ä¾‹
            <span class="param-value" id="fusion-ratio-value">50% : 50%</span>
          </label>
          <div class="ratio-container">
            <div class="ratio-labels">
              <span class="ratio-label">ä¸»å›¾ç‰‡</span>
              <span class="ratio-label">è¾…åŠ©å›¾ç‰‡</span>
            </div>
            <input
              type="range"
              id="fusion-ratio"
              class="param-range ratio-range"
              min="0"
              max="100"
              value="50"
            />
            <div class="ratio-indicators">
              <div class="ratio-indicator" id="ratio-indicator-1">50%</div>
              <div class="ratio-indicator" id="ratio-indicator-2">50%</div>
            </div>
          </div>
        </div>

        <!-- èåˆæ¨¡å¼ -->
        <div class="param-group">
          <label for="blend-mode" class="param-label">èåˆæ¨¡å¼</label>
          <select id="blend-mode" class="param-select">
            <option value="normal">è‡ªç„¶èåˆ</option>
            <option value="overlay">å åŠ èåˆ</option>
            <option value="multiply">æ­£ç‰‡å åº•</option>
            <option value="screen">æ»¤è‰²èåˆ</option>
            <option value="soft-light">æŸ”å…‰èåˆ</option>
            <option value="hard-light">å¼ºå…‰èåˆ</option>
            <option value="color-dodge">é¢œè‰²å‡æ·¡</option>
            <option value="color-burn">é¢œè‰²åŠ æ·±</option>
          </select>
        </div>

        <!-- èåˆå¼ºåº¦ -->
        <div class="param-group">
          <label for="fusion-intensity" class="param-label">
            èåˆå¼ºåº¦
            <span class="param-value" id="fusion-intensity-value">70%</span>
          </label>
          <div class="range-container">
            <input
              type="range"
              id="fusion-intensity"
              class="param-range"
              min="0"
              max="100"
              value="70"
            />
            <div class="range-labels">
              <span>è½»å¾®</span>
              <span>é€‚ä¸­</span>
              <span>å¼ºçƒˆ</span>
            </div>
          </div>
        </div>

        <!-- è¾¹ç¼˜å¤„ç† -->
        <div class="param-group">
          <label for="edge-processing" class="param-label">è¾¹ç¼˜å¤„ç†</label>
          <select id="edge-processing" class="param-select">
            <option value="smooth">å¹³æ»‘è¿‡æ¸¡</option>
            <option value="sharp">é”åˆ©è¾¹ç¼˜</option>
            <option value="feather">ç¾½åŒ–è¾¹ç¼˜</option>
            <option value="gradient">æ¸å˜è¿‡æ¸¡</option>
          </select>
        </div>

        <!-- è‰²å½©è°ƒå’Œ -->
        <div class="param-group">
          <label for="color-harmony" class="param-label">
            è‰²å½©è°ƒå’Œ
            <span class="param-value" id="color-harmony-value">50%</span>
          </label>
          <div class="range-container">
            <input
              type="range"
              id="color-harmony"
              class="param-range"
              min="0"
              max="100"
              value="50"
            />
            <div class="range-labels">
              <span>ä¿æŒåŸè‰²</span>
              <span>è‡ªç„¶è°ƒå’Œ</span>
              <span>å®Œå…¨èåˆ</span>
            </div>
          </div>
        </div>

        <!-- è¾“å‡ºè´¨é‡ -->
        <div class="param-group">
          <label for="output-quality" class="param-label">è¾“å‡ºè´¨é‡</label>
          <select id="output-quality" class="param-select">
            <option value="standard">æ ‡å‡†è´¨é‡</option>
            <option value="high">é«˜è´¨é‡</option>
            <option value="ultra">è¶…é«˜è´¨é‡</option>
          </select>
        </div>
      </div>

      <!-- é¢„è®¾å‚æ•°é¢æ¿ -->
      <div class="preset-panel" id="preset-panel" style="display: none;">
        <div class="preset-header">
          <h4 class="preset-title">èåˆé¢„è®¾</h4>
          <button class="close-preset-btn" id="close-preset-btn">âœ•</button>
        </div>
        <div class="preset-grid">
          <button class="preset-item" data-preset="artistic">
            <div class="preset-icon">ğŸ¨</div>
            <div class="preset-name">è‰ºæœ¯èåˆ</div>
            <div class="preset-desc">é€‚åˆåˆ›æ„è‰ºæœ¯ä½œå“</div>
          </button>
          <button class="preset-item" data-preset="portrait">
            <div class="preset-icon">ğŸ‘¤</div>
            <div class="preset-name">äººåƒèåˆ</div>
            <div class="preset-desc">ä¸“ä¸ºäººåƒç…§ç‰‡ä¼˜åŒ–</div>
          </button>
          <button class="preset-item" data-preset="landscape">
            <div class="preset-icon">ğŸï¸</div>
            <div class="preset-name">é£æ™¯èåˆ</div>
            <div class="preset-desc">é€‚åˆé£æ™¯ç…§ç‰‡</div>
          </button>
          <button class="preset-item" data-preset="abstract">
            <div class="preset-icon">ğŸŒ€</div>
            <div class="preset-name">æŠ½è±¡èåˆ</div>
            <div class="preset-desc">åˆ›é€ æŠ½è±¡è‰ºæœ¯æ•ˆæœ</div>
          </button>
          <button class="preset-item" data-preset="vintage">
            <div class="preset-icon">ğŸ“·</div>
            <div class="preset-name">å¤å¤èåˆ</div>
            <div class="preset-desc">è¥é€ æ€€æ—§å¤å¤æ„Ÿ</div>
          </button>
          <button class="preset-item" data-preset="modern">
            <div class="preset-icon">âœ¨</div>
            <div class="preset-name">ç°ä»£èåˆ</div>
            <div class="preset-desc">æ—¶å°šç°ä»£é£æ ¼</div>
          </button>
        </div>
      </div>
    </div>

    <!-- èåˆæç¤ºè¯åŒºåŸŸ -->
    <div class="fusion-prompt-section">
      <div class="section-header">
        <h3 class="section-title">
          <span class="title-icon">âœ¨</span>
          èåˆæç¤ºè¯
        </h3>
        <PromptOptimizer className="fusion-optimizer" />
      </div>

      <div class="prompt-input-container">
        <textarea
          id="fusion-prompt-textarea"
          class="prompt-textarea"
          placeholder="æè¿°æ‚¨å¸Œæœ›çš„èåˆæ•ˆæœï¼Œä¾‹å¦‚ï¼šå°†ä¸¤å¼ å›¾ç‰‡è‡ªç„¶èåˆï¼Œä¿æŒä¸»å›¾çš„æ„å›¾ï¼Œèå…¥è¾…åŠ©å›¾çš„è‰²å½©å’Œçº¹ç†ï¼Œè¥é€ æ¢¦å¹»çš„è‰ºæœ¯æ•ˆæœ..."
          rows="3"></textarea>
        <div class="prompt-counter">
          <span id="fusion-char-count">0</span> / 1000
        </div>
      </div>

      <!-- èåˆæç¤ºè¯å»ºè®® -->
      <div class="fusion-suggestions">
        <div class="suggestions-header">
          <span class="suggestions-title">èåˆå»ºè®®ï¼š</span>
        </div>
        <div class="suggestions-grid">
          <button class="suggestion-tag" data-prompt="è‡ªç„¶è¿‡æ¸¡ï¼Œæ— ç¼èåˆ">
            <span class="tag-icon">ğŸŒŠ</span>
            è‡ªç„¶è¿‡æ¸¡
          </button>
          <button
            class="suggestion-tag"
            data-prompt="ä¿æŒä¸»å›¾æ„å›¾ï¼Œèå…¥è¾…åŠ©å›¾è‰²å½©">
            <span class="tag-icon">ğŸ¨</span>
            è‰²å½©èåˆ
          </button>
          <button class="suggestion-tag" data-prompt="çº¹ç†å åŠ ï¼Œå¢å¼ºç»†èŠ‚">
            <span class="tag-icon">ğŸ”</span>
            çº¹ç†èåˆ
          </button>
          <button class="suggestion-tag" data-prompt="æ¢¦å¹»æ•ˆæœï¼Œè‰ºæœ¯é£æ ¼">
            <span class="tag-icon">âœ¨</span>
            è‰ºæœ¯æ•ˆæœ
          </button>
          <button class="suggestion-tag" data-prompt="ä¿æŒçœŸå®æ„Ÿï¼Œè‡ªç„¶èåˆ">
            <span class="tag-icon">ğŸ“·</span>
            çœŸå®æ„Ÿ
          </button>
          <button class="suggestion-tag" data-prompt="åˆ›æ„æ··åˆï¼Œç‹¬ç‰¹è§†è§‰">
            <span class="tag-icon">ğŸ­</span>
            åˆ›æ„æ··åˆ
          </button>
        </div>
      </div>
    </div>

    <!-- å®æ—¶é¢„è§ˆåŒºåŸŸ -->
    <div class="preview-section" id="preview-section" style="display: none;">
      <div class="section-header">
        <h3 class="section-title">
          <span class="title-icon">ğŸ‘ï¸</span>
          å®æ—¶é¢„è§ˆ
        </h3>
        <div class="preview-controls">
          <button
            class="preview-control-btn"
            id="toggle-preview"
            title="å¼€å¯/å…³é—­é¢„è§ˆ">
            <span class="icon">ğŸ‘ï¸</span>
          </button>
          <button
            class="preview-control-btn"
            id="fullscreen-preview"
            title="å…¨å±é¢„è§ˆ">
            <span class="icon">ğŸ”</span>
          </button>
        </div>
      </div>

      <div class="preview-container">
        <div class="preview-canvas-container">
          <canvas id="preview-canvas" class="preview-canvas"></canvas>
          <div
            class="preview-loading"
            id="preview-loading"
            style="display: none;">
            <div class="loading-spinner"></div>
            <span class="loading-text">ç”Ÿæˆé¢„è§ˆä¸­...</span>
          </div>
        </div>

        <div class="preview-info-panel">
          <div class="info-item">
            <span class="info-label">é¢„è§ˆå°ºå¯¸ï¼š</span>
            <span class="info-value" id="preview-dimensions">--</span>
          </div>
          <div class="info-item">
            <span class="info-label">èåˆæ¨¡å¼ï¼š</span>
            <span class="info-value" id="preview-mode">--</span>
          </div>
          <div class="info-item">
            <span class="info-label">å¤„ç†æ—¶é—´ï¼š</span>
            <span class="info-value" id="preview-time">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- èåˆæŒ‰é’®åŒºåŸŸ -->
    <div class="fusion-section">
      <div class="fusion-actions">
        <button class="preview-fusion-btn" id="preview-fusion-btn" disabled>
          <span class="btn-icon">ğŸ‘ï¸</span>
          <span class="btn-text">é¢„è§ˆèåˆ</span>
        </button>
        <button class="start-fusion-btn" id="start-fusion-btn" disabled>
          <span class="btn-icon">ğŸ”€</span>
          <span class="btn-text">å¼€å§‹èåˆ</span>
          <div class="btn-loading" style="display: none;">
            <div class="loading-spinner"></div>
          </div>
        </button>
      </div>
      <p class="fusion-tip" id="fusion-tip">è¯·ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡å¼€å§‹èåˆ</p>
    </div>
  </div>

  <!-- èåˆè¿›åº¦æ˜¾ç¤º -->
  <div class="progress-section" id="progress-section" style="display: none;">
    <div class="progress-header">
      <h4 class="progress-title">AIæ­£åœ¨èåˆå›¾ç‰‡...</h4>
      <button class="cancel-btn" id="cancel-fusion">å–æ¶ˆ</button>
    </div>

    <div class="progress-steps">
      <div class="step" data-step="prepare">
        <div class="step-icon">ğŸ“‹</div>
        <div class="step-content">
          <div class="step-title">å‡†å¤‡å›¾ç‰‡</div>
          <div class="step-description">æ­£åœ¨å¤„ç†å’Œå¯¹é½å›¾ç‰‡</div>
        </div>
      </div>

      <div class="step" data-step="analyze">
        <div class="step-icon">ğŸ”</div>
        <div class="step-content">
          <div class="step-title">åˆ†æç‰¹å¾</div>
          <div class="step-description">AIæ­£åœ¨åˆ†æå›¾ç‰‡ç‰¹å¾</div>
        </div>
      </div>

      <div class="step" data-step="blend">
        <div class="step-icon">ğŸ”€</div>
        <div class="step-content">
          <div class="step-title">æ‰§è¡Œèåˆ</div>
          <div class="step-description">AIæ­£åœ¨èåˆä¸¤å¼ å›¾ç‰‡</div>
        </div>
      </div>

      <div class="step" data-step="optimize">
        <div class="step-icon">âœ¨</div>
        <div class="step-content">
          <div class="step-title">ä¼˜åŒ–ç»“æœ</div>
          <div class="step-description">æ­£åœ¨ä¼˜åŒ–èåˆæ•ˆæœ</div>
        </div>
      </div>
    </div>

    <div class="progress-bar-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <span class="progress-percentage" id="progress-percentage">0%</span>
    </div>

    <div class="progress-details">
      <div class="detail-item">
        <span class="detail-label">å½“å‰æ­¥éª¤ï¼š</span>
        <span class="detail-value" id="current-step">å‡†å¤‡ä¸­...</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">é¢„è®¡æ—¶é—´ï¼š</span>
        <span class="detail-value" id="estimated-time">è®¡ç®—ä¸­...</span>
      </div>
    </div>
  </div>

  <!-- é”™è¯¯æç¤º -->
  <div class="error-section" id="error-section" style="display: none;">
    <div class="error-content">
      <div class="error-icon">âš ï¸</div>
      <h4 class="error-title">èåˆå¤±è´¥</h4>
      <p class="error-message" id="error-message">
        è¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼å’Œç½‘ç»œè¿æ¥åé‡è¯•
      </p>
      <div class="error-actions">
        <button class="retry-btn" id="retry-fusion">é‡è¯•</button>
        <button class="close-error-btn" id="close-error">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* BananaEditorå›¾ç‰‡èåˆå™¨æ ·å¼ */
  .banana-image-fusion {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1);
  }

  /* èåˆå™¨å¤´éƒ¨ */
  .fusion-header {
    background: var(
      --banana-gradient,
      linear-gradient(135deg, #ffd700 0%, #ffa500 100%)
    );
    padding: 20px;
    border-bottom: 2px solid var(--banana-border, #ffe55c);
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .header-icon {
    font-size: 32px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .header-text {
    flex: 1;
  }

  .fusion-title {
    margin: 0 0 4px 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--banana-dark, #2d1810);
  }

  .fusion-subtitle {
    margin: 0;
    font-size: 14px;
    color: var(--banana-dark, #2d1810);
    opacity: 0.8;
  }

  /* èåˆå™¨ä¸»ä½“ */
  .fusion-body {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* é€šç”¨åŒºåŸŸæ ·å¼ */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .title-icon {
    font-size: 20px;
  }

  .section-badge {
    padding: 4px 8px;
    background: rgba(255, 107, 53, 0.2);
    color: var(--banana-dark, #2d1810);
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }

  /* åŒå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
  .dual-upload-container {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 20px;
    align-items: start;
  }

  .upload-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .upload-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .label-icon {
    font-size: 16px;
  }

  .upload-area {
    border: 2px dashed #ddd;
    border-radius: 12px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fafafa;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .upload-area:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 248, 220, 0.5);
  }

  .upload-area.drag-over {
    border-color: var(--banana-accent, #ff6b35);
    background: rgba(255, 215, 0, 0.1);
    transform: scale(1.02);
  }

  .upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .upload-icon {
    font-size: 36px;
    opacity: 0.6;
  }

  .upload-content h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .upload-content p {
    margin: 0;
    color: #666;
    font-size: 12px;
  }

  .upload-formats {
    display: flex;
    gap: 6px;
    margin-top: 6px;
  }

  .format-tag {
    padding: 3px 6px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 500;
    color: #666;
  }

  /* èåˆæŒ‡ç¤ºå™¨ */
  .fusion-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px 0;
  }

  .fusion-arrow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 50%;
    border: 2px solid var(--banana-primary, #ffd700);
  }

  .arrow-icon {
    font-size: 24px;
    color: var(--banana-accent, #ff6b35);
  }

  .arrow-text {
    font-size: 12px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  /* ä¸Šä¼ é¢„è§ˆ */
  .uploaded-preview {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .preview-container {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    max-height: 200px;
  }

  .preview-container img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }

  .preview-overlay {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .preview-container:hover .preview-overlay {
    opacity: 1;
  }

  .preview-action {
    width: 28px;
    height: 28px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 12px;
  }

  .preview-action:hover {
    background: rgba(0, 0, 0, 0.9);
    transform: scale(1.1);
  }

  .preview-info {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #666;
  }

  /* å°ºå¯¸åŒ¹é…å»ºè®® */
  .size-suggestion {
    margin-top: 16px;
    padding: 12px;
    background: rgba(59, 130, 246, 0.05);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
  }

  .suggestion-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .suggestion-icon {
    font-size: 20px;
  }

  .suggestion-text {
    flex: 1;
    font-size: 13px;
    color: #374151;
  }

  .auto-resize-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border: 1px solid #3b82f6;
    background: white;
    color: #3b82f6;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .auto-resize-btn:hover {
    background: #3b82f6;
    color: white;
  }

  /* å‚æ•°æ§åˆ¶åŒºåŸŸ */
  .preset-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: 1px solid var(--banana-primary, #ffd700);
    background: transparent;
    color: var(--banana-dark, #2d1810);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .preset-btn:hover {
    background: var(--banana-primary, #ffd700);
  }

  .params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .param-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .param-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
  }

  .param-value {
    font-size: 12px;
    color: #666;
    font-weight: 400;
  }

  .param-select {
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .param-select:focus {
    outline: none;
    border-color: var(--banana-primary, #ffd700);
    box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
  }

  /* èåˆæ¯”ä¾‹æ§åˆ¶ */
  .fusion-ratio-group {
    grid-column: 1 / -1;
  }

  .ratio-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .ratio-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
  }

  .ratio-range {
    width: 100%;
    height: 8px;
    background: linear-gradient(to right, #3b82f6 0%, #ef4444 100%);
    border-radius: 4px;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
  }

  .ratio-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    background: white;
    border: 3px solid var(--banana-primary, #ffd700);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .ratio-range::-moz-range-thumb {
    width: 24px;
    height: 24px;
    background: white;
    border: 3px solid var(--banana-primary, #ffd700);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .ratio-indicators {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    font-weight: 600;
  }

  .ratio-indicator {
    padding: 4px 8px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 4px;
    color: var(--banana-dark, #2d1810);
  }

  .range-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .param-range {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
  }

  .param-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--banana-primary, #ffd700);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .param-range::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--banana-primary, #ffd700);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
  }

  /* é¢„è®¾é¢æ¿ */
  .preset-panel {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
    margin-top: 8px;
    padding: 16px;
  }

  .preset-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .preset-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .close-preset-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: #f3f4f6;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .close-preset-btn:hover {
    background: #e5e7eb;
  }

  .preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }

  .preset-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .preset-item:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 248, 220, 0.5);
    transform: translateY(-2px);
  }

  .preset-icon {
    font-size: 24px;
  }

  .preset-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .preset-desc {
    font-size: 10px;
    color: #666;
    line-height: 1.3;
  }

  /* å®æ—¶é¢„è§ˆåŒºåŸŸ */
  .preview-controls {
    display: flex;
    gap: 8px;
  }

  .preview-control-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #e5e7eb;
    background: white;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .preview-control-btn:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 248, 220, 0.5);
  }

  .preview-container {
    display: flex;
    gap: 16px;
  }

  .preview-canvas-container {
    flex: 1;
    position: relative;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-canvas {
    max-width: 100%;
    max-height: 100%;
    border-radius: 4px;
  }

  .preview-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid var(--banana-primary, #ffd700);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .loading-text {
    font-size: 14px;
    color: #666;
  }

  .preview-info-panel {
    width: 200px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .info-label {
    font-size: 12px;
    font-weight: 500;
    color: #666;
  }

  .info-value {
    font-size: 14px;
    color: var(--banana-dark, #2d1810);
  }

  /* èåˆæŒ‰é’®åŒºåŸŸ */
  .fusion-actions {
    display: flex;
    gap: 12px;
  }

  .preview-fusion-btn,
  .start-fusion-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .preview-fusion-btn {
    background: white;
    border: 2px solid var(--banana-primary, #ffd700);
    color: var(--banana-dark, #2d1810);
  }

  .preview-fusion-btn:hover:not(:disabled) {
    background: rgba(255, 248, 220, 0.5);
    transform: translateY(-1px);
  }

  .start-fusion-btn {
    background: var(
      --banana-gradient,
      linear-gradient(135deg, #ffd700 0%, #ffa500 100%)
    );
    color: var(--banana-dark, #2d1810);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .start-fusion-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
  }

  .preview-fusion-btn:disabled,
  .start-fusion-btn:disabled {
    background: #e5e7eb;
    color: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    border-color: #e5e7eb;
  }

  .btn-icon {
    font-size: 16px;
    transition: transform 0.3s ease;
  }

  .start-fusion-btn:hover:not(:disabled) .btn-icon {
    transform: scale(1.2);
  }

  .btn-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .fusion-tip {
    text-align: center;
    margin: 12px 0 0 0;
    font-size: 14px;
    color: #666;
  }

  /* è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ */
  .progress-section {
    padding: 24px;
    background: rgba(255, 248, 220, 0.3);
    border-top: 1px solid var(--banana-border, #ffe55c);
  }

  .progress-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .progress-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .cancel-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    background: white;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
  }

  .cancel-btn:hover {
    border-color: #999;
    color: #333;
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 16px;
  }

  .step {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0.3;
    transition: opacity 0.3s ease;
  }

  .step.active {
    opacity: 1;
  }

  .step.completed {
    opacity: 0.7;
  }

  .step-icon {
    width: 40px;
    height: 40px;
    background: #f0f0f0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.3s ease;
  }

  .step.active .step-icon {
    background: var(--banana-primary, #ffd700);
    transform: scale(1.1);
  }

  .step.completed .step-icon {
    background: #10b981;
  }

  .step-content {
    text-align: center;
  }

  .step-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
    margin-bottom: 2px;
  }

  .step-description {
    font-size: 10px;
    color: #666;
  }

  .progress-bar-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .progress-bar {
    flex: 1;
    height: 8px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(
      --banana-gradient,
      linear-gradient(135deg, #ffd700 0%, #ffa500 100%)
    );
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-percentage {
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
    min-width: 40px;
  }

  .progress-details {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
  }

  .detail-item {
    display: flex;
    gap: 4px;
  }

  .detail-label {
    font-weight: 500;
  }

  /* é”™è¯¯æç¤ºåŒºåŸŸ */
  .error-section {
    padding: 24px;
    background: rgba(239, 68, 68, 0.05);
    border-top: 1px solid rgba(239, 68, 68, 0.2);
  }

  .error-content {
    text-align: center;
    max-width: 400px;
    margin: 0 auto;
  }

  .error-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .error-title {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 600;
    color: #dc2626;
  }

  .error-message {
    margin: 0 0 20px 0;
    color: #666;
    font-size: 14px;
    line-height: 1.5;
  }

  .error-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .retry-btn {
    padding: 10px 20px;
    border: none;
    background: #dc2626;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s ease;
  }

  .retry-btn:hover {
    background: #b91c1c;
  }

  .close-error-btn {
    padding: 10px 20px;
    border: 1px solid #ddd;
    background: white;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .close-error-btn:hover {
    border-color: #999;
    color: #333;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1024px) {
    .dual-upload-container {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .fusion-indicator {
      order: 2;
      padding: 12px 0;
    }

    .fusion-arrow {
      padding: 12px;
    }

    .arrow-icon {
      transform: rotate(90deg);
    }

    .params-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .preview-container {
      flex-direction: column;
    }

    .preview-info-panel {
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
    }
  }

  @media (max-width: 768px) {
    .fusion-header {
      padding: 16px;
    }

    .fusion-title {
      font-size: 20px;
    }

    .fusion-body {
      padding: 16px;
      gap: 20px;
    }

    .section-title {
      font-size: 16px;
    }

    .upload-area {
      padding: 20px 12px;
      min-height: 160px;
    }

    .upload-icon {
      font-size: 28px;
    }

    .params-grid {
      grid-template-columns: 1fr;
    }

    .fusion-actions {
      flex-direction: column;
    }

    .progress-steps {
      flex-direction: column;
      gap: 12px;
    }

    .step {
      flex-direction: row;
      text-align: left;
    }

    .step-content {
      text-align: left;
    }

    .progress-details {
      flex-direction: column;
      gap: 8px;
    }

    .preset-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .upload-content h4 {
      font-size: 14px;
    }

    .upload-content p {
      font-size: 11px;
    }

    .fusion-actions button {
      padding: 12px 16px;
      font-size: 13px;
    }

    .preset-grid {
      grid-template-columns: 1fr;
    }
  }

  /* åŠ¨ç”» */
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
  @media (prefers-contrast: high) {
    .upload-area {
      border-color: #000;
    }

    .param-select {
      border-color: #000;
    }

    .preset-item {
      border-color: #000;
    }
  }

  /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
  @media (prefers-reduced-motion: reduce) {
    * {
      transition: none !important;
      animation: none !important;
    }
  }

  /* ç›¸å¯¹å®šä½å®¹å™¨ç”¨äºé¢„è®¾é¢æ¿ */
  .params-section {
    position: relative;
  }

  /* èåˆæç¤ºè¯åŒºåŸŸæ ·å¼ */
  .fusion-prompt-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: 24px;
  }

  .fusion-prompt-section .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .fusion-prompt-section .prompt-input-container {
    position: relative;
  }

  .fusion-prompt-section .prompt-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
    transition: border-color 0.2s ease;
  }

  .fusion-prompt-section .prompt-textarea:focus {
    outline: none;
    border-color: var(--banana-primary, #ffd700);
    box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
  }

  .fusion-prompt-section .prompt-counter {
    position: absolute;
    bottom: 8px;
    right: 12px;
    font-size: 12px;
    color: #666;
    background: white;
    padding: 2px 6px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .fusion-suggestions {
    margin-top: 12px;
  }

  .fusion-suggestions .suggestions-header {
    margin-bottom: 8px;
  }

  .fusion-suggestions .suggestions-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
  }

  .fusion-suggestions .suggestions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
  }

  .fusion-suggestions .suggestion-tag {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
    transition: all 0.2s ease;
  }

  .fusion-suggestions .suggestion-tag:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 248, 220, 0.5);
    transform: translateY(-1px);
  }

  .fusion-suggestions .suggestion-tag:active {
    background: var(--banana-primary, #ffd700);
    transform: translateY(0);
  }

  .fusion-suggestions .tag-icon {
    font-size: 14px;
  }
</style>
<script>
  // BananaEditorå›¾ç‰‡èåˆå™¨äº¤äº’é€»è¾‘
  class BananaImageFusion {
    private uploadAreas: NodeListOf<HTMLElement> | null = null;
    private fileInputs: NodeListOf<HTMLInputElement> | null = null;
    private uploadedPreviews: NodeListOf<HTMLElement> | null = null;
    private fusionRatioRange: HTMLInputElement | null = null;
    private previewFusionBtn: HTMLButtonElement | null = null;
    private startFusionBtn: HTMLButtonElement | null = null;
    private progressSection: HTMLElement | null = null;
    private errorSection: HTMLElement | null = null;
    private previewSection: HTMLElement | null = null;
    private previewCanvas: HTMLCanvasElement | null = null;

    private fusionPromptTextarea: HTMLTextAreaElement | null = null;

    private uploadedFiles: { image1: File | null; image2: File | null } = {
      image1: null,
      image2: null,
    };
    private fusionParams = {
      ratio: 50,
      blendMode: "normal",
      intensity: 70,
      edgeProcessing: "smooth",
      colorHarmony: 50,
      outputQuality: "standard",
    };
    private fusionPrompt: string = "";
    private isFusing: boolean = false;
    private fusionProgress: number = 0;
    private previewEnabled: boolean = false;

    constructor() {
      this.init();
    }

    private init(): void {
      this.bindElements();
      this.setupEventListeners();
      this.updateFusionButtons();
    }

    private bindElements(): void {
      this.uploadAreas = document.querySelectorAll(".upload-area");
      this.fileInputs = document.querySelectorAll('input[type="file"]');
      this.uploadedPreviews = document.querySelectorAll(".uploaded-preview");
      this.fusionRatioRange = document.getElementById(
        "fusion-ratio",
      ) as HTMLInputElement;
      this.previewFusionBtn = document.getElementById(
        "preview-fusion-btn",
      ) as HTMLButtonElement;
      this.startFusionBtn = document.getElementById(
        "start-fusion-btn",
      ) as HTMLButtonElement;
      this.progressSection = document.getElementById("progress-section");
      this.errorSection = document.getElementById("error-section");
      this.previewSection = document.getElementById("preview-section");
      this.previewCanvas = document.getElementById(
        "preview-canvas",
      ) as HTMLCanvasElement;
      this.fusionPromptTextarea = document.getElementById(
        "fusion-prompt-textarea",
      ) as HTMLTextAreaElement;
    }

    private setupEventListeners(): void {
      // æ–‡ä»¶ä¸Šä¼ ç›¸å…³äº‹ä»¶
      this.setupFileUpload();

      // å‚æ•°æ§åˆ¶äº‹ä»¶
      this.setupParameterControls();

      // èåˆæŒ‰é’®äº‹ä»¶
      this.previewFusionBtn?.addEventListener("click", () => {
        if (!this.isFusing) {
          this.startPreviewFusion();
        }
      });

      this.startFusionBtn?.addEventListener("click", () => {
        if (!this.isFusing) {
          this.startFusion();
        }
      });

      // é¢„è®¾é¢æ¿äº‹ä»¶
      this.setupPresetPanel();

      // å…¶ä»–æ§åˆ¶æŒ‰é’®
      this.setupControlButtons();

      // èåˆæç¤ºè¯äº‹ä»¶
      this.setupFusionPrompt();
    }

    private setupFileUpload(): void {
      // ä¸ºæ¯ä¸ªä¸Šä¼ åŒºåŸŸè®¾ç½®äº‹ä»¶
      this.uploadAreas?.forEach((area, index) => {
        const target = area.dataset.target as "image1" | "image2";
        const fileInput = document.getElementById(
          `image-upload-${index + 1}`,
        ) as HTMLInputElement;

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        area.addEventListener("click", () => {
          fileInput?.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput?.addEventListener("change", (e) => {
          const target = e.target as HTMLInputElement;
          if (target.files && target.files.length > 0) {
            this.handleFileUpload(target.files[0], index + 1);
          }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        this.setupDragAndDrop(area, index + 1);
      });
    }

    private setupDragAndDrop(
      uploadArea: HTMLElement,
      imageIndex: number,
    ): void {
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      uploadArea.addEventListener("dragenter", () => {
        uploadArea.classList.add("drag-over");
      });

      uploadArea.addEventListener("dragover", () => {
        uploadArea.classList.add("drag-over");
      });

      uploadArea.addEventListener("dragleave", (e) => {
        if (!uploadArea.contains(e.relatedTarget as Node)) {
          uploadArea.classList.remove("drag-over");
        }
      });

      uploadArea.addEventListener("drop", (e) => {
        uploadArea.classList.remove("drag-over");
        const files = e.dataTransfer?.files;
        if (files && files.length > 0) {
          this.handleFileUpload(files[0], imageIndex);
        }
      });
    }

    private handleFileUpload(file: File, imageIndex: number): void {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith("image/")) {
        this.showError("è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶");
        return;
      }

      // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
      if (file.size > 10 * 1024 * 1024) {
        this.showError("å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB");
        return;
      }

      const imageKey = `image${imageIndex}` as "image1" | "image2";
      this.uploadedFiles[imageKey] = file;
      this.showUploadedPreview(file, imageIndex);
      this.updateFusionButtons();
      this.checkSizeCompatibility();
    }
    private showUploadedPreview(file: File, imageIndex: number): void {
      const uploadArea = document.getElementById(`upload-area-${imageIndex}`);
      const uploadedPreview = document.getElementById(
        `uploaded-preview-${imageIndex}`,
      );
      const previewImage = document.getElementById(
        `preview-image-${imageIndex}`,
      ) as HTMLImageElement;
      const imageName = document.getElementById(`image-name-${imageIndex}`);
      const imageSize = document.getElementById(`image-size-${imageIndex}`);

      if (!uploadedPreview || !previewImage) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        if (e.target?.result) {
          previewImage.src = e.target.result as string;
        }

        if (imageName) {
          imageName.textContent = file.name;
        }

        if (imageSize) {
          const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
          imageSize.textContent = `${sizeInMB} MB`;
        }

        // éšè—ä¸Šä¼ åŒºåŸŸï¼Œæ˜¾ç¤ºé¢„è§ˆ
        if (uploadArea) {
          uploadArea.style.display = "none";
        }
        uploadedPreview.style.display = "block";
      };

      reader.readAsDataURL(file);
    }

    private checkSizeCompatibility(): void {
      const { image1, image2 } = this.uploadedFiles;
      const sizeSuggestion = document.getElementById("size-suggestion");

      if (!image1 || !image2 || !sizeSuggestion) return;

      // åˆ›å»ºä¸´æ—¶å›¾ç‰‡å…ƒç´ æ¥è·å–å°ºå¯¸
      const img1 = new Image();
      const img2 = new Image();
      let loadedCount = 0;

      const checkSizes = () => {
        loadedCount++;
        if (loadedCount === 2) {
          const ratio1 = img1.width / img1.height;
          const ratio2 = img2.width / img2.height;
          const sizeDiff = Math.abs(ratio1 - ratio2);

          if (sizeDiff > 0.3) {
            const suggestionMessage =
              document.getElementById("suggestion-message");
            if (suggestionMessage) {
              suggestionMessage.textContent = `å›¾ç‰‡å°ºå¯¸æ¯”ä¾‹å·®å¼‚è¾ƒå¤§ï¼ˆ${img1.width}x${img1.height} vs ${img2.width}x${img2.height}ï¼‰ï¼Œå»ºè®®è°ƒæ•´ä»¥è·å¾—æ›´å¥½çš„èåˆæ•ˆæœ`;
            }
            sizeSuggestion.style.display = "block";
          } else {
            sizeSuggestion.style.display = "none";
          }
        }
      };

      img1.onload = checkSizes;
      img2.onload = checkSizes;
      img1.src = URL.createObjectURL(image1);
      img2.src = URL.createObjectURL(image2);
    }

    private setupParameterControls(): void {
      // èåˆæ¯”ä¾‹æ§åˆ¶
      this.fusionRatioRange?.addEventListener("input", (e) => {
        const target = e.target as HTMLInputElement;
        const ratio = parseInt(target.value);
        this.fusionParams.ratio = ratio;
        this.updateRatioDisplay(ratio);

        if (this.previewEnabled) {
          this.updatePreview();
        }
      });

      // å…¶ä»–å‚æ•°æ§åˆ¶
      const paramControls = [
        "blend-mode",
        "fusion-intensity",
        "edge-processing",
        "color-harmony",
        "output-quality",
      ];

      paramControls.forEach((paramId) => {
        const element = document.getElementById(paramId) as
          | HTMLInputElement
          | HTMLSelectElement;
        element?.addEventListener("change", (e) => {
          const target = e.target as HTMLInputElement | HTMLSelectElement;
          const paramKey = paramId.replace(
            "-",
            "",
          ) as keyof typeof this.fusionParams;

          if (target.type === "range") {
            this.fusionParams[paramKey] = parseInt(target.value) as any;
            this.updateParamDisplay(paramId, target.value);
          } else {
            this.fusionParams[paramKey] = target.value as any;
          }

          if (this.previewEnabled) {
            this.updatePreview();
          }
        });
      });
    }
    private updateRatioDisplay(ratio: number): void {
      const ratioValue = document.getElementById("fusion-ratio-value");
      const indicator1 = document.getElementById("ratio-indicator-1");
      const indicator2 = document.getElementById("ratio-indicator-2");

      if (ratioValue) {
        ratioValue.textContent = `${ratio}% : ${100 - ratio}%`;
      }

      if (indicator1) {
        indicator1.textContent = `${ratio}%`;
      }

      if (indicator2) {
        indicator2.textContent = `${100 - ratio}%`;
      }
    }

    private updateParamDisplay(paramId: string, value: string): void {
      const valueDisplay = document.getElementById(`${paramId}-value`);
      if (valueDisplay) {
        valueDisplay.textContent = `${value}%`;
      }
    }

    private setupPresetPanel(): void {
      const presetBtn = document.getElementById("preset-btn");
      const presetPanel = document.getElementById("preset-panel");
      const closePresetBtn = document.getElementById("close-preset-btn");

      presetBtn?.addEventListener("click", () => {
        if (presetPanel) {
          presetPanel.style.display =
            presetPanel.style.display === "block" ? "none" : "block";
        }
      });

      closePresetBtn?.addEventListener("click", () => {
        if (presetPanel) {
          presetPanel.style.display = "none";
        }
      });

      // é¢„è®¾é€‰é¡¹
      const presetItems = document.querySelectorAll(".preset-item");
      presetItems.forEach((item) => {
        item.addEventListener("click", () => {
          const preset = (item as HTMLElement).dataset.preset;
          if (preset) {
            this.applyPreset(preset);
            if (presetPanel) {
              presetPanel.style.display = "none";
            }
          }
        });
      });
    }

    private applyPreset(presetName: string): void {
      const presets = {
        artistic: {
          ratio: 60,
          blendMode: "overlay",
          intensity: 80,
          edgeProcessing: "feather",
          colorHarmony: 70,
        },
        portrait: {
          ratio: 45,
          blendMode: "soft-light",
          intensity: 60,
          edgeProcessing: "smooth",
          colorHarmony: 40,
        },
        landscape: {
          ratio: 55,
          blendMode: "normal",
          intensity: 65,
          edgeProcessing: "gradient",
          colorHarmony: 60,
        },
        abstract: {
          ratio: 70,
          blendMode: "hard-light",
          intensity: 90,
          edgeProcessing: "sharp",
          colorHarmony: 80,
        },
        vintage: {
          ratio: 40,
          blendMode: "multiply",
          intensity: 50,
          edgeProcessing: "feather",
          colorHarmony: 30,
        },
        modern: {
          ratio: 50,
          blendMode: "screen",
          intensity: 75,
          edgeProcessing: "smooth",
          colorHarmony: 65,
        },
      };

      const preset = presets[presetName as keyof typeof presets];
      if (preset) {
        // æ›´æ–°å‚æ•°
        Object.assign(this.fusionParams, preset);

        // æ›´æ–°UI
        this.updateUIFromParams();

        if (this.previewEnabled) {
          this.updatePreview();
        }
      }
    }

    private updateUIFromParams(): void {
      // æ›´æ–°èåˆæ¯”ä¾‹
      if (this.fusionRatioRange) {
        this.fusionRatioRange.value = this.fusionParams.ratio.toString();
        this.updateRatioDisplay(this.fusionParams.ratio);
      }

      // æ›´æ–°å…¶ä»–å‚æ•°
      const paramMappings = {
        "blend-mode": "blendMode",
        "fusion-intensity": "intensity",
        "edge-processing": "edgeProcessing",
        "color-harmony": "colorHarmony",
        "output-quality": "outputQuality",
      };

      Object.entries(paramMappings).forEach(([elementId, paramKey]) => {
        const element = document.getElementById(elementId) as
          | HTMLInputElement
          | HTMLSelectElement;
        if (element) {
          const value =
            this.fusionParams[paramKey as keyof typeof this.fusionParams];
          element.value = value.toString();

          if (element.type === "range") {
            this.updateParamDisplay(elementId, value.toString());
          }
        }
      });
    }

    private setupControlButtons(): void {
      // ç§»é™¤å›¾ç‰‡æŒ‰é’®
      [1, 2].forEach((index) => {
        const removeBtn = document.getElementById(`remove-image-${index}`);
        const replaceBtn = document.getElementById(`replace-image-${index}`);

        removeBtn?.addEventListener("click", (e) => {
          e.stopPropagation();
          this.removeImage(index);
        });

        replaceBtn?.addEventListener("click", (e) => {
          e.stopPropagation();
          const fileInput = document.getElementById(
            `image-upload-${index}`,
          ) as HTMLInputElement;
          fileInput?.click();
        });
      });

      // è‡ªåŠ¨è°ƒæ•´å°ºå¯¸æŒ‰é’®
      const autoResizeBtn = document.getElementById("auto-resize-btn");
      autoResizeBtn?.addEventListener("click", () => {
        this.autoResizeImages();
      });

      // é¢„è§ˆæ§åˆ¶æŒ‰é’®
      const togglePreviewBtn = document.getElementById("toggle-preview");
      const fullscreenPreviewBtn =
        document.getElementById("fullscreen-preview");

      togglePreviewBtn?.addEventListener("click", () => {
        this.togglePreview();
      });

      fullscreenPreviewBtn?.addEventListener("click", () => {
        this.openFullscreenPreview();
      });

      // å–æ¶ˆèåˆæŒ‰é’®
      const cancelBtn = document.getElementById("cancel-fusion");
      cancelBtn?.addEventListener("click", () => {
        this.cancelFusion();
      });

      // é”™è¯¯å¤„ç†æŒ‰é’®
      const retryBtn = document.getElementById("retry-fusion");
      const closeErrorBtn = document.getElementById("close-error");

      retryBtn?.addEventListener("click", () => {
        this.retryFusion();
      });

      closeErrorBtn?.addEventListener("click", () => {
        this.hideError();
      });
    }

    private removeImage(imageIndex: number): void {
      const imageKey = `image${imageIndex}` as "image1" | "image2";
      this.uploadedFiles[imageKey] = null;

      const uploadArea = document.getElementById(`upload-area-${imageIndex}`);
      const uploadedPreview = document.getElementById(
        `uploaded-preview-${imageIndex}`,
      );

      if (uploadArea && uploadedPreview) {
        uploadArea.style.display = "flex";
        uploadedPreview.style.display = "none";
      }

      this.updateFusionButtons();
      this.hideSizeSuggestion();
    }

    private autoResizeImages(): void {
      // è¿™é‡Œå¯ä»¥å®ç°è‡ªåŠ¨è°ƒæ•´å›¾ç‰‡å°ºå¯¸çš„é€»è¾‘
      // æš‚æ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯
      this.showInfo("è‡ªåŠ¨è°ƒæ•´åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°");
    }

    private updateFusionButtons(): void {
      const { image1, image2 } = this.uploadedFiles;
      const hasImages = image1 && image2;
      const fusionTip = document.getElementById("fusion-tip");

      if (this.previewFusionBtn) {
        this.previewFusionBtn.disabled = !hasImages;
      }

      if (this.startFusionBtn) {
        this.startFusionBtn.disabled = !hasImages;
      }

      if (fusionTip) {
        if (hasImages) {
          fusionTip.textContent = "å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹èåˆ";
        } else if (image1 || image2) {
          fusionTip.textContent = "è¯·ä¸Šä¼ ç¬¬äºŒå¼ å›¾ç‰‡";
        } else {
          fusionTip.textContent = "è¯·ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡å¼€å§‹èåˆ";
        }
      }
    }

    private async startPreviewFusion(): void {
      if (!this.uploadedFiles.image1 || !this.uploadedFiles.image2) return;

      this.previewEnabled = true;
      if (this.previewSection) {
        this.previewSection.style.display = "block";
      }

      await this.updatePreview();
    }

    private async updatePreview(): void {
      if (
        !this.previewCanvas ||
        !this.uploadedFiles.image1 ||
        !this.uploadedFiles.image2
      )
        return;

      const previewLoading = document.getElementById("preview-loading");
      if (previewLoading) {
        previewLoading.style.display = "flex";
      }

      try {
        // æ¨¡æ‹Ÿé¢„è§ˆç”Ÿæˆè¿‡ç¨‹
        await this.simulatePreviewGeneration();

        // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„å›¾ç‰‡èåˆé¢„è§ˆAPI
        // const previewResult = await this.generatePreview();

        if (previewLoading) {
          previewLoading.style.display = "none";
        }

        this.updatePreviewInfo();
      } catch (error) {
        console.error("é¢„è§ˆç”Ÿæˆå¤±è´¥:", error);
        if (previewLoading) {
          previewLoading.style.display = "none";
        }
      }
    }

    private async simulatePreviewGeneration(): Promise<void> {
      return new Promise((resolve) => {
        setTimeout(resolve, 1500);
      });
    }

    private updatePreviewInfo(): void {
      const previewDimensions = document.getElementById("preview-dimensions");
      const previewMode = document.getElementById("preview-mode");
      const previewTime = document.getElementById("preview-time");

      if (previewDimensions) {
        previewDimensions.textContent = "800x600";
      }

      if (previewMode) {
        previewMode.textContent = this.fusionParams.blendMode;
      }

      if (previewTime) {
        previewTime.textContent = "1.2s";
      }
    }

    private togglePreview(): void {
      this.previewEnabled = !this.previewEnabled;

      if (
        this.previewEnabled &&
        this.uploadedFiles.image1 &&
        this.uploadedFiles.image2
      ) {
        this.updatePreview();
      }
    }

    private openFullscreenPreview(): void {
      // å®ç°å…¨å±é¢„è§ˆåŠŸèƒ½
      if (this.previewCanvas) {
        if (this.previewCanvas.requestFullscreen) {
          this.previewCanvas.requestFullscreen();
        }
      }
    }

    private async startFusion(): void {
      if (
        !this.uploadedFiles.image1 ||
        !this.uploadedFiles.image2 ||
        this.isFusing
      )
        return;

      this.isFusing = true;
      this.showProgress();

      try {
        const result = await this.performFusion();
        this.handleFusionSuccess(result);
      } catch (error) {
        console.error("èåˆå¤±è´¥:", error);
        this.handleFusionError(error as Error);
      } finally {
        this.isFusing = false;
      }
    }
    private async performFusion(): Promise<any> {
      const formData = new FormData();
      formData.append("image1", this.uploadedFiles.image1!);
      formData.append("image2", this.uploadedFiles.image2!);
      formData.append("params", JSON.stringify(this.fusionParams));

      // æ¨¡æ‹Ÿèåˆè¿›åº¦
      this.simulateFusionProgress();

      const response = await fetch("/api/banana-editor/fusion", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error(`èåˆå¤±è´¥: ${response.statusText}`);
      }

      return await response.json();
    }

    private simulateFusionProgress(): void {
      const steps = ["prepare", "analyze", "blend", "optimize"];
      let currentStepIndex = 0;
      let progress = 0;

      const updateProgress = () => {
        if (currentStepIndex < steps.length) {
          // æ›´æ–°æ­¥éª¤çŠ¶æ€
          const currentStep = document.querySelector(
            `[data-step="${steps[currentStepIndex]}"]`,
          );
          if (currentStep) {
            currentStep.classList.add("active");

            // å®Œæˆå‰ä¸€ä¸ªæ­¥éª¤
            if (currentStepIndex > 0) {
              const prevStep = document.querySelector(
                `[data-step="${steps[currentStepIndex - 1]}"]`,
              );
              if (prevStep) {
                prevStep.classList.remove("active");
                prevStep.classList.add("completed");
              }
            }
          }

          // æ›´æ–°è¿›åº¦æ¡
          progress = ((currentStepIndex + 1) / steps.length) * 100;
          this.updateProgressBar(progress);

          // æ›´æ–°è¯¦ç»†ä¿¡æ¯
          this.updateProgressDetails(steps[currentStepIndex], progress);

          currentStepIndex++;

          if (currentStepIndex <= steps.length) {
            setTimeout(updateProgress, 2000);
          }
        }
      };

      updateProgress();
    }

    private updateProgressBar(progress: number): void {
      const progressFill = document.getElementById("progress-fill");
      const progressPercentage = document.getElementById("progress-percentage");

      if (progressFill) {
        progressFill.style.width = `${progress}%`;
      }

      if (progressPercentage) {
        progressPercentage.textContent = `${Math.round(progress)}%`;
      }
    }

    private updateProgressDetails(step: string, progress: number): void {
      const currentStepElement = document.getElementById("current-step");
      const estimatedTimeElement = document.getElementById("estimated-time");

      const stepNames = {
        prepare: "å‡†å¤‡å›¾ç‰‡æ•°æ®",
        analyze: "åˆ†æå›¾ç‰‡ç‰¹å¾",
        blend: "æ‰§è¡Œèåˆç®—æ³•",
        optimize: "ä¼˜åŒ–è¾“å‡ºç»“æœ",
      };

      if (currentStepElement) {
        currentStepElement.textContent =
          stepNames[step as keyof typeof stepNames] || step;
      }

      if (estimatedTimeElement) {
        const remainingTime = Math.max(0, Math.round((100 - progress) / 20));
        estimatedTimeElement.textContent = `${remainingTime}ç§’`;
      }
    }

    private showProgress(): void {
      if (this.progressSection) {
        this.progressSection.style.display = "block";
      }
      this.hideError();
    }

    private hideProgress(): void {
      if (this.progressSection) {
        this.progressSection.style.display = "none";
      }
    }

    private handleFusionSuccess(result: any): void {
      this.hideProgress();

      // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥ç¼–è¾‘å™¨æ˜¾ç¤ºç»“æœ
      const fusionCompleteEvent = new CustomEvent("fusionComplete", {
        detail: {
          result: result,
          params: this.fusionParams,
        },
      });

      document.dispatchEvent(fusionCompleteEvent);

      this.showSuccess("å›¾ç‰‡èåˆå®Œæˆï¼");
    }

    private handleFusionError(error: Error): void {
      this.hideProgress();
      this.showError(error.message || "èåˆè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯");
    }

    private cancelFusion(): void {
      this.isFusing = false;
      this.hideProgress();

      // è¿™é‡Œå¯ä»¥æ·»åŠ å–æ¶ˆAPIè¯·æ±‚çš„é€»è¾‘
      this.showInfo("èåˆå·²å–æ¶ˆ");
    }

    private retryFusion(): void {
      this.hideError();
      this.startFusion();
    }

    private showError(message: string): void {
      const errorMessage = document.getElementById("error-message");
      if (errorMessage) {
        errorMessage.textContent = message;
      }

      if (this.errorSection) {
        this.errorSection.style.display = "block";
      }
    }

    private hideError(): void {
      if (this.errorSection) {
        this.errorSection.style.display = "none";
      }
    }

    private showSuccess(message: string): void {
      // å¯ä»¥å®ç°æˆåŠŸæç¤ºçš„æ˜¾ç¤ºé€»è¾‘
      console.log("æˆåŠŸ:", message);
    }

    private showInfo(message: string): void {
      // å¯ä»¥å®ç°ä¿¡æ¯æç¤ºçš„æ˜¾ç¤ºé€»è¾‘
      console.log("ä¿¡æ¯:", message);
    }

    private hideSizeSuggestion(): void {
      const sizeSuggestion = document.getElementById("size-suggestion");
      if (sizeSuggestion) {
        sizeSuggestion.style.display = "none";
      }
    }
    // è®¾ç½®èåˆæç¤ºè¯äº‹ä»¶
    private setupFusionPrompt(): void {
      // æç¤ºè¯è¾“å…¥äº‹ä»¶
      this.fusionPromptTextarea?.addEventListener("input", (e) => {
        const target = e.target as HTMLTextAreaElement;
        this.fusionPrompt = target.value;
        this.updateFusionCharacterCount();
        this.updateFusionButtons();
      });

      // èåˆå»ºè®®æ ‡ç­¾äº‹ä»¶
      const fusionSuggestionTags = document.querySelectorAll(
        ".fusion-suggestions .suggestion-tag",
      );
      fusionSuggestionTags.forEach((tag) => {
        tag.addEventListener("click", () => {
          const prompt = (tag as HTMLElement).dataset.prompt;
          if (prompt) {
            this.addFusionPromptSuggestion(prompt);
          }
        });
      });

      // ç›‘å¬æç¤ºè¯ä¼˜åŒ–äº‹ä»¶
      document.addEventListener("promptOptimized", (e: any) => {
        if (this.fusionPromptTextarea) {
          this.fusionPromptTextarea.value = e.detail.optimizedPrompt;
          this.fusionPrompt = e.detail.optimizedPrompt;
          this.updateFusionCharacterCount();
          this.updateFusionButtons();
        }
      });
    }

    // æ›´æ–°èåˆæç¤ºè¯å­—ç¬¦è®¡æ•°
    private updateFusionCharacterCount(): void {
      const charCount = document.getElementById("fusion-char-count");
      if (charCount) {
        charCount.textContent = this.fusionPrompt.length.toString();

        // æ›´æ–°é¢œè‰²æç¤º
        if (this.fusionPrompt.length > 900) {
          charCount.style.color = "#dc2626";
        } else if (this.fusionPrompt.length > 750) {
          charCount.style.color = "#f59e0b";
        } else {
          charCount.style.color = "#666";
        }
      }
    }

    // æ·»åŠ èåˆæç¤ºè¯å»ºè®®
    private addFusionPromptSuggestion(suggestion: string): void {
      if (!this.fusionPromptTextarea) return;

      const currentValue = this.fusionPromptTextarea.value;
      const newValue = currentValue
        ? `${currentValue}, ${suggestion}`
        : suggestion;

      this.fusionPromptTextarea.value = newValue;
      this.fusionPrompt = newValue;
      this.updateFusionCharacterCount();
      this.updateFusionButtons();

      // èšç„¦åˆ°è¾“å…¥æ¡†æœ«å°¾
      this.fusionPromptTextarea.focus();
      this.fusionPromptTextarea.setSelectionRange(
        newValue.length,
        newValue.length,
      );
    }

    // è·å–èåˆæç¤ºè¯ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
    public getFusionPrompt(): string {
      return this.fusionPrompt;
    }

    // è®¾ç½®èåˆæç¤ºè¯ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
    public setFusionPrompt(prompt: string): void {
      if (this.fusionPromptTextarea) {
        this.fusionPromptTextarea.value = prompt;
        this.fusionPrompt = prompt;
        this.updateFusionCharacterCount();
        this.updateFusionButtons();
      }
    }
  }

  // åˆå§‹åŒ–èåˆå™¨
  document.addEventListener("DOMContentLoaded", () => {
    new BananaImageFusion();
  });
</script>
