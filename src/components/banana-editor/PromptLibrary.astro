---
import PromptSearch from "./ui/PromptSearch.astro";
import PromptCategories from "./ui/PromptCategories.astro";
import PromptGrid from "./ui/PromptGrid.astro";
import PromptFilters from "./ui/PromptFilters.astro";
---

<div class="prompt-library">
  <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨æ“ä½œæ  -->
  <div class="mobile-top-bar">
    <button class="mobile-search-toggle" id="mobile-search-toggle">
      <span class="icon">ğŸ”</span>
      <span class="label">æœç´¢</span>
    </button>
    <button class="mobile-filter-toggle" id="mobile-filter-toggle">
      <span class="icon">ğŸ›ï¸</span>
      <span class="label">ç­›é€‰</span>
    </button>
    <button class="mobile-category-toggle" id="mobile-category-toggle">
      <span class="icon">ğŸ“‚</span>
      <span class="label">åˆ†ç±»</span>
    </button>
  </div>

  <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
  <div class="library-header" id="library-header">
    <div class="search-section">
      <PromptSearch />
    </div>

    <div class="filters-section">
      <PromptFilters />
    </div>
  </div>

  <!-- åˆ†ç±»å¯¼èˆª -->
  <div class="categories-section" id="categories-section">
    <PromptCategories />
  </div>

  <!-- æç¤ºè¯ç½‘æ ¼å±•ç¤º -->
  <div class="prompts-section">
    <PromptGrid />
  </div>

  <!-- ç§»åŠ¨ç«¯æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <div class="mobile-fab-container">
    <button class="mobile-fab" id="mobile-scroll-top">
      <span class="fab-icon">â†‘</span>
    </button>
  </div>
</div>

<style>
  .prompt-library {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .library-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fff8dc 0%, #fffacd 100%);
    border-radius: 12px;
    border: 1px solid #ffd700;
  }

  .search-section {
    flex: 1;
  }

  .filters-section {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .categories-section {
    margin-bottom: 2rem;
  }

  .prompts-section {
    min-height: 400px;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (min-width: 768px) {
    .library-header {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .search-section {
      max-width: 400px;
    }
  }

  /* ç§»åŠ¨ç«¯é¡¶éƒ¨æ“ä½œæ  */
  .mobile-top-bar {
    display: none;
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    border-bottom: 1px solid #e5e7eb;
    padding: 12px 16px;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .mobile-search-toggle,
  .mobile-filter-toggle,
  .mobile-category-toggle {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    flex: 1;
    min-height: 60px;
    -webkit-tap-highlight-color: rgba(255, 215, 0, 0.2);
  }

  .mobile-search-toggle:hover,
  .mobile-filter-toggle:hover,
  .mobile-category-toggle:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 215, 0, 0.05);
  }

  .mobile-search-toggle:active,
  .mobile-filter-toggle:active,
  .mobile-category-toggle:active {
    transform: scale(0.98);
  }

  .mobile-search-toggle.active,
  .mobile-filter-toggle.active,
  .mobile-category-toggle.active {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 215, 0, 0.1);
  }

  .mobile-top-bar .icon {
    font-size: 20px;
  }

  .mobile-top-bar .label {
    font-size: 12px;
    font-weight: 500;
    color: #374151;
  }

  /* ç§»åŠ¨ç«¯æµ®åŠ¨æ“ä½œæŒ‰é’® */
  .mobile-fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: none;
  }

  .mobile-fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(
      --banana-gradient,
      linear-gradient(135deg, #ffd700 0%, #ffa500 100%)
    );
    border: none;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .mobile-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.5);
  }

  .mobile-fab:active {
    transform: scale(0.95);
  }

  .fab-icon {
    font-size: 20px;
    font-weight: bold;
    color: var(--banana-dark, #2d1810);
  }

  /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .prompt-library {
      padding: 0;
      position: relative;
    }

    .mobile-top-bar {
      display: flex;
    }

    .mobile-fab-container {
      display: block;
    }

    .library-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 200;
      margin: 0;
      border-radius: 0 0 16px 16px;
      border-left: none;
      border-right: none;
      border-top: none;
      transform: translateY(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      max-height: 80vh;
      overflow-y: auto;
    }

    .library-header.show {
      transform: translateY(0);
    }

    .categories-section {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 200;
      background: white;
      border-radius: 0 0 16px 16px;
      border-bottom: 1px solid #e5e7eb;
      transform: translateY(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 16px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .categories-section.show {
      transform: translateY(0);
    }

    .filters-section {
      justify-content: center;
      flex-wrap: wrap;
    }

    .prompts-section {
      padding-top: 16px;
    }

    /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
    .library-header,
    .categories-section {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* ç§»åŠ¨ç«¯èƒŒæ™¯é®ç½© */
    .library-header.show::before,
    .categories-section.show::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: -1;
    }
  }

  @media (max-width: 480px) {
    .mobile-top-bar {
      padding: 8px 12px;
    }

    .mobile-search-toggle,
    .mobile-filter-toggle,
    .mobile-category-toggle {
      padding: 6px 8px;
      min-height: 50px;
    }

    .mobile-top-bar .icon {
      font-size: 18px;
    }

    .mobile-top-bar .label {
      font-size: 11px;
    }

    .mobile-fab {
      width: 48px;
      height: 48px;
      bottom: 16px;
      right: 16px;
    }

    .fab-icon {
      font-size: 18px;
    }
  }

  /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
  @media (prefers-contrast: high) {
    .mobile-top-bar {
      border-bottom-color: #000;
    }

    .mobile-search-toggle,
    .mobile-filter-toggle,
    .mobile-category-toggle {
      border-color: #000;
    }

    .mobile-fab {
      background: #000;
      color: #fff;
    }
  }

  /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
  @media (prefers-reduced-motion: reduce) {
    .library-header,
    .categories-section,
    .mobile-fab {
      transition: none;
    }
  }
</style>

<script>
  import {
    TouchGestureHandler,
    isMobileDevice,
    debounce,
  } from "../../utils/touch-gestures.ts";

  // ç§»åŠ¨ç«¯æç¤ºè¯åº“äº¤äº’é€»è¾‘
  class MobilePromptLibrary {
    private searchToggle: HTMLElement | null = null;
    private filterToggle: HTMLElement | null = null;
    private categoryToggle: HTMLElement | null = null;
    private libraryHeader: HTMLElement | null = null;
    private categoriesSection: HTMLElement | null = null;
    private scrollTopFab: HTMLElement | null = null;
    private isMobile: boolean = false;
    private touchHandler: TouchGestureHandler | null = null;
    private lastScrollY: number = 0;

    constructor() {
      this.init();
    }

    private init(): void {
      this.isMobile = isMobileDevice();

      if (!this.isMobile) return;

      this.searchToggle = document.getElementById("mobile-search-toggle");
      this.filterToggle = document.getElementById("mobile-filter-toggle");
      this.categoryToggle = document.getElementById("mobile-category-toggle");
      this.libraryHeader = document.getElementById("library-header");
      this.categoriesSection = document.getElementById("categories-section");
      this.scrollTopFab = document.getElementById("mobile-scroll-top");

      this.setupEventListeners();
      this.setupTouchGestures();
      this.setupScrollHandling();
    }

    private setupEventListeners(): void {
      // æœç´¢åˆ‡æ¢
      this.searchToggle?.addEventListener("click", () => {
        this.togglePanel("search");
      });

      // ç­›é€‰åˆ‡æ¢
      this.filterToggle?.addEventListener("click", () => {
        this.togglePanel("filter");
      });

      // åˆ†ç±»åˆ‡æ¢
      this.categoryToggle?.addEventListener("click", () => {
        this.togglePanel("category");
      });

      // å›åˆ°é¡¶éƒ¨
      this.scrollTopFab?.addEventListener("click", () => {
        this.scrollToTop();
      });

      // ç‚¹å‡»é®ç½©å…³é—­é¢æ¿
      document.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;

        if (
          this.libraryHeader?.classList.contains("show") &&
          !this.libraryHeader.contains(target) &&
          !this.searchToggle?.contains(target) &&
          !this.filterToggle?.contains(target)
        ) {
          this.hideAllPanels();
        }

        if (
          this.categoriesSection?.classList.contains("show") &&
          !this.categoriesSection.contains(target) &&
          !this.categoryToggle?.contains(target)
        ) {
          this.hideAllPanels();
        }
      });

      // é”®ç›˜äº‹ä»¶
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          this.hideAllPanels();
        }
      });

      // çª—å£å¤§å°å˜åŒ–
      window.addEventListener(
        "resize",
        debounce(() => {
          this.isMobile = isMobileDevice();
          if (!this.isMobile) {
            this.hideAllPanels();
          }
        }, 250),
      );
    }

    private setupTouchGestures(): void {
      const promptsSection = document.querySelector(".prompts-section");
      if (!promptsSection) return;

      this.touchHandler = new TouchGestureHandler(
        promptsSection as HTMLElement,
      );

      // å‘ä¸‹æ»‘åŠ¨éšè—é¢æ¿
      this.touchHandler.on("swipe", (event: any) => {
        if (event.direction === "down" && event.velocity > 0.5) {
          this.hideAllPanels();
        }
      });

      // åŒå‡»å›åˆ°é¡¶éƒ¨
      this.touchHandler.on("tap", (event: any) => {
        const now = Date.now();
        const lastTap = (promptsSection as any).lastTapTime || 0;

        if (now - lastTap < 300) {
          this.scrollToTop();
        }

        (promptsSection as any).lastTapTime = now;
      });
    }

    private setupScrollHandling(): void {
      let ticking = false;

      const handleScroll = () => {
        if (!ticking) {
          requestAnimationFrame(() => {
            this.updateScrollState();
            ticking = false;
          });
          ticking = true;
        }
      };

      window.addEventListener("scroll", handleScroll, { passive: true });
    }

    private updateScrollState(): void {
      const currentScrollY = window.scrollY;

      // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
      if (this.scrollTopFab) {
        if (currentScrollY > 300) {
          this.scrollTopFab.style.display = "flex";
          this.scrollTopFab.style.opacity = "1";
        } else {
          this.scrollTopFab.style.opacity = "0";
          setTimeout(() => {
            if (currentScrollY <= 300) {
              this.scrollTopFab!.style.display = "none";
            }
          }, 200);
        }
      }

      // å‘ä¸‹æ»šåŠ¨æ—¶éšè—é¢æ¿
      if (currentScrollY > this.lastScrollY + 50) {
        this.hideAllPanels();
      }

      this.lastScrollY = currentScrollY;
    }

    private togglePanel(type: "search" | "filter" | "category"): void {
      // å…ˆéšè—æ‰€æœ‰é¢æ¿
      this.hideAllPanels();

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      this.updateToggleStates(type);

      // æ˜¾ç¤ºå¯¹åº”é¢æ¿
      if (type === "search" || type === "filter") {
        this.showLibraryHeader();
      } else if (type === "category") {
        this.showCategoriesSection();
      }

      // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
      this.addHapticFeedback();
    }

    private updateToggleStates(activeType: string): void {
      // é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
      this.searchToggle?.classList.remove("active");
      this.filterToggle?.classList.remove("active");
      this.categoryToggle?.classList.remove("active");

      // æ¿€æ´»å½“å‰æŒ‰é’®
      switch (activeType) {
        case "search":
          this.searchToggle?.classList.add("active");
          break;
        case "filter":
          this.filterToggle?.classList.add("active");
          break;
        case "category":
          this.categoryToggle?.classList.add("active");
          break;
      }
    }

    private showLibraryHeader(): void {
      if (this.libraryHeader) {
        this.libraryHeader.classList.add("show");

        // èšç„¦åˆ°æœç´¢è¾“å…¥æ¡†
        setTimeout(() => {
          const searchInput = this.libraryHeader?.querySelector(
            'input[type="search"]',
          ) as HTMLInputElement;
          if (searchInput) {
            searchInput.focus();
          }
        }, 300);
      }
    }

    private showCategoriesSection(): void {
      if (this.categoriesSection) {
        this.categoriesSection.classList.add("show");
      }
    }

    private hideAllPanels(): void {
      this.libraryHeader?.classList.remove("show");
      this.categoriesSection?.classList.remove("show");

      // é‡ç½®æŒ‰é’®çŠ¶æ€
      this.searchToggle?.classList.remove("active");
      this.filterToggle?.classList.remove("active");
      this.categoryToggle?.classList.remove("active");

      // ç§»é™¤ç„¦ç‚¹
      const activeElement = document.activeElement as HTMLElement;
      if (activeElement && activeElement.blur) {
        activeElement.blur();
      }
    }

    private scrollToTop(): void {
      window.scrollTo({
        top: 0,
        behavior: "smooth",
      });

      // æ·»åŠ è§¦è§‰åé¦ˆ
      this.addHapticFeedback();
    }

    private addHapticFeedback(): void {
      // å¦‚æœè®¾å¤‡æ”¯æŒè§¦è§‰åé¦ˆ
      if ("vibrate" in navigator) {
        navigator.vibrate(50);
      }
    }

    // å…¬å…±æ–¹æ³•
    public hidePanel(): void {
      this.hideAllPanels();
    }

    public showSearchPanel(): void {
      this.togglePanel("search");
    }

    public showFilterPanel(): void {
      this.togglePanel("filter");
    }

    public showCategoryPanel(): void {
      this.togglePanel("category");
    }

    public destroy(): void {
      if (this.touchHandler) {
        this.touchHandler.destroy();
      }
    }
  }

  // åˆå§‹åŒ–ç§»åŠ¨ç«¯æç¤ºè¯åº“
  document.addEventListener("DOMContentLoaded", () => {
    const mobileLibrary = new MobilePromptLibrary();

    // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
    (window as any).MobilePromptLibrary = mobileLibrary;
  });
</script>
