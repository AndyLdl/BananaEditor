---
// Astro åŒ…è£…ç»„ä»¶ï¼Œç”¨äºæ¸²æŸ“ React EditorUserInfo ç»„ä»¶
---

<div id="editor-user-info-root" class="editor-user-info-wrapper"></div>

<script>
  import { createRoot } from "react-dom/client";
  import React from "react";
  import EditorUserInfo from "./EditorUserInfo.tsx";

  // åˆå§‹åŒ–è®¡æ•°å™¨ï¼Œç”¨äºé‡è¯•
  let initAttempts = 0;
  const MAX_INIT_ATTEMPTS = 3;

  // ä¼˜åŒ–çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå¸¦é‡è¯•æœºåˆ¶
  function initEditorUserInfo() {
    initAttempts++;
    const startTime = Date.now();

    console.log(
      `ğŸš€ [EditorUserInfoWrapper] Init attempt ${initAttempts}/${MAX_INIT_ATTEMPTS}`
    );

    const container = document.getElementById("editor-user-info-root");

    if (!container) {
      console.warn(
        `âš ï¸ [EditorUserInfoWrapper] Container not found, attempt ${initAttempts}`
      );

      // é‡è¯•æœºåˆ¶
      if (initAttempts < MAX_INIT_ATTEMPTS) {
        setTimeout(() => {
          console.log(`ğŸ”„ [EditorUserInfoWrapper] Retrying init...`);
          initEditorUserInfo();
        }, 100 * initAttempts); // é€’å¢å»¶è¿Ÿï¼š100ms, 200ms, 300ms
      } else {
        console.error(
          `âŒ [EditorUserInfoWrapper] Failed to find container after ${MAX_INIT_ATTEMPTS} attempts`
        );
      }
      return;
    }

    if (container.hasAttribute("data-initialized")) {
      console.log(`âœ… [EditorUserInfoWrapper] Already initialized, skipping`);
      return;
    }

    try {
      container.setAttribute("data-initialized", "true");
      const root = createRoot(container);
      root.render(React.createElement(EditorUserInfo));

      const elapsed = Date.now() - startTime;
      console.log(
        `âœ… [EditorUserInfoWrapper] React component rendered in ${elapsed}ms`
      );
    } catch (error) {
      console.error(`âŒ [EditorUserInfoWrapper] Render error:`, error);
      container.removeAttribute("data-initialized"); // å…è®¸é‡è¯•
    }
  }

  // å¤šç§åˆå§‹åŒ–ç­–ç•¥ï¼Œç¡®ä¿ç»„ä»¶ä¸€å®šèƒ½åŠ è½½
  if (document.readyState === "loading") {
    // å¦‚æœDOMè¿˜åœ¨åŠ è½½ï¼Œç­‰å¾…DOMContentLoaded
    document.addEventListener("DOMContentLoaded", initEditorUserInfo);
  } else if (document.readyState === "interactive") {
    // DOMå·²ç»è§£æä½†èµ„æºè¿˜åœ¨åŠ è½½ï¼Œç«‹å³åˆå§‹åŒ–æˆ–ç¨ç­‰ä¸€ä¸‹
    setTimeout(initEditorUserInfo, 0);
  } else {
    // DOMå’Œèµ„æºéƒ½å·²åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–
    initEditorUserInfo();
  }

  // å¤‡ç”¨ç­–ç•¥ï¼šå¦‚æœ1ç§’åè¿˜æ²¡åˆå§‹åŒ–ï¼Œå¼ºåˆ¶é‡è¯•
  setTimeout(() => {
    const container = document.getElementById("editor-user-info-root");
    if (container && !container.hasAttribute("data-initialized")) {
      console.warn(
        "âš ï¸ [EditorUserInfoWrapper] Fallback init triggered after 1s"
      );
      initAttempts = 0; // é‡ç½®è®¡æ•°å™¨
      initEditorUserInfo();
    }
  }, 1000);
</script>

<style>
  .editor-user-info-wrapper {
    display: flex;
    align-items: center;
  }
</style>
