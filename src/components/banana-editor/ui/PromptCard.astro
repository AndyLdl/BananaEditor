---
// æç¤ºè¯å¡ç‰‡ç»„ä»¶ - æ˜¾ç¤ºå•ä¸ªæç¤ºè¯çš„ä¿¡æ¯å’Œæ“ä½œ
export interface Props {
    prompt: {
        id: string;
        title: string;
        content: string;
        category: string;
        tags: string[];
        description: string;
        createdAt: string;
        updatedAt: string;
        usageCount: number;
        rating: number;
    };
    viewMode?: 'grid' | 'list';
    showActions?: boolean;
}

const { prompt, viewMode = 'grid', showActions = true } = Astro.props;

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString: string): string {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// è·å–åˆ†ç±»åç§°
function getCategoryName(category: string): string {
    const categoryNames: Record<string, string> = {
        portrait: 'äººç‰©è‚–åƒ',
        landscape: 'é£æ™¯è‡ªç„¶',
        abstract: 'æŠ½è±¡è‰ºæœ¯',
        anime: 'åŠ¨æ¼«é£æ ¼'
    };
    return categoryNames[category] || category;
}

// è·å–åˆ†ç±»å›¾æ ‡
function getCategoryIcon(category: string): string {
    const categoryIcons: Record<string, string> = {
        portrait: 'ğŸ‘¤',
        landscape: 'ğŸŒ„',
        abstract: 'ğŸ¨',
        anime: 'ğŸ­'
    };
    return categoryIcons[category] || 'ğŸ“';
}
---

<div class={`prompt-card ${viewMode}-mode`} data-prompt-id={prompt.id}>
    <!-- å¡ç‰‡å¤´éƒ¨ -->
    <div class="card-header">
        <div class="card-title-section">
            <h3 class="card-title">{prompt.title}</h3>
            <div class="card-category">
                <span class="category-icon">{getCategoryIcon(prompt.category)}</span>
                <span class="category-name">{getCategoryName(prompt.category)}</span>
            </div>
        </div>
        
        {showActions && (
            <div class="card-actions-menu">
                <button class="menu-button" data-action="menu" title="æ›´å¤šæ“ä½œ">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                    </svg>
                </button>
                
                <!-- ä¸‹æ‹‰èœå• -->
                <div class="dropdown-menu" style="display: none;">
                    <button class="menu-item" data-action="edit" data-prompt-id={prompt.id}>
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                        ç¼–è¾‘
                    </button>
                    <button class="menu-item" data-action="duplicate" data-prompt-id={prompt.id}>
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                        å¤åˆ¶
                    </button>
                    <button class="menu-item danger" data-action="delete" data-prompt-id={prompt.id}>
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        åˆ é™¤
                    </button>
                </div>
            </div>
        )}
    </div>

    <!-- å¡ç‰‡å†…å®¹ -->
    <div class="card-content">
        <p class="card-description">{prompt.description}</p>
        
        <div class="prompt-preview">
            <div class="preview-label">æç¤ºè¯å†…å®¹ï¼š</div>
            <div class="preview-text">{prompt.content}</div>
        </div>
    </div>

    <!-- å¡ç‰‡æ ‡ç­¾ -->
    <div class="card-tags">
        {prompt.tags.map(tag => (
            <span class="tag">{tag}</span>
        ))}
    </div>

    <!-- å¡ç‰‡å…ƒæ•°æ® -->
    <div class="card-meta">
        <div class="meta-item rating">
            <div class="stars">
                {Array.from({ length: 5 }, (_, i) => (
                    <span class={`star ${i < Math.floor(prompt.rating) ? 'filled' : 'empty'}`}>â˜…</span>
                ))}
            </div>
            <span class="rating-value">{prompt.rating}</span>
        </div>
        
        <div class="meta-item usage">
            <svg viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{prompt.usageCount}</span>
        </div>
        
        <div class="meta-item date">
            <svg viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
            </svg>
            <span>{formatDate(prompt.createdAt)}</span>
        </div>
    </div>

    <!-- å¡ç‰‡æ“ä½œæŒ‰é’® -->
    {showActions && (
        <div class="card-actions">
            <button class="action-btn secondary" data-action="copy" data-prompt-id={prompt.id} title="å¤åˆ¶æç¤ºè¯">
                <svg viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                </svg>
                å¤åˆ¶
            </button>
            
            <button class="action-btn secondary favorite-btn" data-action="favorite" data-prompt-id={prompt.id} title="æ”¶è—">
                <svg class="heart-empty" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                <svg class="heart-filled" viewBox="0 0 20 20" fill="currentColor" style="display: none;">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                <span class="favorite-text">æ”¶è—</span>
            </button>
            
            <button class="action-btn primary" data-action="use" data-prompt-id={prompt.id}>
                <svg viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨
            </button>
        </div>
    )}

    <!-- è¯„åˆ†ç»„ä»¶ -->
    <div class="rating-component" style="display: none;">
        <div class="rating-header">
            <h4>ä¸ºè¿™ä¸ªæç¤ºè¯è¯„åˆ†</h4>
            <button class="close-rating">âœ•</button>
        </div>
        <div class="rating-stars">
            {Array.from({ length: 5 }, (_, i) => (
                <button class="rating-star" data-rating={i + 1}>â˜…</button>
            ))}
        </div>
        <div class="rating-actions">
            <button class="submit-rating">æäº¤è¯„åˆ†</button>
            <button class="cancel-rating">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<style>
    .prompt-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .prompt-card:hover {
        border-color: #FFD700;
        box-shadow: 0 8px 24px rgba(255, 215, 0, 0.15);
        transform: translateY(-2px);
    }

    /* ç½‘æ ¼æ¨¡å¼ */
    .prompt-card.grid-mode {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* åˆ—è¡¨æ¨¡å¼ */
    .prompt-card.list-mode {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        height: auto;
    }

    .prompt-card.list-mode .card-header {
        flex: 0 0 200px;
        margin-bottom: 0;
    }

    .prompt-card.list-mode .card-content {
        flex: 1;
        margin: 0 1rem;
    }

    .prompt-card.list-mode .card-actions {
        flex: 0 0 auto;
        margin-top: 0;
    }

    /* å¡ç‰‡å¤´éƒ¨ */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        position: relative;
    }

    .card-title-section {
        flex: 1;
    }

    .card-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2D1810;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .card-category {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: #FFD700;
        color: #2D1810;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 500;
        width: fit-content;
    }

    .category-icon {
        font-size: 0.875rem;
    }

    /* æ“ä½œèœå• */
    .card-actions-menu {
        position: relative;
    }

    .menu-button {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: #666;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .menu-button:hover {
        background: #f3f4f6;
        color: #333;
    }

    .menu-button svg {
        width: 16px;
        height: 16px;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        min-width: 120px;
        padding: 0.5rem 0;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: none;
        background: none;
        color: #374151;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .menu-item:hover {
        background: #f9fafb;
    }

    .menu-item.danger {
        color: #dc2626;
    }

    .menu-item.danger:hover {
        background: #fef2f2;
    }

    .menu-item svg {
        width: 14px;
        height: 14px;
    }

    /* å¡ç‰‡å†…å®¹ */
    .card-content {
        flex: 1;
        margin-bottom: 1rem;
    }

    .card-description {
        color: #6b7280;
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0 0 1rem 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .prompt-preview {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem;
    }

    .preview-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .preview-text {
        color: #374151;
        font-size: 0.875rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* æ ‡ç­¾ */
    .card-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .tag {
        background: #f3f4f6;
        color: #6b7280;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* å…ƒæ•°æ® */
    .card-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.8rem;
        color: #6b7280;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .meta-item svg {
        width: 14px;
        height: 14px;
    }

    .stars {
        display: flex;
        gap: 1px;
    }

    .star {
        color: #FFD700;
        font-size: 0.875rem;
    }

    .star.empty {
        color: #e5e7eb;
    }

    .rating-value {
        margin-left: 0.25rem;
        font-weight: 500;
    }

    /* æ“ä½œæŒ‰é’® */
    .card-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
    }

    .action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-btn svg {
        width: 16px;
        height: 16px;
    }

    .action-btn:hover {
        border-color: #FFD700;
        color: #FFA500;
    }

    .action-btn.primary {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: white;
        border-color: #FFD700;
    }

    .action-btn.primary:hover {
        background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
    }

    .action-btn.secondary:hover {
        background: #FFF8DC;
    }

    /* æ”¶è—æŒ‰é’®çŠ¶æ€ */
    .favorite-btn.favorited {
        color: #dc2626;
        border-color: #dc2626;
    }

    .favorite-btn.favorited .heart-empty {
        display: none;
    }

    .favorite-btn.favorited .heart-filled {
        display: block !important;
    }

    .favorite-btn.favorited .favorite-text::after {
        content: 'å·²æ”¶è—';
    }

    /* è¯„åˆ†ç»„ä»¶ */
    .rating-component {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border-radius: 12px;
    }

    .rating-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 1rem;
    }

    .rating-header h4 {
        margin: 0;
        font-size: 1rem;
        color: #2D1810;
    }

    .close-rating {
        width: 24px;
        height: 24px;
        border: none;
        background: #f3f4f6;
        color: #666;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .rating-stars {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .rating-star {
        font-size: 2rem;
        color: #e5e7eb;
        border: none;
        background: none;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .rating-star:hover,
    .rating-star.active {
        color: #FFD700;
    }

    .rating-actions {
        display: flex;
        gap: 0.5rem;
    }

    .submit-rating,
    .cancel-rating {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .submit-rating {
        background: #FFD700;
        border-color: #FFD700;
        color: #2D1810;
    }

    .submit-rating:hover {
        background: #FFA500;
    }

    .cancel-rating:hover {
        background: #f9fafb;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .prompt-card.list-mode {
            flex-direction: column;
            align-items: stretch;
        }

        .prompt-card.list-mode .card-header,
        .prompt-card.list-mode .card-content {
            flex: none;
            margin: 0 0 1rem 0;
        }

        .card-actions {
            flex-direction: column;
        }

        .action-btn {
            justify-content: center;
        }
    }
</style>

<script>
    // æç¤ºè¯å¡ç‰‡äº¤äº’åŠŸèƒ½
    class PromptCard {
        constructor(cardElement) {
            this.card = cardElement;
            this.promptId = cardElement.dataset.promptId;
            this.isFavorited = false;
            this.currentRating = 0;
            
            this.init();
        }

        init() {
            this.bindEvents();
            this.loadFavoriteStatus();
        }

        bindEvents() {
            // æ“ä½œæŒ‰é’®äº‹ä»¶
            this.card.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = button.dataset.action;
                    this.handleAction(action, button);
                });
            });

            // èœå•æŒ‰é’®äº‹ä»¶
            const menuButton = this.card.querySelector('.menu-button');
            const dropdownMenu = this.card.querySelector('.dropdown-menu');
            
            if (menuButton && dropdownMenu) {
                menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleDropdownMenu();
                });
            }

            // è¯„åˆ†ç»„ä»¶äº‹ä»¶
            this.bindRatingEvents();

            // ç‚¹å‡»å¡ç‰‡å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', () => {
                this.closeDropdownMenu();
            });
        }

        bindRatingEvents() {
            const ratingComponent = this.card.querySelector('.rating-component');
            const ratingStars = this.card.querySelectorAll('.rating-star');
            const submitButton = this.card.querySelector('.submit-rating');
            const cancelButton = this.card.querySelector('.cancel-rating');
            const closeButton = this.card.querySelector('.close-rating');

            // æ˜Ÿçº§è¯„åˆ†äº¤äº’
            ratingStars.forEach((star, index) => {
                star.addEventListener('mouseenter', () => {
                    this.highlightStars(index + 1);
                });

                star.addEventListener('click', () => {
                    this.currentRating = index + 1;
                    this.setActiveStars(this.currentRating);
                });
            });

            // æäº¤è¯„åˆ†
            submitButton?.addEventListener('click', () => {
                this.submitRating();
            });

            // å–æ¶ˆè¯„åˆ†
            cancelButton?.addEventListener('click', () => {
                this.closeRatingComponent();
            });

            closeButton?.addEventListener('click', () => {
                this.closeRatingComponent();
            });

            // é¼ æ ‡ç¦»å¼€é‡ç½®é«˜äº®
            ratingComponent?.addEventListener('mouseleave', () => {
                this.setActiveStars(this.currentRating);
            });
        }

        async handleAction(action, button) {
            switch (action) {
                case 'use':
                    await this.useInEditor();
                    break;
                case 'copy':
                    await this.copyPrompt();
                    break;
                case 'favorite':
                    await this.toggleFavorite();
                    break;
                case 'edit':
                    this.editPrompt();
                    break;
                case 'duplicate':
                    this.duplicatePrompt();
                    break;
                case 'delete':
                    this.deletePrompt();
                    break;
                case 'rate':
                    this.showRatingComponent();
                    break;
                case 'menu':
                    this.toggleDropdownMenu();
                    break;
            }
        }

        async useInEditor() {
            try {
                // è®°å½•ä½¿ç”¨æ¬¡æ•°
                await fetch(`/api/prompts/${this.promptId}/use`, {
                    method: 'POST'
                });

                // è·å–æç¤ºè¯å†…å®¹
                const promptContent = this.card.querySelector('.preview-text').textContent;
                
                // è·³è½¬åˆ°ç¼–è¾‘å™¨
                const editorUrl = `/editor?prompt=${encodeURIComponent(promptContent)}`;
                window.open(editorUrl, '_blank');

                // æ›´æ–°ä½¿ç”¨æ¬¡æ•°æ˜¾ç¤º
                const usageElement = this.card.querySelector('.meta-item.usage span');
                if (usageElement) {
                    const currentUsage = parseInt(usageElement.textContent) || 0;
                    usageElement.textContent = currentUsage + 1;
                }

                this.showNotification('æ­£åœ¨è·³è½¬åˆ°ç¼–è¾‘å™¨...', 'success');

            } catch (error) {
                console.error('ä½¿ç”¨æç¤ºè¯å¤±è´¥:', error);
                this.showNotification('è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        async copyPrompt() {
            try {
                const promptContent = this.card.querySelector('.preview-text').textContent;
                await navigator.clipboard.writeText(promptContent);
                this.showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                this.showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        async toggleFavorite() {
            try {
                const response = await fetch(`/api/prompts/${this.promptId}/favorite`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    this.isFavorited = result.data.isFavorite;
                    this.updateFavoriteButton();
                    this.showNotification(result.data.message, 'success');
                } else {
                    throw new Error(result.error?.message || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error);
                this.showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        async loadFavoriteStatus() {
            try {
                const response = await fetch(`/api/prompts/${this.promptId}/favorite`);
                const result = await response.json();

                if (result.success) {
                    this.isFavorited = result.data.isFavorite;
                    this.updateFavoriteButton();
                }
            } catch (error) {
                console.error('åŠ è½½æ”¶è—çŠ¶æ€å¤±è´¥:', error);
            }
        }

        updateFavoriteButton() {
            const favoriteButton = this.card.querySelector('.favorite-btn');
            if (favoriteButton) {
                if (this.isFavorited) {
                    favoriteButton.classList.add('favorited');
                } else {
                    favoriteButton.classList.remove('favorited');
                }
            }
        }

        editPrompt() {
            // è§¦å‘ç¼–è¾‘äº‹ä»¶
            const editEvent = new CustomEvent('editPrompt', {
                detail: { promptId: this.promptId }
            });
            document.dispatchEvent(editEvent);
        }

        duplicatePrompt() {
            // è§¦å‘å¤åˆ¶äº‹ä»¶
            const duplicateEvent = new CustomEvent('duplicatePrompt', {
                detail: { promptId: this.promptId }
            });
            document.dispatchEvent(duplicateEvent);
        }

        deletePrompt() {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                // è§¦å‘åˆ é™¤äº‹ä»¶
                const deleteEvent = new CustomEvent('deletePrompt', {
                    detail: { promptId: this.promptId }
                });
                document.dispatchEvent(deleteEvent);
            }
        }

        showRatingComponent() {
            const ratingComponent = this.card.querySelector('.rating-component');
            if (ratingComponent) {
                ratingComponent.style.display = 'flex';
            }
        }

        closeRatingComponent() {
            const ratingComponent = this.card.querySelector('.rating-component');
            if (ratingComponent) {
                ratingComponent.style.display = 'none';
            }
            this.currentRating = 0;
            this.setActiveStars(0);
        }

        highlightStars(count) {
            const stars = this.card.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < count) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        setActiveStars(count) {
            const stars = this.card.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                star.classList.remove('active');
                if (index < count) {
                    star.classList.add('active');
                }
            });
        }

        async submitRating() {
            if (this.currentRating === 0) {
                this.showNotification('è¯·é€‰æ‹©è¯„åˆ†', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/prompts/${this.promptId}/rating`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rating: this.currentRating
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // æ›´æ–°æ˜¾ç¤ºçš„è¯„åˆ†
                    const ratingElement = this.card.querySelector('.rating-value');
                    if (ratingElement) {
                        ratingElement.textContent = result.data.newRating;
                    }

                    // æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
                    const stars = this.card.querySelectorAll('.meta-item.rating .star');
                    stars.forEach((star, index) => {
                        if (index < Math.floor(result.data.newRating)) {
                            star.classList.remove('empty');
                            star.classList.add('filled');
                        } else {
                            star.classList.remove('filled');
                            star.classList.add('empty');
                        }
                    });

                    this.closeRatingComponent();
                    this.showNotification('è¯„åˆ†æäº¤æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.error?.message || 'è¯„åˆ†å¤±è´¥');
                }

            } catch (error) {
                console.error('æäº¤è¯„åˆ†å¤±è´¥:', error);
                this.showNotification('è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        toggleDropdownMenu() {
            const dropdownMenu = this.card.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                const isVisible = dropdownMenu.style.display !== 'none';
                dropdownMenu.style.display = isVisible ? 'none' : 'block';
            }
        }

        closeDropdownMenu() {
            const dropdownMenu = this.card.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.style.display = 'none';
            }
        }

        showNotification(message, type = 'info') {
            // è§¦å‘é€šçŸ¥äº‹ä»¶
            const notificationEvent = new CustomEvent('showNotification', {
                detail: { message, type }
            });
            document.dispatchEvent(notificationEvent);
        }
    }

    // åˆå§‹åŒ–æ‰€æœ‰æç¤ºè¯å¡ç‰‡
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.prompt-card');
        cards.forEach(card => {
            new PromptCard(card);
        });
    });
</script>