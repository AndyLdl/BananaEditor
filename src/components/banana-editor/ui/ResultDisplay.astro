---
// BananaEditorç»“æœå±•ç¤ºç»„ä»¶
// ä¸“é—¨ç”¨äºå±•ç¤ºAIç”Ÿæˆçš„å›¾ç‰‡ç»“æœå’Œç›¸å…³æ“ä½œ

export interface Props {
  id?: string;
  className?: string;
  showComparison?: boolean;
  showMetadata?: boolean;
  showActions?: boolean;
}

const { 
  id = "result-display",
  className = "",
  showComparison = true,
  showMetadata = true,
  showActions = true
} = Astro.props;
---

<div class={`banana-result-display ${className}`} id={id}>
  <!-- ç»“æœå¤´éƒ¨ -->
  <div class="result-header">
    <div class="header-content">
      <div class="header-icon">âœ¨</div>
      <div class="header-text">
        <h3 class="result-title">ç”Ÿæˆç»“æœ</h3>
        <p class="result-subtitle" id={`${id}-subtitle`}>AIåˆ›ä½œå®Œæˆ</p>
      </div>
      <div class="header-actions">
        <button class="header-btn" id={`${id}-fullscreen`} title="å…¨å±æŸ¥çœ‹">
          <span class="icon">â›¶</span>
        </button>
        <button class="header-btn" id={`${id}-close`} title="å…³é—­">
          <span class="icon">Ã—</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ç»“æœå†…å®¹åŒºåŸŸ -->
  <div class="result-content">
    <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
    <div class="image-display-area">
      {showComparison ? (
        <!-- å¯¹æ¯”æ¨¡å¼ -->
        <div class="comparison-view" id={`${id}-comparison`}>
          <div class="comparison-side original">
            <div class="side-label">åŸå›¾</div>
            <div class="image-container">
              <img id={`${id}-original-img`} alt="åŸå›¾" style="display: none;" />
              <div class="placeholder" id={`${id}-original-placeholder`}>
                <div class="placeholder-icon">ğŸ“·</div>
                <p>åŸå›¾</p>
              </div>
            </div>
          </div>
          
          <div class="comparison-divider">
            <div class="divider-icon">â†’</div>
          </div>
          
          <div class="comparison-side result">
            <div class="side-label">ç”Ÿæˆç»“æœ</div>
            <div class="image-container">
              <img id={`${id}-result-img`} alt="ç”Ÿæˆç»“æœ" style="display: none;" />
              <div class="placeholder" id={`${id}-result-placeholder`}>
                <div class="placeholder-icon">âœ¨</div>
                <p>ç”Ÿæˆç»“æœ</p>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <!-- å•å›¾æ¨¡å¼ -->
        <div class="single-view" id={`${id}-single`}>
          <div class="image-container">
            <img id={`${id}-single-img`} alt="ç”Ÿæˆç»“æœ" style="display: none;" />
            <div class="placeholder" id={`${id}-single-placeholder`}>
              <div class="placeholder-icon">ğŸ¨</div>
              <p>ç”Ÿæˆç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</div>  <!--
 å…ƒæ•°æ®å’Œæ“ä½œåŒºåŸŸ -->
  <div class="result-footer">
    {showMetadata && (
      <div class="metadata-section" id={`${id}-metadata`} style="display: none;">
        <div class="metadata-grid">
          <div class="metadata-item">
            <span class="metadata-label">å¤„ç†æ—¶é—´:</span>
            <span class="metadata-value" id={`${id}-processing-time`}>--</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">å›¾ç‰‡å°ºå¯¸:</span>
            <span class="metadata-value" id={`${id}-dimensions`}>--</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">æ–‡ä»¶å¤§å°:</span>
            <span class="metadata-value" id={`${id}-file-size`}>--</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">ä½¿ç”¨æ¨¡å‹:</span>
            <span class="metadata-value" id={`${id}-model`}>--</span>
          </div>
        </div>
      </div>
    )}

    {showActions && (
      <div class="actions-section">
        <div class="primary-actions">
          <button class="action-btn primary" id={`${id}-download`}>
            <span class="icon">ğŸ’¾</span>
            <span class="text">ä¸‹è½½å›¾ç‰‡</span>
          </button>
          <button class="action-btn secondary" id={`${id}-regenerate`}>
            <span class="icon">ğŸ”„</span>
            <span class="text">é‡æ–°ç”Ÿæˆ</span>
          </button>
        </div>
        
        <div class="secondary-actions">
          <button class="action-btn tertiary" id={`${id}-save-prompt`}>
            <span class="icon">ğŸ“</span>
            <span class="text">ä¿å­˜æç¤ºè¯</span>
          </button>
          <button class="action-btn tertiary" id={`${id}-share`}>
            <span class="icon">ğŸ”—</span>
            <span class="text">åˆ†äº«</span>
          </button>
          <button class="action-btn tertiary" id={`${id}-edit`}>
            <span class="icon">âœï¸</span>
            <span class="text">ç»§ç»­ç¼–è¾‘</span>
          </button>
        </div>
      </div>
    )}
  </div>

  <!-- åŠ è½½çŠ¶æ€è¦†ç›–å±‚ -->
  <div class="loading-overlay" id={`${id}-loading`} style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p class="loading-text">æ­£åœ¨å¤„ç†ç»“æœ...</p>
    </div>
  </div>
</div>

<style>
  .banana-result-display {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  /* ç»“æœå¤´éƒ¨ */
  .result-header {
    background: var(--banana-gradient, linear-gradient(135deg, #ffd700 0%, #ffa500 100%));
    padding: 16px 20px;
    border-bottom: 2px solid var(--banana-border, #ffe55c);
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-icon {
    font-size: 24px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .header-text {
    flex: 1;
  }

  .result-title {
    margin: 0 0 4px 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--banana-dark, #2d1810);
  }

  .result-subtitle {
    margin: 0;
    font-size: 12px;
    color: var(--banana-dark, #2d1810);
    opacity: 0.8;
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .header-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(45, 24, 16, 0.1);
    color: var(--banana-dark, #2d1810);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .header-btn:hover {
    background: rgba(45, 24, 16, 0.2);
    transform: scale(1.05);
  }

  /* ç»“æœå†…å®¹åŒºåŸŸ */
  .result-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .image-display-area {
    flex: 1;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* å¯¹æ¯”è§†å›¾ */
  .comparison-view {
    display: flex;
    align-items: center;
    gap: 24px;
    width: 100%;
    max-width: 800px;
  }

  .comparison-side {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .side-label {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
    padding: 8px 16px;
    background: rgba(255, 248, 220, 0.5);
    border-radius: 20px;
  }

  .image-container {
    position: relative;
    aspect-ratio: 1;
    border-radius: 12px;
    overflow: hidden;
    background: #fafafa;
    border: 2px solid #e5e7eb;
    transition: border-color 0.3s ease;
  }

  .image-container:hover {
    border-color: var(--banana-primary, #ffd700);
  }

  .image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .image-container:hover img {
    transform: scale(1.02);
  }

  .placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #999;
    text-align: center;
  }

  .placeholder-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.6;
  }

  .placeholder p {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
  }

  .comparison-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--banana-primary, #ffd700);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .divider-icon {
    font-size: 20px;
    font-weight: bold;
    color: var(--banana-dark, #2d1810);
  }

  /* å•å›¾è§†å›¾ */
  .single-view {
    width: 100%;
    max-width: 600px;
  }

  .single-view .image-container {
    aspect-ratio: 4/3;
  }

  /* ç»“æœåº•éƒ¨ */
  .result-footer {
    border-top: 1px solid #e5e7eb;
    background: #fafafa;
  }

  /* å…ƒæ•°æ®åŒºåŸŸ */
  .metadata-section {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
  }

  .metadata-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .metadata-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .metadata-label {
    font-size: 12px;
    color: #666;
    font-weight: 500;
  }

  .metadata-value {
    font-size: 14px;
    color: var(--banana-dark, #2d1810);
    font-weight: 600;
  }

  /* æ“ä½œåŒºåŸŸ */
  .actions-section {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .primary-actions,
  .secondary-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .action-btn.primary {
    background: var(--banana-gradient, linear-gradient(135deg, #ffd700 0%, #ffa500 100%));
    color: var(--banana-dark, #2d1810);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
  }

  .action-btn.secondary {
    background: white;
    color: var(--banana-dark, #2d1810);
    border: 2px solid var(--banana-primary, #ffd700);
  }

  .action-btn.secondary:hover {
    background: rgba(255, 248, 220, 0.5);
    transform: translateY(-1px);
  }

  .action-btn.tertiary {
    background: transparent;
    color: #666;
    border: 1px solid #e5e7eb;
  }

  .action-btn.tertiary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    color: var(--banana-dark, #2d1810);
  }

  .action-btn .icon {
    font-size: 16px;
  }

  /* åŠ è½½çŠ¶æ€ */
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    z-index: 10;
  }

  .loading-content {
    text-align: center;
    padding: 20px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f0f0f0;
    border-top: 4px solid var(--banana-primary, #ffd700);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    margin: 0;
    color: #666;
    font-size: 14px;
    font-weight: 500;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .comparison-view {
      flex-direction: column;
      gap: 16px;
    }

    .comparison-divider {
      transform: rotate(90deg);
    }

    .metadata-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .primary-actions,
    .secondary-actions {
      flex-direction: column;
    }

    .action-btn {
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .image-display-area {
      padding: 12px;
    }

    .result-header {
      padding: 12px 16px;
    }

    .actions-section {
      padding: 16px;
    }

    .metadata-grid {
      grid-template-columns: 1fr;
    }

    .placeholder-icon {
      font-size: 36px;
    }
  }

  /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
  @media (prefers-contrast: high) {
    .image-container {
      border-color: #000;
    }

    .action-btn.tertiary {
      border-color: #000;
    }
  }

  /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
  @media (prefers-reduced-motion: reduce) {
    * {
      transition: none !important;
      animation: none !important;
    }
  }
</style><scri
pt>
  // BananaEditorç»“æœå±•ç¤ºå™¨
  class BananaResultDisplay {
    private displayId: string;
    private container: HTMLElement | null = null;
    private showComparison: boolean = true;
    private currentResult: any = null;
    private isFullscreen: boolean = false;

    constructor(displayId: string) {
      this.displayId = displayId;
      this.container = document.getElementById(displayId);
      this.showComparison = this.container?.querySelector('.comparison-view') !== null;
      
      this.init();
    }

    private init(): void {
      this.setupEventListeners();
      this.setupKeyboardShortcuts();
    }

    private setupEventListeners(): void {
      // å¤´éƒ¨æŒ‰é’®äº‹ä»¶
      const fullscreenBtn = document.getElementById(`${this.displayId}-fullscreen`);
      const closeBtn = document.getElementById(`${this.displayId}-close`);

      fullscreenBtn?.addEventListener('click', () => this.toggleFullscreen());
      closeBtn?.addEventListener('click', () => this.close());

      // æ“ä½œæŒ‰é’®äº‹ä»¶
      const downloadBtn = document.getElementById(`${this.displayId}-download`);
      const regenerateBtn = document.getElementById(`${this.displayId}-regenerate`);
      const savePromptBtn = document.getElementById(`${this.displayId}-save-prompt`);
      const shareBtn = document.getElementById(`${this.displayId}-share`);
      const editBtn = document.getElementById(`${this.displayId}-edit`);

      downloadBtn?.addEventListener('click', () => this.downloadResult());
      regenerateBtn?.addEventListener('click', () => this.regenerateImage());
      savePromptBtn?.addEventListener('click', () => this.savePrompt());
      shareBtn?.addEventListener('click', () => this.shareResult());
      editBtn?.addEventListener('click', () => this.editResult());

      // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¾å¤§æŸ¥çœ‹ï¼‰
      const images = this.container?.querySelectorAll('img');
      images?.forEach(img => {
        img.addEventListener('click', () => this.showImageModal(img.src));
      });
    }

    private setupKeyboardShortcuts(): void {
      document.addEventListener('keydown', (e) => {
        if (!this.container || this.container.style.display === 'none') return;

        switch (e.key) {
          case 'Escape':
            if (this.isFullscreen) {
              this.toggleFullscreen();
            } else {
              this.close();
            }
            break;
          case 'f':
          case 'F':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              this.toggleFullscreen();
            }
            break;
          case 'd':
          case 'D':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              this.downloadResult();
            }
            break;
          case 'r':
          case 'R':
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              this.regenerateImage();
            }
            break;
        }
      });
    }

    // æ˜¾ç¤ºç”Ÿæˆç»“æœ
    public showResult(result: any): void {
      this.currentResult = result;
      this.showLoading();

      // æ›´æ–°æ ‡é¢˜
      const subtitle = document.getElementById(`${this.displayId}-subtitle`);
      if (subtitle) {
        subtitle.textContent = 'ç”Ÿæˆå®Œæˆ';
      }

      // æ˜¾ç¤ºå›¾ç‰‡
      if (this.showComparison && result.originalImage) {
        this.showComparisonImages(result.originalImage, result.imageUrl);
      } else {
        this.showSingleImage(result.imageUrl);
      }

      // æ˜¾ç¤ºå…ƒæ•°æ®
      this.showMetadata(result.metadata);

      // æ˜¾ç¤ºå®¹å™¨
      if (this.container) {
        this.container.style.display = 'flex';
      }

      this.hideLoading();
    }

    private showComparisonImages(originalUrl: string, resultUrl: string): void {
      // æ˜¾ç¤ºåŸå›¾
      const originalImg = document.getElementById(`${this.displayId}-original-img`) as HTMLImageElement;
      const originalPlaceholder = document.getElementById(`${this.displayId}-original-placeholder`);

      if (originalImg && originalPlaceholder) {
        originalImg.src = originalUrl;
        originalImg.style.display = 'block';
        originalPlaceholder.style.display = 'none';
      }

      // æ˜¾ç¤ºç»“æœå›¾
      const resultImg = document.getElementById(`${this.displayId}-result-img`) as HTMLImageElement;
      const resultPlaceholder = document.getElementById(`${this.displayId}-result-placeholder`);

      if (resultImg && resultPlaceholder) {
        resultImg.src = resultUrl;
        resultImg.style.display = 'block';
        resultPlaceholder.style.display = 'none';
      }
    }

    private showSingleImage(imageUrl: string): void {
      const singleImg = document.getElementById(`${this.displayId}-single-img`) as HTMLImageElement;
      const singlePlaceholder = document.getElementById(`${this.displayId}-single-placeholder`);

      if (singleImg && singlePlaceholder) {
        singleImg.src = imageUrl;
        singleImg.style.display = 'block';
        singlePlaceholder.style.display = 'none';
      }
    }

    private showMetadata(metadata: any): void {
      const metadataSection = document.getElementById(`${this.displayId}-metadata`);
      if (metadataSection) {
        metadataSection.style.display = 'block';
      }

      // æ›´æ–°å„ä¸ªå…ƒæ•°æ®å­—æ®µ
      const processingTime = document.getElementById(`${this.displayId}-processing-time`);
      const dimensions = document.getElementById(`${this.displayId}-dimensions`);
      const fileSize = document.getElementById(`${this.displayId}-file-size`);
      const model = document.getElementById(`${this.displayId}-model`);

      if (processingTime && metadata.processingTime) {
        processingTime.textContent = `${(metadata.processingTime / 1000).toFixed(1)}ç§’`;
      }

      if (dimensions && metadata.dimensions) {
        dimensions.textContent = `${metadata.dimensions.width} Ã— ${metadata.dimensions.height}`;
      }

      if (fileSize && metadata.fileSize) {
        const sizeInMB = (metadata.fileSize / (1024 * 1024)).toFixed(2);
        fileSize.textContent = `${sizeInMB} MB`;
      }

      if (model && metadata.model) {
        model.textContent = metadata.model;
      }
    }

    // æ“ä½œæ–¹æ³•
    private downloadResult(): void {
      if (!this.currentResult) return;

      const link = document.createElement('a');
      link.href = this.currentResult.imageUrl;
      link.download = `banana-editor-result-${Date.now()}.${this.currentResult.metadata.format || 'jpg'}`;
      link.click();

      // æ˜¾ç¤ºä¸‹è½½æç¤º
      this.showNotification('å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹', 'success');
    }

    private regenerateImage(): void {
      // å‘é€é‡æ–°ç”Ÿæˆäº‹ä»¶
      document.dispatchEvent(new CustomEvent('banana-editor:regenerate-request', {
        detail: {
          displayId: this.displayId,
          originalPrompt: this.currentResult?.generatedPrompt
        }
      }));

      this.showNotification('æ­£åœ¨é‡æ–°ç”Ÿæˆ...', 'info');
    }

    private savePrompt(): void {
      if (!this.currentResult?.generatedPrompt) return;

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(this.currentResult.generatedPrompt).then(() => {
        this.showNotification('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      }).catch(() => {
        // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºæç¤ºè¯æ–‡æœ¬
        this.showPromptModal(this.currentResult.generatedPrompt);
      });
    }

    private shareResult(): void {
      if (!this.currentResult) return;

      const shareData = {
        title: 'BananaEditor AIç”Ÿæˆç»“æœ',
        text: 'æŸ¥çœ‹æˆ‘ç”¨nano banana AIåˆ›ä½œçš„å›¾ç‰‡',
        url: window.location.href
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        // é™çº§æ–¹æ¡ˆï¼šå¤åˆ¶é“¾æ¥
        navigator.clipboard.writeText(window.location.href).then(() => {
          this.showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        });
      }
    }

    private editResult(): void {
      // å‘é€ç¼–è¾‘è¯·æ±‚äº‹ä»¶
      document.dispatchEvent(new CustomEvent('banana-editor:edit-request', {
        detail: {
          displayId: this.displayId,
          result: this.currentResult
        }
      }));
    }

    private toggleFullscreen(): void {
      if (!this.container) return;

      this.isFullscreen = !this.isFullscreen;

      if (this.isFullscreen) {
        this.container.classList.add('fullscreen');
        document.body.style.overflow = 'hidden';
      } else {
        this.container.classList.remove('fullscreen');
        document.body.style.overflow = '';
      }

      // æ›´æ–°æŒ‰é’®å›¾æ ‡
      const fullscreenBtn = document.getElementById(`${this.displayId}-fullscreen`);
      if (fullscreenBtn) {
        const icon = fullscreenBtn.querySelector('.icon');
        if (icon) {
          icon.textContent = this.isFullscreen ? 'â›¶' : 'â›¶';
        }
      }
    }

    private close(): void {
      if (this.container) {
        this.container.style.display = 'none';
      }

      if (this.isFullscreen) {
        this.isFullscreen = false;
        document.body.style.overflow = '';
      }

      // å‘é€å…³é—­äº‹ä»¶
      document.dispatchEvent(new CustomEvent('banana-editor:result-closed', {
        detail: { displayId: this.displayId }
      }));
    }

    private showImageModal(imageSrc: string): void {
      // åˆ›å»ºå›¾ç‰‡æ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.className = 'image-modal';
      modal.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal-content">
            <img src="${imageSrc}" alt="æŸ¥çœ‹å¤§å›¾" />
            <button class="modal-close">Ã—</button>
          </div>
        </div>
      `;

      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        .image-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .modal-backdrop {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }
        .modal-content {
          position: relative;
          max-width: 90vw;
          max-height: 90vh;
        }
        .modal-content img {
          max-width: 100%;
          max-height: 100%;
          object-fit: contain;
          border-radius: 8px;
        }
        .modal-close {
          position: absolute;
          top: -40px;
          right: 0;
          width: 32px;
          height: 32px;
          border: none;
          background: rgba(255, 255, 255, 0.9);
          color: #000;
          border-radius: 50%;
          cursor: pointer;
          font-size: 18px;
          font-weight: bold;
        }
      `;

      document.head.appendChild(style);
      document.body.appendChild(modal);

      // ç»‘å®šå…³é—­äº‹ä»¶
      const closeModal = () => {
        document.body.removeChild(modal);
        document.head.removeChild(style);
      };

      modal.querySelector('.modal-close')?.addEventListener('click', closeModal);
      modal.querySelector('.modal-backdrop')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          closeModal();
        }
      });

      // ESCé”®å…³é—­
      const handleEsc = (e: KeyboardEvent) => {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', handleEsc);
        }
      };
      document.addEventListener('keydown', handleEsc);
    }

    private showPromptModal(prompt: string): void {
      // æ˜¾ç¤ºæç¤ºè¯æ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.className = 'prompt-modal';
      modal.innerHTML = `
        <div class="modal-backdrop">
          <div class="modal-content">
            <h3>ç”Ÿæˆæç¤ºè¯</h3>
            <textarea readonly>${prompt}</textarea>
            <div class="modal-actions">
              <button class="copy-btn">å¤åˆ¶</button>
              <button class="close-btn">å…³é—­</button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // ç»‘å®šäº‹ä»¶
      const closeModal = () => document.body.removeChild(modal);
      
      modal.querySelector('.close-btn')?.addEventListener('click', closeModal);
      modal.querySelector('.copy-btn')?.addEventListener('click', () => {
        const textarea = modal.querySelector('textarea') as HTMLTextAreaElement;
        textarea.select();
        document.execCommand('copy');
        this.showNotification('æç¤ºè¯å·²å¤åˆ¶', 'success');
        closeModal();
      });
    }

    private showNotification(message: string, type: 'success' | 'error' | 'info' = 'info'): void {
      // åˆ›å»ºé€šçŸ¥å…ƒç´ 
      const notification = document.createElement('div');
      notification.className = `banana-notification ${type}`;
      notification.textContent = message;

      // æ·»åŠ æ ·å¼
      Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '12px 20px',
        borderRadius: '8px',
        color: 'white',
        fontWeight: '500',
        zIndex: '1001',
        transform: 'translateX(100%)',
        transition: 'transform 0.3s ease'
      });

      // è®¾ç½®èƒŒæ™¯è‰²
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
      };
      notification.style.background = colors[type];

      document.body.appendChild(notification);

      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);

      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // çŠ¶æ€ç®¡ç†æ–¹æ³•
    private showLoading(): void {
      const loading = document.getElementById(`${this.displayId}-loading`);
      if (loading) {
        loading.style.display = 'flex';
      }
    }

    private hideLoading(): void {
      const loading = document.getElementById(`${this.displayId}-loading`);
      if (loading) {
        loading.style.display = 'none';
      }
    }

    // å…¬å…±æ–¹æ³•
    public reset(): void {
      // éšè—æ‰€æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå ä½ç¬¦
      const images = this.container?.querySelectorAll('img');
      const placeholders = this.container?.querySelectorAll('.placeholder');

      images?.forEach(img => {
        img.style.display = 'none';
        (img as HTMLImageElement).src = '';
      });

      placeholders?.forEach(placeholder => {
        (placeholder as HTMLElement).style.display = 'flex';
      });

      // éšè—å…ƒæ•°æ®
      const metadataSection = document.getElementById(`${this.displayId}-metadata`);
      if (metadataSection) {
        metadataSection.style.display = 'none';
      }

      // é‡ç½®çŠ¶æ€
      this.currentResult = null;
      this.hideLoading();

      // æ›´æ–°æ ‡é¢˜
      const subtitle = document.getElementById(`${this.displayId}-subtitle`);
      if (subtitle) {
        subtitle.textContent = 'ç­‰å¾…ç”Ÿæˆç»“æœ';
      }
    }

    public show(): void {
      if (this.container) {
        this.container.style.display = 'flex';
      }
    }

    public hide(): void {
      if (this.container) {
        this.container.style.display = 'none';
      }
    }
  }

  // è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰ç»“æœå±•ç¤ºå™¨
  document.addEventListener('DOMContentLoaded', () => {
    const displays = document.querySelectorAll('.banana-result-display');
    
    displays.forEach(display => {
      const displayId = display.id;
      if (displayId) {
        new BananaResultDisplay(displayId);
      }
    });
  });

  // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
  (window as any).BananaResultDisplay = BananaResultDisplay;
</script>