---
// MobileControlPanel.astro - ç§»åŠ¨ç«¯ä¸“ç”¨æ§åˆ¶é¢æ¿
// æä¾›è§¦æ‘¸å‹å¥½çš„ç¼–è¾‘å™¨æ§åˆ¶ç•Œé¢

export interface Props {
  currentMode?: "generate" | "fusion";
  isVisible?: boolean;
  panelType?: "sidebar" | "properties" | "tools";
}

const {
  currentMode = "generate",
  isVisible = false,
  panelType = "sidebar",
} = Astro.props;
---

<div class={`mobile-control-panel ${panelType}-panel ${isVisible ? "visible" : ""}`} id={`mobile-${panelType}-panel`}>
  <!-- é¢æ¿å¤´éƒ¨ -->
  <div class="panel-header">
    <div class="panel-title">
      {panelType === "sidebar" && "å·¥å…·é¢æ¿"}
      {panelType === "properties" && "å‚æ•°è®¾ç½®"}
      {panelType === "tools" && "ç¼–è¾‘å·¥å…·"}
    </div>
    <button class="panel-close" id={`close-${panelType}-panel`} aria-label="å…³é—­é¢æ¿">
      <span class="close-icon">âœ•</span>
    </button>
  </div>

  <!-- é¢æ¿å†…å®¹ -->
  <div class="panel-content">
    {panelType === "sidebar" && (
      <div class="sidebar-mobile-content">
        <!-- åŠŸèƒ½é€‰æ‹©å™¨ -->
        <div class="mobile-section">
          <h3 class="section-title">ç¼–è¾‘æ¨¡å¼</h3>
          <div class="mode-selector-mobile">
            <button class={`mode-btn-mobile ${currentMode === "generate" ? "active" : ""}`} data-mode="generate">
              <div class="mode-icon-mobile">âœ¨</div>
              <div class="mode-info-mobile">
                <span class="mode-name">AIç”Ÿæˆ</span>
                <span class="mode-desc">ä»æ–‡å­—ç”Ÿæˆå›¾ç‰‡</span>
              </div>
            </button>
            <button class={`mode-btn-mobile ${currentMode === "fusion" ? "active" : ""}`} data-mode="fusion">
              <div class="mode-icon-mobile">ğŸ”„</div>
              <div class="mode-info-mobile">
                <span class="mode-name">å›¾ç‰‡èåˆ</span>
                <span class="mode-desc">æ™ºèƒ½èåˆä¸¤å¼ å›¾ç‰‡</span>
              </div>
            </button>
          </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="mobile-section">
          <h3 class="section-title">å¿«é€Ÿæ“ä½œ</h3>
          <div class="quick-actions-mobile">
            <button class="action-btn-mobile" id="mobile-upload">
              <span class="action-icon">ğŸ“</span>
              <span class="action-label">ä¸Šä¼ å›¾ç‰‡</span>
            </button>
            <button class="action-btn-mobile" id="mobile-prompts">
              <span class="action-icon">ğŸ“‹</span>
              <span class="action-label">æç¤ºè¯åº“</span>
            </button>
            <button class="action-btn-mobile" id="mobile-reset">
              <span class="action-icon">ğŸ”„</span>
              <span class="action-label">é‡ç½®ç”»å¸ƒ</span>
            </button>
            <button class="action-btn-mobile" id="mobile-help">
              <span class="action-icon">â“</span>
              <span class="action-label">å¸®åŠ©</span>
            </button>
          </div>
        </div>

        <!-- å†å²è®°å½• -->
        <div class="mobile-section">
          <h3 class="section-title">æœ€è¿‘æ“ä½œ</h3>
          <div class="history-mobile" id="mobile-history">
            <div class="history-item-mobile">
              <div class="history-preview-mobile"></div>
              <div class="history-info-mobile">
                <span class="history-action">AIç”Ÿæˆ</span>
                <span class="history-time">åˆšåˆš</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    )}

    {panelType === "properties" && (
      <div class="properties-mobile-content">
        <!-- æç¤ºè¯è¾“å…¥ -->
        <div class="mobile-section">
          <h3 class="section-title">æç¤ºè¯</h3>
          <div class="prompt-input-mobile">
            <textarea
              class="prompt-textarea-mobile"
              id="mobile-prompt-textarea"
              placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡..."
              rows="4"
            ></textarea>
            <div class="prompt-actions-mobile">
              <button class="prompt-btn-mobile optimize-btn-mobile">
                <span class="btn-icon">ğŸš€</span>
                <span class="btn-label">ä¼˜åŒ–</span>
              </button>
              <button class="prompt-btn-mobile clear-btn-mobile">
                <span class="btn-icon">ğŸ—‘ï¸</span>
                <span class="btn-label">æ¸…ç©º</span>
              </button>
            </div>
          </div>
        </div>

        <!-- å‚æ•°è®¾ç½® -->
        <div class="mobile-section">
          <h3 class="section-title">ç”Ÿæˆå‚æ•°</h3>
          <div class="parameters-mobile">
            <div class="parameter-item-mobile">
              <label class="parameter-label-mobile">
                <span class="label-text">å›¾ç‰‡å°ºå¯¸</span>
                <select class="parameter-select-mobile" id="mobile-size-select">
                  <option value="512x512">512Ã—512</option>
                  <option value="768x768">768Ã—768</option>
                  <option value="1024x1024" selected>1024Ã—1024</option>
                </select>
              </label>
            </div>
            
            <div class="parameter-item-mobile">
              <label class="parameter-label-mobile">
                <span class="label-text">ç”Ÿæˆè´¨é‡</span>
                <select class="parameter-select-mobile" id="mobile-quality-select">
                  <option value="standard">æ ‡å‡†</option>
                  <option value="high" selected>é«˜è´¨é‡</option>
                </select>
              </label>
            </div>

            <div class="parameter-item-mobile">
              <label class="parameter-label-mobile">
                <span class="label-text">é£æ ¼å¼ºåº¦</span>
                <input 
                  type="range" 
                  class="parameter-range-mobile" 
                  id="mobile-style-strength"
                  min="0" 
                  max="100" 
                  value="50"
                />
                <span class="range-value" id="style-strength-value">50%</span>
              </label>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="mobile-section">
          <div class="action-buttons-mobile">
            <button class="primary-btn-mobile" id="mobile-generate-btn">
              <span class="btn-icon">âœ¨</span>
              <span class="btn-label">å¼€å§‹ç”Ÿæˆ</span>
            </button>
            <button class="secondary-btn-mobile" id="mobile-save-settings">
              <span class="btn-icon">ğŸ’¾</span>
              <span class="btn-label">ä¿å­˜è®¾ç½®</span>
            </button>
          </div>
        </div>
      </div>
    )}

    {panelType === "tools" && (
      <div class="tools-mobile-content">
        <!-- ç”»å¸ƒå·¥å…· -->
        <div class="mobile-section">
          <h3 class="section-title">ç”»å¸ƒå·¥å…·</h3>
          <div class="canvas-tools-mobile">
            <div class="tool-group-mobile">
              <span class="tool-group-label">ç¼©æ”¾</span>
              <div class="zoom-controls-mobile">
                <button class="tool-btn-mobile" id="mobile-zoom-out">
                  <span class="tool-icon">-</span>
                </button>
                <span class="zoom-display-mobile" id="mobile-zoom-display">100%</span>
                <button class="tool-btn-mobile" id="mobile-zoom-in">
                  <span class="tool-icon">+</span>
                </button>
              </div>
            </div>

            <div class="tool-group-mobile">
              <span class="tool-group-label">è§†å›¾</span>
              <div class="view-controls-mobile">
                <button class="tool-btn-mobile" id="mobile-fit-window">
                  <span class="tool-icon">âŠ</span>
                  <span class="tool-label">é€‚åº”</span>
                </button>
                <button class="tool-btn-mobile" id="mobile-actual-size">
                  <span class="tool-icon">1:1</span>
                  <span class="tool-label">å®é™…</span>
                </button>
              </div>
            </div>

            <div class="tool-group-mobile">
              <span class="tool-group-label">æ“ä½œ</span>
              <div class="action-controls-mobile">
                <button class="tool-btn-mobile" id="mobile-undo">
                  <span class="tool-icon">â†¶</span>
                  <span class="tool-label">æ’¤é”€</span>
                </button>
                <button class="tool-btn-mobile" id="mobile-redo">
                  <span class="tool-icon">â†·</span>
                  <span class="tool-label">é‡åš</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- å¯¼å‡ºé€‰é¡¹ -->
        <div class="mobile-section">
          <h3 class="section-title">å¯¼å‡º</h3>
          <div class="export-options-mobile">
            <button class="export-btn-mobile" data-format="png">
              <span class="export-icon">ğŸ–¼ï¸</span>
              <div class="export-info">
                <span class="export-format">PNG</span>
                <span class="export-desc">é«˜è´¨é‡é€æ˜èƒŒæ™¯</span>
              </div>
            </button>
            <button class="export-btn-mobile" data-format="jpg">
              <span class="export-icon">ğŸ“·</span>
              <div class="export-info">
                <span class="export-format">JPG</span>
                <span class="export-desc">æ ‡å‡†å›¾ç‰‡æ ¼å¼</span>
              </div>
            </button>
            <button class="export-btn-mobile" data-format="webp">
              <span class="export-icon">ğŸŒ</span>
              <div class="export-info">
                <span class="export-format">WebP</span>
                <span class="export-desc">ç°ä»£å‹ç¼©æ ¼å¼</span>
              </div>
            </button>
          </div>
        </div>
      </div>
    )}
  </div>

  <!-- é¢æ¿åº•éƒ¨ -->
  <div class="panel-footer">
    <div class="panel-drag-handle"></div>
  </div>
</div>

<style>
  /* ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿åŸºç¡€æ ·å¼ */
  .mobile-control-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }

  .mobile-control-panel.visible {
    transform: translateY(0);
  }

  /* é¢æ¿å¤´éƒ¨ */
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px 12px;
    border-bottom: 1px solid #f0f0f0;
    flex-shrink: 0;
  }

  .panel-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .panel-close {
    width: 32px;
    height: 32px;
    border: none;
    background: #f5f5f5;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .panel-close:hover {
    background: #e5e5e5;
  }

  .close-icon {
    font-size: 16px;
    color: #666;
  }

  /* é¢æ¿å†…å®¹ */
  .panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
  }

  .mobile-section {
    margin-bottom: 24px;
  }

  .section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f0f0;
  }

  /* æ¨¡å¼é€‰æ‹©å™¨ */
  .mode-selector-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .mode-btn-mobile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 2px solid #e0e0e0;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
  }

  .mode-btn-mobile.active {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 215, 0, 0.1);
  }

  .mode-btn-mobile:active {
    transform: scale(0.98);
  }

  .mode-icon-mobile {
    font-size: 24px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--banana-light, #fff8dc);
    border-radius: 12px;
  }

  .mode-info-mobile {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .mode-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .mode-desc {
    font-size: 14px;
    color: #666;
  }

  /* å¿«é€Ÿæ“ä½œ */
  .quick-actions-mobile {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .action-btn-mobile {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    border: 1px solid #e0e0e0;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .action-btn-mobile:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 215, 0, 0.05);
  }

  .action-btn-mobile:active {
    transform: scale(0.95);
  }

  .action-icon {
    font-size: 24px;
  }

  .action-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
  }

  /* å†å²è®°å½• */
  .history-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
  }

  .history-item-mobile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .history-item-mobile:hover {
    background: rgba(255, 215, 0, 0.05);
  }

  .history-preview-mobile {
    width: 40px;
    height: 40px;
    background: #f0f0f0;
    border-radius: 6px;
    flex-shrink: 0;
  }

  .history-info-mobile {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .history-action {
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
  }

  .history-time {
    font-size: 12px;
    color: #666;
  }

  /* æç¤ºè¯è¾“å…¥ */
  .prompt-input-mobile {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .prompt-textarea-mobile {
    width: 100%;
    padding: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    resize: vertical;
    font-family: inherit;
    font-size: 16px;
    line-height: 1.5;
    transition: border-color 0.2s ease;
    min-height: 100px;
  }

  .prompt-textarea-mobile:focus {
    border-color: var(--banana-primary, #ffd700);
    outline: none;
  }

  .prompt-actions-mobile {
    display: flex;
    gap: 8px;
  }

  .prompt-btn-mobile {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 12px 16px;
    border: 1px solid var(--banana-primary, #ffd700);
    background: transparent;
    color: var(--banana-dark, #2d1810);
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    flex: 1;
    justify-content: center;
  }

  .optimize-btn-mobile {
    background: var(--banana-gradient, linear-gradient(135deg, #ffd700 0%, #ffa500 100%));
  }

  .prompt-btn-mobile:hover {
    background: var(--banana-primary, #ffd700);
  }

  .prompt-btn-mobile:active {
    transform: scale(0.98);
  }

  /* å‚æ•°è®¾ç½® */
  .parameters-mobile {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .parameter-item-mobile {
    display: flex;
    flex-direction: column;
  }

  .parameter-label-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .label-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
  }

  .parameter-select-mobile {
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    font-size: 16px;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .parameter-select-mobile:focus {
    border-color: var(--banana-primary, #ffd700);
    outline: none;
  }

  .parameter-range-mobile {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e0e0e0;
    outline: none;
    -webkit-appearance: none;
  }

  .parameter-range-mobile::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--banana-primary, #ffd700);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .parameter-range-mobile::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--banana-primary, #ffd700);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .range-value {
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
    text-align: center;
    margin-top: 4px;
  }

  /* æ“ä½œæŒ‰é’® */
  .action-buttons-mobile {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .primary-btn-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 24px;
    border: none;
    background: var(--banana-gradient, linear-gradient(135deg, #ffd700 0%, #ffa500 100%));
    color: var(--banana-dark, #2d1810);
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .primary-btn-mobile:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
  }

  .primary-btn-mobile:active {
    transform: translateY(0);
  }

  .secondary-btn-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 24px;
    border: 2px solid var(--banana-primary, #ffd700);
    background: transparent;
    color: var(--banana-dark, #2d1810);
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .secondary-btn-mobile:hover {
    background: rgba(255, 215, 0, 0.1);
  }

  .secondary-btn-mobile:active {
    transform: scale(0.98);
  }

  /* ç”»å¸ƒå·¥å…· */
  .canvas-tools-mobile {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .tool-group-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .tool-group-label {
    font-size: 14px;
    font-weight: 500;
    color: #666;
  }

  .zoom-controls-mobile {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
  }

  .tool-btn-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 12px 16px;
    border: 1px solid #e0e0e0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    min-width: 48px;
  }

  .tool-btn-mobile:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 215, 0, 0.1);
  }

  .tool-btn-mobile:active {
    transform: scale(0.95);
  }

  .zoom-display-mobile {
    font-size: 16px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
    min-width: 60px;
    text-align: center;
  }

  .view-controls-mobile,
  .action-controls-mobile {
    display: flex;
    gap: 8px;
  }

  .tool-icon {
    font-size: 16px;
  }

  .tool-label {
    font-size: 12px;
  }

  /* å¯¼å‡ºé€‰é¡¹ */
  .export-options-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .export-btn-mobile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 1px solid #e0e0e0;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
  }

  .export-btn-mobile:hover {
    border-color: var(--banana-primary, #ffd700);
    background: rgba(255, 215, 0, 0.05);
  }

  .export-btn-mobile:active {
    transform: scale(0.98);
  }

  .export-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
  }

  .export-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .export-format {
    font-size: 16px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .export-desc {
    font-size: 14px;
    color: #666;
  }

  /* é¢æ¿åº•éƒ¨ */
  .panel-footer {
    display: flex;
    justify-content: center;
    padding: 8px;
    border-top: 1px solid #f0f0f0;
    flex-shrink: 0;
  }

  .panel-drag-handle {
    width: 40px;
    height: 4px;
    background: #ddd;
    border-radius: 2px;
  }

  /* æ»šåŠ¨æ¡æ ·å¼ */
  .panel-content::-webkit-scrollbar {
    width: 4px;
  }

  .panel-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
  }

  .panel-content::-webkit-scrollbar-thumb {
    background: var(--banana-secondary, #ffa500);
    border-radius: 2px;
  }

  .panel-content::-webkit-scrollbar-thumb:hover {
    background: var(--banana-primary, #ffd700);
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 480px) {
    .panel-header {
      padding: 12px 16px 8px;
    }

    .panel-content {
      padding: 0 16px 16px;
    }

    .panel-title {
      font-size: 16px;
    }

    .quick-actions-mobile {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .action-btn-mobile {
      padding: 12px 8px;
    }

    .action-label {
      font-size: 12px;
    }
  }

  /* é«˜å¯¹æ¯”åº¦æ¨¡å¼ */
  @media (prefers-contrast: high) {
    .mobile-control-panel {
      border: 2px solid #000;
    }

    .mode-btn-mobile.active {
      border-color: #000;
      background: #fff;
    }

    .primary-btn-mobile {
      background: #000;
      color: #fff;
    }
  }

  /* å‡å°‘åŠ¨ç”» */
  @media (prefers-reduced-motion: reduce) {
    .mobile-control-panel {
      transition: none;
    }

    .mode-btn-mobile,
    .action-btn-mobile,
    .tool-btn-mobile,
    .export-btn-mobile {
      transition: none;
    }
  }
</style>

<script>
  // ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿äº¤äº’é€»è¾‘
  class MobileControlPanel {
    private panel: HTMLElement | null = null;
    private closeButton: HTMLElement | null = null;
    private panelType: string = '';
    private isVisible: boolean = false;

    constructor(panelType: string) {
      this.panelType = panelType;
      this.init();
    }

    private init(): void {
      this.panel = document.getElementById(`mobile-${this.panelType}-panel`);
      this.closeButton = document.getElementById(`close-${this.panelType}-panel`);
      
      this.setupEventListeners();
    }

    private setupEventListeners(): void {
      // å…³é—­æŒ‰é’®
      this.closeButton?.addEventListener('click', () => {
        this.hide();
      });

      // æ‹–æ‹½æ‰‹åŠ¿å…³é—­
      this.setupDragToClose();

      // æ ¹æ®é¢æ¿ç±»å‹è®¾ç½®ç‰¹å®šäº‹ä»¶
      if (this.panelType === 'sidebar') {
        this.setupSidebarEvents();
      } else if (this.panelType === 'properties') {
        this.setupPropertiesEvents();
      } else if (this.panelType === 'tools') {
        this.setupToolsEvents();
      }

      // ç›‘å¬å…¨å±€äº‹ä»¶
      document.addEventListener(`show-mobile-${this.panelType}`, () => {
        this.show();
      });

      document.addEventListener(`hide-mobile-${this.panelType}`, () => {
        this.hide();
      });
    }

    private setupDragToClose(): void {
      if (!this.panel) return;

      let startY = 0;
      let currentY = 0;
      let isDragging = false;

      const dragHandle = this.panel.querySelector('.panel-drag-handle');
      
      const handleStart = (e: TouchEvent | MouseEvent) => {
        const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;
        startY = clientY;
        isDragging = true;
        this.panel!.style.transition = 'none';
      };

      const handleMove = (e: TouchEvent | MouseEvent) => {
        if (!isDragging) return;
        
        const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;
        currentY = clientY - startY;
        
        if (currentY > 0) {
          this.panel!.style.transform = `translateY(${currentY}px)`;
        }
      };

      const handleEnd = () => {
        if (!isDragging) return;
        
        isDragging = false;
        this.panel!.style.transition = '';
        
        if (currentY > 100) {
          this.hide();
        } else {
          this.panel!.style.transform = 'translateY(0)';
        }
        
        currentY = 0;
      };

      // è§¦æ‘¸äº‹ä»¶
      dragHandle?.addEventListener('touchstart', handleStart, { passive: true });
      document.addEventListener('touchmove', handleMove, { passive: true });
      document.addEventListener('touchend', handleEnd, { passive: true });

      // é¼ æ ‡äº‹ä»¶
      dragHandle?.addEventListener('mousedown', handleStart);
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', handleEnd);
    }

    private setupSidebarEvents(): void {
      // æ¨¡å¼åˆ‡æ¢
      const modeButtons = this.panel?.querySelectorAll('.mode-btn-mobile');
      modeButtons?.forEach(button => {
        button.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const mode = target.dataset.mode;
          
          modeButtons.forEach(btn => btn.classList.remove('active'));
          target.classList.add('active');
          
          document.dispatchEvent(new CustomEvent('editor:mode-change', {
            detail: { mode }
          }));
        });
      });

      // å¿«é€Ÿæ“ä½œ
      const uploadBtn = document.getElementById('mobile-upload');
      const promptsBtn = document.getElementById('mobile-prompts');
      const resetBtn = document.getElementById('mobile-reset');
      const helpBtn = document.getElementById('mobile-help');

      uploadBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:upload-image'));
        this.hide();
      });

      promptsBtn?.addEventListener('click', () => {
        window.open('/prompts', '_blank');
      });

      resetBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:reset-canvas'));
        this.hide();
      });

      helpBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:show-help'));
        this.hide();
      });
    }

    private setupPropertiesEvents(): void {
      // æç¤ºè¯ä¼˜åŒ–
      const optimizeBtn = this.panel?.querySelector('.optimize-btn-mobile');
      optimizeBtn?.addEventListener('click', () => {
        const textarea = document.getElementById('mobile-prompt-textarea') as HTMLTextAreaElement;
        if (textarea?.value.trim()) {
          document.dispatchEvent(new CustomEvent('editor:optimize-prompt', {
            detail: { prompt: textarea.value }
          }));
        }
      });

      // æ¸…ç©ºæç¤ºè¯
      const clearBtn = this.panel?.querySelector('.clear-btn-mobile');
      clearBtn?.addEventListener('click', () => {
        const textarea = document.getElementById('mobile-prompt-textarea') as HTMLTextAreaElement;
        if (textarea) {
          textarea.value = '';
          textarea.focus();
        }
      });

      // å‚æ•°å˜åŒ–
      const sizeSelect = document.getElementById('mobile-size-select');
      const qualitySelect = document.getElementById('mobile-quality-select');
      const styleRange = document.getElementById('mobile-style-strength') as HTMLInputElement;
      const styleValue = document.getElementById('style-strength-value');

      sizeSelect?.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        document.dispatchEvent(new CustomEvent('editor:size-change', {
          detail: { size: target.value }
        }));
      });

      qualitySelect?.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        document.dispatchEvent(new CustomEvent('editor:quality-change', {
          detail: { quality: target.value }
        }));
      });

      styleRange?.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        const value = target.value;
        if (styleValue) {
          styleValue.textContent = `${value}%`;
        }
        document.dispatchEvent(new CustomEvent('editor:style-strength-change', {
          detail: { strength: parseInt(value) }
        }));
      });

      // ç”ŸæˆæŒ‰é’®
      const generateBtn = document.getElementById('mobile-generate-btn');
      generateBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:start-generate'));
        this.hide();
      });

      // ä¿å­˜è®¾ç½®
      const saveBtn = document.getElementById('mobile-save-settings');
      saveBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:save-settings'));
      });
    }

    private setupToolsEvents(): void {
      // ç¼©æ”¾æ§åˆ¶
      const zoomIn = document.getElementById('mobile-zoom-in');
      const zoomOut = document.getElementById('mobile-zoom-out');
      
      zoomIn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:zoom-in'));
      });

      zoomOut?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:zoom-out'));
      });

      // è§†å›¾æ§åˆ¶
      const fitWindow = document.getElementById('mobile-fit-window');
      const actualSize = document.getElementById('mobile-actual-size');

      fitWindow?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:fit-window'));
      });

      actualSize?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:actual-size'));
      });

      // æ“ä½œæ§åˆ¶
      const undoBtn = document.getElementById('mobile-undo');
      const redoBtn = document.getElementById('mobile-redo');

      undoBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:undo'));
      });

      redoBtn?.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('editor:redo'));
      });

      // å¯¼å‡ºé€‰é¡¹
      const exportButtons = this.panel?.querySelectorAll('.export-btn-mobile');
      exportButtons?.forEach(button => {
        button.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const format = target.dataset.format;
          
          document.dispatchEvent(new CustomEvent('editor:export-image', {
            detail: { format }
          }));
          
          this.hide();
        });
      });
    }

    // å…¬å…±æ–¹æ³•
    public show(): void {
      if (this.panel && !this.isVisible) {
        this.panel.classList.add('visible');
        this.isVisible = true;
        
        // éšè—å…¶ä»–é¢æ¿
        document.dispatchEvent(new CustomEvent('hide-other-mobile-panels', {
          detail: { except: this.panelType }
        }));
        
        // æ·»åŠ èƒŒæ™¯é®ç½©
        this.addOverlay();
      }
    }

    public hide(): void {
      if (this.panel && this.isVisible) {
        this.panel.classList.remove('visible');
        this.isVisible = false;
        this.removeOverlay();
      }
    }

    public toggle(): void {
      if (this.isVisible) {
        this.hide();
      } else {
        this.show();
      }
    }

    private addOverlay(): void {
      const existingOverlay = document.querySelector('.mobile-panel-overlay');
      if (existingOverlay) return;

      const overlay = document.createElement('div');
      overlay.className = 'mobile-panel-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;

      document.body.appendChild(overlay);

      // ç‚¹å‡»é®ç½©å…³é—­é¢æ¿
      overlay.addEventListener('click', () => {
        this.hide();
      });

      // åŠ¨ç”»æ˜¾ç¤º
      requestAnimationFrame(() => {
        overlay.style.opacity = '1';
      });
    }

    private removeOverlay(): void {
      const overlay = document.querySelector('.mobile-panel-overlay');
      if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.remove();
        }, 300);
      }
    }
  }

  // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿
  document.addEventListener('DOMContentLoaded', () => {
    const sidebarPanel = new MobileControlPanel('sidebar');
    const propertiesPanel = new MobileControlPanel('properties');
    const toolsPanel = new MobileControlPanel('tools');

    // ç›‘å¬éšè—å…¶ä»–é¢æ¿äº‹ä»¶
    document.addEventListener('hide-other-mobile-panels', (e: any) => {
      const except = e.detail.except;
      
      if (except !== 'sidebar') sidebarPanel.hide();
      if (except !== 'properties') propertiesPanel.hide();
      if (except !== 'tools') toolsPanel.hide();
    });

    // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
    (window as any).MobileControlPanels = {
      sidebar: sidebarPanel,
      properties: propertiesPanel,
      tools: toolsPanel
    };
  });
</script>