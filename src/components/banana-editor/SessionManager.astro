---
// ä¼šè¯ç®¡ç†å™¨ç»„ä»¶
// è´Ÿè´£ç®¡ç†å¤šä¸ªå¯¹è¯ä¼šè¯çš„åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤ç­‰åŠŸèƒ½

export interface Props {
  className?: string;
}

const { className = "" } = Astro.props;
---

<div class={`session-manager ${className}`} id="session-manager">
  <!-- ä¼šè¯ç®¡ç†å™¨ä¸»è¦åŒ…å«JavaScripté€»è¾‘ -->
</div>

<script>
  // ä¼šè¯æ•°æ®ç»“æ„æ¥å£
  interface Message {
    id: string;
    role: "user" | "model";
    content: string;
    imageUrl?: string;
    timestamp: number;
    hasImage?: boolean;
  }

  interface Session {
    id: string;
    title: string;
    createdAt: number;
    updatedAt: number;
    messages: Message[];
    lastImageUrl?: string; // æœ€åç”Ÿæˆçš„å›¾ç‰‡
  }

  // ä¼šè¯ç®¡ç†å™¨ç±»
  class SessionManager {
    constructor() {
      this.sessions = new Map(); // sessionId -> Session
      this.currentSessionId = null;
      this.maxSessions = 50; // æœ€å¤šä¿å­˜50ä¸ªä¼šè¯
      this.init();
    }

    init() {
      // åŠ è½½æœ¬åœ°å­˜å‚¨çš„ä¼šè¯
      this.loadSessions();

      // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œåˆ›å»ºé»˜è®¤ä¼šè¯
      if (this.sessions.size === 0) {
        this.createNewSession();
      } else {
        // æ¢å¤æœ€åæ´»è·ƒçš„ä¼šè¯
        const lastSessionId = localStorage.getItem("banana-last-session-id");
        if (lastSessionId && this.sessions.has(lastSessionId)) {
          this.switchToSession(lastSessionId);
        } else {
          // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªä¼šè¯
          const firstSessionId = Array.from(this.sessions.keys())[0];
          this.switchToSession(firstSessionId);
        }
      }

      // è®¾ç½®å…¨å±€æ–¹æ³•
      this.setupGlobalMethods();

      console.log("ğŸ—‚ï¸ SessionManager initialized");
      console.log("ğŸ“Š Sessions loaded:", this.sessions.size);
      console.log("ğŸ¯ Current session:", this.currentSessionId);
    }

    // ç”Ÿæˆå”¯ä¸€ID
    generateId() {
      return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // åˆ›å»ºæ–°ä¼šè¯
    createNewSession(title = null) {
      const sessionId = `session_${this.generateId()}`;
      const now = Date.now();

      const session = {
        id: sessionId,
        title: title || this.generateSessionTitle(),
        createdAt: now,
        updatedAt: now,
        messages: [],
        lastImageUrl: null,
      };

      this.sessions.set(sessionId, session);
      this.switchToSession(sessionId);
      this.saveSessions();

      // è§¦å‘ä¼šè¯åˆ—è¡¨æ›´æ–°äº‹ä»¶
      this.dispatchSessionListUpdate();

      console.log("âœ¨ Created new session:", sessionId, session.title);
      return sessionId;
    }

    // ç”Ÿæˆä¼šè¯æ ‡é¢˜
    generateSessionTitle() {
      const titles = [
        "New Creation",
        "AI Image Generation",
        "Creative Chat",
        "Image Creation",
        "Art Exploration",
      ];
      const randomTitle = titles[Math.floor(Math.random() * titles.length)];
      const sessionCount = this.sessions.size + 1;
      return `${randomTitle} ${sessionCount}`;
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
    switchToSession(sessionId) {
      if (!this.sessions.has(sessionId)) {
        console.error("âŒ Session not found:", sessionId);
        return false;
      }

      this.currentSessionId = sessionId;
      localStorage.setItem("banana-last-session-id", sessionId);

      // è§¦å‘ä¼šè¯åˆ‡æ¢äº‹ä»¶
      this.dispatchSessionSwitch(sessionId);

      console.log("ğŸ”„ Switched to session:", sessionId);
      return true;
    }

    // è·å–å½“å‰ä¼šè¯
    getCurrentSession() {
      if (!this.currentSessionId) return null;
      return this.sessions.get(this.currentSessionId);
    }

    // è·å–æ‰€æœ‰ä¼šè¯
    getAllSessions() {
      return Array.from(this.sessions.values()).sort(
        (a, b) => b.updatedAt - a.updatedAt
      );
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
    addMessage(message) {
      const session = this.getCurrentSession();
      if (!session) {
        console.error("âŒ No current session to add message");
        return false;
      }

      const messageWithId = {
        id: `msg_${this.generateId()}`,
        ...message,
        timestamp: message.timestamp || Date.now(),
      };

      session.messages.push(messageWithId);
      session.updatedAt = Date.now();

      // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŒ…å«å›¾ç‰‡ï¼Œæ›´æ–°æœ€åå›¾ç‰‡URL
      if (message.role === "model" && message.imageUrl) {
        session.lastImageUrl = message.imageUrl;
      }

      this.saveSessions();

      // è§¦å‘æ¶ˆæ¯æ›´æ–°äº‹ä»¶
      this.dispatchMessageUpdate(session.id, messageWithId);

      return messageWithId;
    }

    // è·å–å½“å‰ä¼šè¯çš„æ¶ˆæ¯å†å²ï¼ˆç”¨äºå‘é€ç»™åç«¯ï¼‰
    // excludeLastUserMessage: æ˜¯å¦æ’é™¤æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼ˆé¿å…é‡å¤å‘é€ï¼‰
    getCurrentConversationHistory(excludeLastUserMessage = false) {
      const session = this.getCurrentSession();
      if (!session) return [];

      console.log(
        "ğŸ” [SessionManager] å½“å‰ä¼šè¯æ¶ˆæ¯æ€»æ•°:",
        session.messages.length
      );
      console.log(
        "ğŸ” [SessionManager] æ‰€æœ‰æ¶ˆæ¯:",
        session.messages.map((m) => ({
          role: m.role,
          content: m.content.substring(0, 50) + "...",
          timestamp: m.timestamp,
        }))
      );

      let messages = session.messages;

      // å¦‚æœéœ€è¦æ’é™¤æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼ˆé€šå¸¸åœ¨å‘é€æ–°æ¶ˆæ¯æ—¶ï¼‰
      if (excludeLastUserMessage && messages.length > 0) {
        const lastMessage = messages[messages.length - 1];
        console.log("ğŸ” [SessionManager] æœ€åä¸€æ¡æ¶ˆæ¯è§’è‰²:", lastMessage.role);
        if (lastMessage.role === "user") {
          messages = messages.slice(0, -1);
          console.log(
            "âœ‚ï¸ [SessionManager] å·²æ’é™¤æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œå‰©ä½™:",
            messages.length
          );
        }
      }

      const history = messages.map((msg) => ({
        role: msg.role,
        content: msg.content,
        timestamp: msg.timestamp,
        hasImage: !!msg.imageUrl,
        imageUrl: msg.imageUrl,
      }));

      console.log("ğŸ“¤ [SessionManager] è¿”å›çš„å¯¹è¯å†å²æ¡æ•°:", history.length);

      return history;
    }

    // æ›´æ–°ä¼šè¯æ ‡é¢˜
    updateSessionTitle(sessionId, newTitle) {
      const session = this.sessions.get(sessionId);
      if (!session) return false;

      session.title = newTitle.trim() || this.generateSessionTitle();
      session.updatedAt = Date.now();
      this.saveSessions();

      // è§¦å‘ä¼šè¯åˆ—è¡¨æ›´æ–°äº‹ä»¶
      this.dispatchSessionListUpdate();

      console.log("ğŸ“ Updated session title:", sessionId, session.title);
      return true;
    }

    // åˆ é™¤ä¼šè¯
    deleteSession(sessionId) {
      if (!this.sessions.has(sessionId)) return false;

      const session = this.sessions.get(sessionId);
      this.sessions.delete(sessionId);

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯
      if (this.currentSessionId === sessionId) {
        const remainingSessions = Array.from(this.sessions.keys());
        if (remainingSessions.length > 0) {
          this.switchToSession(remainingSessions[0]);
        } else {
          // æ²¡æœ‰å‰©ä½™ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
          this.createNewSession();
        }
      }

      this.saveSessions();
      this.dispatchSessionListUpdate();

      console.log("ğŸ—‘ï¸ Deleted session:", sessionId, session.title);
      return true;
    }

    // æ¸…ç©ºå½“å‰ä¼šè¯
    clearCurrentSession() {
      const session = this.getCurrentSession();
      if (!session) return false;

      session.messages = [];
      session.lastImageUrl = null;
      session.updatedAt = Date.now();
      this.saveSessions();

      // è§¦å‘ä¼šè¯æ¸…ç©ºäº‹ä»¶
      this.dispatchSessionClear(session.id);

      console.log("ğŸ§¹ Cleared session:", session.id);
      return true;
    }

    // å¯¼å‡ºä¼šè¯
    exportSession(sessionId) {
      const session = this.sessions.get(sessionId);
      if (!session) return null;

      const exportData = {
        exportTime: new Date().toISOString(),
        session: {
          ...session,
          messageCount: session.messages.length,
        },
      };

      return exportData;
    }

    // å¯¼å‡ºæ‰€æœ‰ä¼šè¯
    exportAllSessions() {
      const exportData = {
        exportTime: new Date().toISOString(),
        sessionCount: this.sessions.size,
        sessions: Array.from(this.sessions.values()),
      };

      return exportData;
    }

    // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°å­˜å‚¨
    saveSessions() {
      try {
        const sessionsData = Array.from(this.sessions.entries());
        localStorage.setItem("banana-sessions", JSON.stringify(sessionsData));
        console.log("ğŸ’¾ Sessions saved to localStorage");
      } catch (error) {
        console.error("âŒ Failed to save sessions:", error);
      }
    }

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¼šè¯
    loadSessions() {
      try {
        const saved = localStorage.getItem("banana-sessions");
        if (saved) {
          const sessionsData = JSON.parse(saved);
          this.sessions = new Map(sessionsData);

          // ä¿®å¤æ¯ä¸ªä¼šè¯çš„ lastImageUrlï¼Œç¡®ä¿å®ƒæ˜¯æœ€æ–°çš„
          this.sessions.forEach((session) => {
            // ä»æ¶ˆæ¯åˆ—è¡¨ä¸­æ‰¾åˆ°æœ€åä¸€å¼ å›¾ç‰‡
            let lastImageUrl = null;
            for (let i = session.messages.length - 1; i >= 0; i--) {
              const msg = session.messages[i];
              if (msg.role === "model" && msg.imageUrl) {
                lastImageUrl = msg.imageUrl;
                break;
              }
            }

            const oldLastImageUrl = session.lastImageUrl;
            session.lastImageUrl = lastImageUrl;

            if (oldLastImageUrl !== lastImageUrl) {
              console.log(
                `ğŸ”§ [SessionManager] Fixed lastImageUrl for session ${session.id}:`,
                {
                  old: oldLastImageUrl,
                  new: lastImageUrl,
                }
              );
            }
          });

          console.log(
            "ğŸ“š Sessions loaded from localStorage:",
            this.sessions.size
          );
        }
      } catch (error) {
        console.error("âŒ Failed to load sessions:", error);
        this.sessions = new Map();
      }
    }

    // é™åˆ¶ä¼šè¯æ•°é‡
    trimSessions() {
      if (this.sessions.size <= this.maxSessions) return;

      const sessions = this.getAllSessions();
      const sessionsToDelete = sessions.slice(this.maxSessions);

      sessionsToDelete.forEach((session) => {
        if (session.id !== this.currentSessionId) {
          this.sessions.delete(session.id);
        }
      });

      this.saveSessions();
      console.log("âœ‚ï¸ Trimmed sessions to", this.maxSessions);
    }

    // äº‹ä»¶åˆ†å‘æ–¹æ³•
    dispatchSessionListUpdate() {
      window.dispatchEvent(
        new CustomEvent("sessionListUpdate", {
          detail: { sessions: this.getAllSessions() },
        })
      );
    }

    dispatchSessionSwitch(sessionId) {
      const session = this.sessions.get(sessionId);
      window.dispatchEvent(
        new CustomEvent("sessionSwitch", {
          detail: { sessionId, session },
        })
      );
    }

    dispatchMessageUpdate(sessionId, message) {
      window.dispatchEvent(
        new CustomEvent("messageUpdate", {
          detail: { sessionId, message },
        })
      );
    }

    dispatchSessionClear(sessionId) {
      window.dispatchEvent(
        new CustomEvent("sessionClear", {
          detail: { sessionId },
        })
      );
    }

    // è®¾ç½®å…¨å±€æ–¹æ³•
    setupGlobalMethods() {
      window.sessionManager = this;

      // å…¨å±€å¿«æ·æ–¹æ³•
      window.createNewSession = (title) => this.createNewSession(title);
      window.switchToSession = (sessionId) => this.switchToSession(sessionId);
      window.deleteSession = (sessionId) => this.deleteSession(sessionId);
      window.clearCurrentSession = () => this.clearCurrentSession();
      window.exportCurrentSession = () => {
        if (!this.currentSessionId) return null;
        return this.exportSession(this.currentSessionId);
      };
      window.exportAllSessions = () => this.exportAllSessions();
    }

    // è·å–ä¼šè¯ç»Ÿè®¡ä¿¡æ¯
    getStats() {
      const sessions = this.getAllSessions();
      const totalMessages = sessions.reduce(
        (sum, session) => sum + session.messages.length,
        0
      );
      const totalImages = sessions.reduce(
        (sum, session) =>
          sum + session.messages.filter((msg) => msg.imageUrl).length,
        0
      );

      return {
        sessionCount: sessions.length,
        totalMessages,
        totalImages,
        currentSessionId: this.currentSessionId,
      };
    }
  }

  // åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨
  document.addEventListener("DOMContentLoaded", function () {
    window.sessionManager = new SessionManager();
  });

  // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
  window.SessionManager = SessionManager;
</script>

<style>
  .session-manager {
    display: none; /* è¿™ä¸ªç»„ä»¶æ²¡æœ‰å¯è§çš„UI */
  }
</style>
