---
// BananaEditorèåˆç»“æœæ˜¾ç¤ºç»„ä»¶
// ä¸“é—¨ç”¨äºåœ¨ç¼–è¾‘å™¨ç”»å¸ƒä¸­æ˜¾ç¤ºèåˆç»“æœ

export interface Props {
  className?: string;
}

const { className = "" } = Astro.props;
---

<div
  class={`fusion-result-display ${className}`}
  id="fusion-result-display"
  style="display: none;">
  <!-- ç»“æœå¤´éƒ¨ä¿¡æ¯ -->
  <div class="result-header">
    <div class="result-info">
      <div class="result-icon">ğŸ”€</div>
      <div class="result-text">
        <h3 class="result-title">èåˆå®Œæˆ</h3>
        <p class="result-subtitle" id="result-subtitle">å›¾ç‰‡å·²æˆåŠŸèåˆ</p>
      </div>
    </div>
    <div class="result-actions">
      <button class="result-action-btn" id="download-result" title="ä¸‹è½½ç»“æœ">
        <span class="icon">ğŸ’¾</span>
      </button>
      <button class="result-action-btn" id="share-result" title="åˆ†äº«ç»“æœ">
        <span class="icon">ğŸ”—</span>
      </button>
      <button class="result-action-btn" id="close-result" title="å…³é—­">
        <span class="icon">âœ•</span>
      </button>
    </div>
  </div>

  <!-- èåˆç»“æœå›¾ç‰‡ -->
  <div class="result-image-container">
    <div class="result-image-wrapper">
      <img id="result-image" class="result-image" alt="èåˆç»“æœ" />
      <div class="image-overlay">
        <div class="overlay-controls">
          <button class="overlay-btn" id="zoom-in-result" title="æ”¾å¤§">
            <span class="icon">ğŸ”</span>
          </button>
          <button class="overlay-btn" id="zoom-out-result" title="ç¼©å°">
            <span class="icon">ğŸ”</span>
          </button>
          <button class="overlay-btn" id="fit-result" title="é€‚åº”çª—å£">
            <span class="icon">ğŸ“</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- èåˆå‚æ•°ä¿¡æ¯ -->
  <div class="result-params">
    <div class="params-header">
      <h4 class="params-title">èåˆå‚æ•°</h4>
      <button class="params-toggle" id="params-toggle">
        <span class="icon">ğŸ“Š</span>
      </button>
    </div>
    <div class="params-content" id="params-content">
      <div class="param-item">
        <span class="param-label">èåˆæ¯”ä¾‹ï¼š</span>
        <span class="param-value" id="param-ratio">--</span>
      </div>
      <div class="param-item">
        <span class="param-label">èåˆæ¨¡å¼ï¼š</span>
        <span class="param-value" id="param-blend-mode">--</span>
      </div>
      <div class="param-item">
        <span class="param-label">èåˆå¼ºåº¦ï¼š</span>
        <span class="param-value" id="param-intensity">--</span>
      </div>
      <div class="param-item">
        <span class="param-label">è¾¹ç¼˜å¤„ç†ï¼š</span>
        <span class="param-value" id="param-edge">--</span>
      </div>
      <div class="param-item">
        <span class="param-label">è‰²å½©è°ƒå’Œï¼š</span>
        <span class="param-value" id="param-harmony">--</span>
      </div>
      <div class="param-item">
        <span class="param-label">å¤„ç†æ—¶é—´ï¼š</span>
        <span class="param-value" id="param-time">--</span>
      </div>
    </div>
  </div>

  <!-- èåˆå†å²å’Œå¯¹æ¯” -->
  <div class="result-comparison" id="result-comparison" style="display: none;">
    <div class="comparison-header">
      <h4 class="comparison-title">å¯¹æ¯”è§†å›¾</h4>
      <button class="comparison-toggle" id="comparison-toggle">
        <span class="icon">ğŸ‘ï¸</span>
      </button>
    </div>
    <div class="comparison-content">
      <div class="comparison-images">
        <div class="comparison-item">
          <img id="original-image-1" class="comparison-image" alt="åŸå›¾1" />
          <span class="comparison-label">åŸå›¾1</span>
        </div>
        <div class="comparison-item">
          <img id="original-image-2" class="comparison-image" alt="åŸå›¾2" />
          <span class="comparison-label">åŸå›¾2</span>
        </div>
        <div class="comparison-item">
          <img id="fused-image" class="comparison-image" alt="èåˆç»“æœ" />
          <span class="comparison-label">èåˆç»“æœ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- è°ƒæ•´å‚æ•°é¢æ¿ -->
  <div class="adjustment-panel" id="adjustment-panel" style="display: none;">
    <div class="adjustment-header">
      <h4 class="adjustment-title">å®æ—¶è°ƒæ•´</h4>
      <button class="adjustment-close" id="adjustment-close">âœ•</button>
    </div>
    <div class="adjustment-content">
      <div class="adjustment-group">
        <label class="adjustment-label">
          èåˆæ¯”ä¾‹
          <span class="adjustment-value" id="adj-ratio-value">50%</span>
        </label>
        <input
          type="range"
          id="adj-ratio"
          class="adjustment-range"
          min="0"
          max="100"
          value="50"
        />
      </div>

      <div class="adjustment-group">
        <label class="adjustment-label">
          èåˆå¼ºåº¦
          <span class="adjustment-value" id="adj-intensity-value">70%</span>
        </label>
        <input
          type="range"
          id="adj-intensity"
          class="adjustment-range"
          min="0"
          max="100"
          value="70"
        />
      </div>

      <div class="adjustment-group">
        <label class="adjustment-label">
          è‰²å½©è°ƒå’Œ
          <span class="adjustment-value" id="adj-harmony-value">50%</span>
        </label>
        <input
          type="range"
          id="adj-harmony"
          class="adjustment-range"
          min="0"
          max="100"
          value="50"
        />
      </div>

      <div class="adjustment-actions">
        <button class="apply-adjustment-btn" id="apply-adjustment">
          <span class="icon">âœ…</span>
          åº”ç”¨è°ƒæ•´
        </button>
        <button class="reset-adjustment-btn" id="reset-adjustment">
          <span class="icon">ğŸ”„</span>
          é‡ç½®
        </button>
      </div>
    </div>
  </div>

  <!-- å»ºè®®é¢æ¿ -->
  <div class="suggestions-panel" id="suggestions-panel">
    <div class="suggestions-header">
      <h4 class="suggestions-title">ä¼˜åŒ–å»ºè®®</h4>
      <button class="suggestions-toggle" id="suggestions-toggle">
        <span class="icon">ğŸ’¡</span>
      </button>
    </div>
    <div class="suggestions-content" id="suggestions-content">
      <div class="suggestion-list" id="suggestion-list">
        <!-- å»ºè®®é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
      </div>
    </div>
  </div>
</div>

<style>
  .fusion-result-display {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 10;
  }

  /* ç»“æœå¤´éƒ¨ */
  .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(
      --banana-gradient,
      linear-gradient(135deg, #ffd700 0%, #ffa500 100%)
    );
    border-bottom: 1px solid var(--banana-border, #ffe55c);
  }

  .result-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .result-icon {
    font-size: 24px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .result-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .result-subtitle {
    margin: 2px 0 0 0;
    font-size: 14px;
    color: var(--banana-dark, #2d1810);
    opacity: 0.8;
  }

  .result-actions {
    display: flex;
    gap: 8px;
  }

  .result-action-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: var(--banana-dark, #2d1810);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .result-action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  /* ç»“æœå›¾ç‰‡å®¹å™¨ */
  .result-image-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #f9fafb;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .result-image-wrapper {
    position: relative;
    max-width: 100%;
    max-height: 100%;
  }

  .result-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
  }

  .image-overlay {
    position: absolute;
    top: 8px;
    right: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .result-image-wrapper:hover .image-overlay {
    opacity: 1;
  }

  .overlay-controls {
    display: flex;
    gap: 4px;
  }

  .overlay-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  .overlay-btn:hover {
    background: rgba(0, 0, 0, 0.9);
    transform: scale(1.1);
  }

  /* èåˆå‚æ•°ä¿¡æ¯ */
  .result-params {
    border-top: 1px solid #e5e7eb;
    background: white;
  }

  .params-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    cursor: pointer;
  }

  .params-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .params-toggle {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .params-toggle:hover {
    background: rgba(255, 215, 0, 0.1);
  }

  .params-content {
    padding: 0 20px 16px 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 8px;
  }

  .param-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
  }

  .param-label {
    color: #666;
    font-weight: 500;
  }

  .param-value {
    color: var(--banana-dark, #2d1810);
    font-weight: 600;
  }

  /* å¯¹æ¯”è§†å›¾ */
  .result-comparison {
    border-top: 1px solid #e5e7eb;
    background: white;
  }

  .comparison-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    cursor: pointer;
  }

  .comparison-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .comparison-toggle {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .comparison-toggle:hover {
    background: rgba(255, 215, 0, 0.1);
  }

  .comparison-content {
    padding: 0 20px 16px 20px;
  }

  .comparison-images {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .comparison-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .comparison-image {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
  }

  .comparison-label {
    font-size: 12px;
    color: #666;
    font-weight: 500;
  }

  /* è°ƒæ•´é¢æ¿ */
  .adjustment-panel {
    position: absolute;
    top: 60px;
    right: 20px;
    width: 280px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 20;
  }

  .adjustment-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
  }

  .adjustment-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .adjustment-close {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .adjustment-close:hover {
    background: #f3f4f6;
  }

  .adjustment-content {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .adjustment-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .adjustment-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    font-weight: 500;
    color: var(--banana-dark, #2d1810);
  }

  .adjustment-value {
    font-size: 12px;
    color: #666;
  }

  .adjustment-range {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
  }

  .adjustment-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--banana-primary, #ffd700);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .adjustment-range::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: var(--banana-primary, #ffd700);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .adjustment-actions {
    display: flex;
    gap: 8px;
  }

  .apply-adjustment-btn,
  .reset-adjustment-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .apply-adjustment-btn {
    background: var(--banana-primary, #ffd700);
    color: var(--banana-dark, #2d1810);
  }

  .apply-adjustment-btn:hover {
    background: var(--banana-secondary, #ffa500);
  }

  .reset-adjustment-btn {
    background: #f3f4f6;
    color: #666;
  }

  .reset-adjustment-btn:hover {
    background: #e5e7eb;
  }

  /* å»ºè®®é¢æ¿ */
  .suggestions-panel {
    border-top: 1px solid #e5e7eb;
    background: white;
  }

  .suggestions-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    cursor: pointer;
  }

  .suggestions-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--banana-dark, #2d1810);
  }

  .suggestions-toggle {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .suggestions-toggle:hover {
    background: rgba(255, 215, 0, 0.1);
  }

  .suggestions-content {
    padding: 0 20px 16px 20px;
  }

  .suggestion-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .suggestion-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 8px;
    background: rgba(59, 130, 246, 0.05);
    border: 1px solid rgba(59, 130, 246, 0.1);
    border-radius: 6px;
    font-size: 12px;
    line-height: 1.4;
  }

  .suggestion-icon {
    font-size: 14px;
    margin-top: 1px;
  }

  .suggestion-text {
    flex: 1;
    color: #374151;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .result-header {
      padding: 12px 16px;
    }

    .result-title {
      font-size: 16px;
    }

    .params-content {
      grid-template-columns: 1fr;
      padding: 0 16px 12px 16px;
    }

    .comparison-images {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .comparison-image {
      height: 120px;
    }

    .adjustment-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 320px;
    }
  }

  /* åŠ¨ç”» */
  .fusion-result-display.show {
    animation: slideInUp 0.3s ease-out;
  }

  @keyframes slideInUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
  @media (prefers-contrast: high) {
    .result-params,
    .result-comparison,
    .suggestions-panel {
      border-color: #000;
    }

    .adjustment-panel {
      border-color: #000;
    }
  }

  /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
  @media (prefers-reduced-motion: reduce) {
    * {
      transition: none !important;
      animation: none !important;
    }
  }
</style>
<script>
  // BananaEditorèåˆç»“æœæ˜¾ç¤ºäº¤äº’é€»è¾‘
  class FusionResultDisplay {
    private container: HTMLElement | null = null;
    private resultImage: HTMLImageElement | null = null;
    private adjustmentPanel: HTMLElement | null = null;
    private comparisonSection: HTMLElement | null = null;
    private suggestionsContent: HTMLElement | null = null;

    private currentResult: any = null;
    private currentZoom: number = 100;
    private adjustmentParams = {
      ratio: 50,
      intensity: 70,
      harmony: 50,
    };

    constructor() {
      this.init();
    }

    private init(): void {
      this.bindElements();
      this.setupEventListeners();
      this.setupCustomEvents();
    }

    private bindElements(): void {
      this.container = document.getElementById("fusion-result-display");
      this.resultImage = document.getElementById(
        "result-image",
      ) as HTMLImageElement;
      this.adjustmentPanel = document.getElementById("adjustment-panel");
      this.comparisonSection = document.getElementById("result-comparison");
      this.suggestionsContent = document.getElementById("suggestions-content");
    }

    private setupEventListeners(): void {
      // å…³é—­æŒ‰é’®
      const closeBtn = document.getElementById("close-result");
      closeBtn?.addEventListener("click", () => {
        this.hide();
      });

      // ä¸‹è½½æŒ‰é’®
      const downloadBtn = document.getElementById("download-result");
      downloadBtn?.addEventListener("click", () => {
        this.downloadResult();
      });

      // åˆ†äº«æŒ‰é’®
      const shareBtn = document.getElementById("share-result");
      shareBtn?.addEventListener("click", () => {
        this.shareResult();
      });

      // å›¾ç‰‡ç¼©æ”¾æ§åˆ¶
      const zoomInBtn = document.getElementById("zoom-in-result");
      const zoomOutBtn = document.getElementById("zoom-out-result");
      const fitBtn = document.getElementById("fit-result");

      zoomInBtn?.addEventListener("click", () => {
        this.zoomImage(1.25);
      });

      zoomOutBtn?.addEventListener("click", () => {
        this.zoomImage(0.8);
      });

      fitBtn?.addEventListener("click", () => {
        this.fitImage();
      });

      // å‚æ•°é¢æ¿åˆ‡æ¢
      const paramsToggle = document.getElementById("params-toggle");
      const paramsContent = document.getElementById("params-content");

      paramsToggle?.addEventListener("click", () => {
        if (paramsContent) {
          const isVisible = paramsContent.style.display !== "none";
          paramsContent.style.display = isVisible ? "none" : "grid";
        }
      });

      // å¯¹æ¯”è§†å›¾åˆ‡æ¢
      const comparisonToggle = document.getElementById("comparison-toggle");
      comparisonToggle?.addEventListener("click", () => {
        this.toggleComparison();
      });

      // å»ºè®®é¢æ¿åˆ‡æ¢
      const suggestionsToggle = document.getElementById("suggestions-toggle");
      suggestionsToggle?.addEventListener("click", () => {
        if (this.suggestionsContent) {
          const isVisible = this.suggestionsContent.style.display !== "none";
          this.suggestionsContent.style.display = isVisible ? "none" : "block";
        }
      });

      // è°ƒæ•´é¢æ¿æ§åˆ¶
      this.setupAdjustmentPanel();
    }

    private setupAdjustmentPanel(): void {
      // è°ƒæ•´é¢æ¿å…³é—­
      const adjustmentClose = document.getElementById("adjustment-close");
      adjustmentClose?.addEventListener("click", () => {
        if (this.adjustmentPanel) {
          this.adjustmentPanel.style.display = "none";
        }
      });

      // è°ƒæ•´æ»‘å—
      const ratioRange = document.getElementById(
        "adj-ratio",
      ) as HTMLInputElement;
      const intensityRange = document.getElementById(
        "adj-intensity",
      ) as HTMLInputElement;
      const harmonyRange = document.getElementById(
        "adj-harmony",
      ) as HTMLInputElement;

      ratioRange?.addEventListener("input", (e) => {
        const value = (e.target as HTMLInputElement).value;
        this.adjustmentParams.ratio = parseInt(value);
        this.updateAdjustmentDisplay("ratio", value);
      });

      intensityRange?.addEventListener("input", (e) => {
        const value = (e.target as HTMLInputElement).value;
        this.adjustmentParams.intensity = parseInt(value);
        this.updateAdjustmentDisplay("intensity", value);
      });

      harmonyRange?.addEventListener("input", (e) => {
        const value = (e.target as HTMLInputElement).value;
        this.adjustmentParams.harmony = parseInt(value);
        this.updateAdjustmentDisplay("harmony", value);
      });

      // åº”ç”¨è°ƒæ•´
      const applyBtn = document.getElementById("apply-adjustment");
      applyBtn?.addEventListener("click", () => {
        this.applyAdjustments();
      });

      // é‡ç½®è°ƒæ•´
      const resetBtn = document.getElementById("reset-adjustment");
      resetBtn?.addEventListener("click", () => {
        this.resetAdjustments();
      });
    }

    private setupCustomEvents(): void {
      // ç›‘å¬èåˆå®Œæˆäº‹ä»¶
      document.addEventListener("fusionComplete", (e: any) => {
        this.showResult(e.detail);
      });

      // ç›‘å¬é”®ç›˜äº‹ä»¶
      document.addEventListener("keydown", (e) => {
        if (this.container && this.container.style.display !== "none") {
          if (e.key === "Escape") {
            this.hide();
          } else if (e.key === "+" || e.key === "=") {
            this.zoomImage(1.25);
          } else if (e.key === "-") {
            this.zoomImage(0.8);
          } else if (e.key === "0") {
            this.fitImage();
          }
        }
      });
    }

    public showResult(result: any): void {
      this.currentResult = result;

      if (!this.container || !this.resultImage) return;

      // æ˜¾ç¤ºå®¹å™¨
      this.container.style.display = "flex";
      this.container.classList.add("show");

      // è®¾ç½®ç»“æœå›¾ç‰‡
      this.resultImage.src = result.result.fusedImageUrl;
      this.resultImage.onload = () => {
        this.fitImage();
      };

      // æ›´æ–°ç»“æœä¿¡æ¯
      this.updateResultInfo(result);

      // æ˜¾ç¤ºå‚æ•°ä¿¡æ¯
      this.updateParamsDisplay(result.params);

      // æ˜¾ç¤ºå»ºè®®
      this.updateSuggestions(result.result.suggestions || []);

      // è®¾ç½®å¯¹æ¯”å›¾ç‰‡
      this.setupComparisonImages(result);

      console.log("èåˆç»“æœæ˜¾ç¤º:", result);
    }

    public hide(): void {
      if (this.container) {
        this.container.style.display = "none";
        this.container.classList.remove("show");
      }

      // éšè—è°ƒæ•´é¢æ¿
      if (this.adjustmentPanel) {
        this.adjustmentPanel.style.display = "none";
      }

      // é‡ç½®ç¼©æ”¾
      this.currentZoom = 100;

      // è§¦å‘éšè—äº‹ä»¶
      document.dispatchEvent(new CustomEvent("fusionResultHidden"));
    }

    private updateResultInfo(result: any): void {
      const subtitle = document.getElementById("result-subtitle");
      if (subtitle && result.result.metadata) {
        const { processingTime, outputImage } = result.result.metadata;
        subtitle.textContent = `å¤„ç†æ—¶é—´: ${(processingTime / 1000).toFixed(1)}s | å°ºå¯¸: ${outputImage.width}Ã—${outputImage.height}`;
      }
    }

    private updateParamsDisplay(params: any): void {
      const paramElements = {
        "param-ratio": `${params.ratio}% : ${100 - params.ratio}%`,
        "param-blend-mode": this.getBlendModeText(params.blendMode),
        "param-intensity": `${params.intensity}%`,
        "param-edge": this.getEdgeProcessingText(params.edgeProcessing),
        "param-harmony": `${params.colorHarmony}%`,
        "param-time": `${(this.currentResult?.result?.metadata?.processingTime / 1000 || 0).toFixed(1)}s`,
      };

      Object.entries(paramElements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      });
    }

    private getBlendModeText(mode: string): string {
      const modeTexts: Record<string, string> = {
        normal: "è‡ªç„¶èåˆ",
        overlay: "å åŠ èåˆ",
        multiply: "æ­£ç‰‡å åº•",
        screen: "æ»¤è‰²èåˆ",
        "soft-light": "æŸ”å…‰èåˆ",
        "hard-light": "å¼ºå…‰èåˆ",
        "color-dodge": "é¢œè‰²å‡æ·¡",
        "color-burn": "é¢œè‰²åŠ æ·±",
      };
      return modeTexts[mode] || mode;
    }

    private getEdgeProcessingText(edge: string): string {
      const edgeTexts: Record<string, string> = {
        smooth: "å¹³æ»‘è¿‡æ¸¡",
        sharp: "é”åˆ©è¾¹ç¼˜",
        feather: "ç¾½åŒ–è¾¹ç¼˜",
        gradient: "æ¸å˜è¿‡æ¸¡",
      };
      return edgeTexts[edge] || edge;
    }

    private updateSuggestions(suggestions: string[]): void {
      const suggestionList = document.getElementById("suggestion-list");
      if (!suggestionList) return;

      suggestionList.innerHTML = "";

      suggestions.forEach((suggestion) => {
        const suggestionItem = document.createElement("div");
        suggestionItem.className = "suggestion-item";
        suggestionItem.innerHTML = `
          <span class="suggestion-icon">ğŸ’¡</span>
          <span class="suggestion-text">${suggestion}</span>
        `;
        suggestionList.appendChild(suggestionItem);
      });
    }

    private setupComparisonImages(result: any): void {
      // è¿™é‡Œéœ€è¦ä»èåˆè¯·æ±‚ä¸­è·å–åŸå§‹å›¾ç‰‡
      // å®é™…å®ç°ä¸­éœ€è¦ä¿å­˜åŸå§‹å›¾ç‰‡çš„å¼•ç”¨
      const originalImage1 = document.getElementById(
        "original-image-1",
      ) as HTMLImageElement;
      const originalImage2 = document.getElementById(
        "original-image-2",
      ) as HTMLImageElement;
      const fusedImage = document.getElementById(
        "fused-image",
      ) as HTMLImageElement;

      if (fusedImage) {
        fusedImage.src = result.result.fusedImageUrl;
      }

      // åŸå§‹å›¾ç‰‡éœ€è¦ä»èåˆç»„ä»¶ä¼ é€’è¿‡æ¥
      // è¿™é‡Œæš‚æ—¶ä½¿ç”¨å ä½ç¬¦
    }

    private toggleComparison(): void {
      if (this.comparisonSection) {
        const isVisible = this.comparisonSection.style.display !== "none";
        this.comparisonSection.style.display = isVisible ? "none" : "block";
      }
    }

    private zoomImage(factor: number): void {
      this.currentZoom *= factor;
      this.currentZoom = Math.max(25, Math.min(500, this.currentZoom));

      if (this.resultImage) {
        this.resultImage.style.transform = `scale(${this.currentZoom / 100})`;
      }
    }

    private fitImage(): void {
      this.currentZoom = 100;
      if (this.resultImage) {
        this.resultImage.style.transform = "scale(1)";
      }
    }

    private updateAdjustmentDisplay(param: string, value: string): void {
      const valueElement = document.getElementById(`adj-${param}-value`);
      if (valueElement) {
        valueElement.textContent = `${value}%`;
      }
    }

    private async applyAdjustments(): void {
      if (!this.currentResult) return;

      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const applyBtn = document.getElementById("apply-adjustment");
        if (applyBtn) {
          applyBtn.textContent = "åº”ç”¨ä¸­...";
          (applyBtn as HTMLButtonElement).disabled = true;
        }

        // æ„å»ºæ–°çš„èåˆå‚æ•°
        const newParams = {
          ...this.currentResult.params,
          ratio: this.adjustmentParams.ratio,
          intensity: this.adjustmentParams.intensity,
          colorHarmony: this.adjustmentParams.harmony,
        };

        // è§¦å‘é‡æ–°èåˆäº‹ä»¶
        document.dispatchEvent(
          new CustomEvent("reapplyFusion", {
            detail: { params: newParams },
          }),
        );
      } catch (error) {
        console.error("åº”ç”¨è°ƒæ•´å¤±è´¥:", error);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const applyBtn = document.getElementById("apply-adjustment");
        if (applyBtn) {
          applyBtn.textContent = "âœ… åº”ç”¨è°ƒæ•´";
          (applyBtn as HTMLButtonElement).disabled = false;
        }
      }
    }

    private resetAdjustments(): void {
      if (!this.currentResult) return;

      // é‡ç½®ä¸ºåŸå§‹å‚æ•°
      const originalParams = this.currentResult.params;
      this.adjustmentParams = {
        ratio: originalParams.ratio,
        intensity: originalParams.intensity,
        harmony: originalParams.colorHarmony,
      };

      // æ›´æ–°UI
      const ratioRange = document.getElementById(
        "adj-ratio",
      ) as HTMLInputElement;
      const intensityRange = document.getElementById(
        "adj-intensity",
      ) as HTMLInputElement;
      const harmonyRange = document.getElementById(
        "adj-harmony",
      ) as HTMLInputElement;

      if (ratioRange) {
        ratioRange.value = this.adjustmentParams.ratio.toString();
        this.updateAdjustmentDisplay(
          "ratio",
          this.adjustmentParams.ratio.toString(),
        );
      }

      if (intensityRange) {
        intensityRange.value = this.adjustmentParams.intensity.toString();
        this.updateAdjustmentDisplay(
          "intensity",
          this.adjustmentParams.intensity.toString(),
        );
      }

      if (harmonyRange) {
        harmonyRange.value = this.adjustmentParams.harmony.toString();
        this.updateAdjustmentDisplay(
          "harmony",
          this.adjustmentParams.harmony.toString(),
        );
      }
    }

    private async downloadResult(): void {
      if (!this.currentResult || !this.resultImage) return;

      try {
        const response = await fetch(this.currentResult.result.fusedImageUrl);
        const blob = await response.blob();

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `banana-fusion-${Date.now()}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        console.log("èåˆç»“æœå·²ä¸‹è½½");
      } catch (error) {
        console.error("ä¸‹è½½å¤±è´¥:", error);
      }
    }

    private async shareResult(): void {
      if (!this.currentResult) return;

      try {
        if (navigator.share) {
          await navigator.share({
            title: "BananaEditorèåˆç»“æœ",
            text: "ä½¿ç”¨nano banana AIæŠ€æœ¯åˆ›å»ºçš„å›¾ç‰‡èåˆä½œå“",
            url: window.location.href,
          });
        } else {
          // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
          await navigator.clipboard.writeText(window.location.href);
          console.log("é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }
      } catch (error) {
        console.error("åˆ†äº«å¤±è´¥:", error);
      }
    }

    public showAdjustmentPanel(): void {
      if (this.adjustmentPanel) {
        this.adjustmentPanel.style.display = "block";
      }
    }
  }

  // åˆå§‹åŒ–èåˆç»“æœæ˜¾ç¤º
  document.addEventListener("DOMContentLoaded", () => {
    new FusionResultDisplay();
  });
</script>
