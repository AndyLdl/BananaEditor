---
// BananaEditor ç¼–è¾‘å™¨ä¸»é¡µé¢
// å±•ç¤ºæ–°è®¾è®¡çš„AIå›¾ç‰‡ç¼–è¾‘å™¨

import EditorPageLayout from "../layouts/EditorLayout.astro";
import EditorLayout from "../components/banana-editor/NewEditorLayout.astro";
import BananaAIProcessor from "../components/banana-editor/BananaAIProcessor.astro";

import UnifiedHistoryItem from "../components/banana-editor/UnifiedHistoryItem.astro";
// ChatMessage ç»„ä»¶å·²è¢« BananaAIProcessor æ›¿ä»£ï¼Œä¸å†ä½¿ç”¨
// import ChatMessage from "../components/banana-editor/ChatMessage.astro";

const title = "Editor | Nano Banana - Create & Edit AI Images Online";
const description =
  "Start creating with Nano Banana AI editor. Generate, modify, and fusion stunning images in real-time. Professional AI-powered workspace for designers, creators, and content makers. Fast, intuitive, and powered by advanced nano banana technology.";
---

<EditorPageLayout title={title} description={description}>
  <main class="editor-page">
    <!-- ç¼–è¾‘å™¨ä¸»å¸ƒå±€ -->
    <EditorLayout activeMode="generate" />

    <!-- AIå¤„ç†å™¨ç»„ä»¶ -->
    <BananaAIProcessor />

    <!-- éšè—çš„ç»„ä»¶ï¼ˆç”¨äºæ¨¡æ¿ï¼‰ -->
    <div style="display: none;">
      <UnifiedHistoryItem />
      <!-- ChatMessage ç»„ä»¶å·²ç§»é™¤ï¼ŒèŠå¤©åŠŸèƒ½ç”± BananaAIProcessor å¤„ç† -->
    </div>
  </main>
</EditorPageLayout>

<style>
  .editor-page {
    width: 100%;
    height: 100vh;
    overflow: hidden;
  }

  /* ç¡®ä¿ç¼–è¾‘å™¨å æ»¡æ•´ä¸ªé¡µé¢ */
  :global(html, body) {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  /* æç¤ºæ¶ˆæ¯åŠ¨ç”» */
  :global(@keyframes slideInRight) {
    from {
      opacity: 0;
      transform: translateX(100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  :global(@keyframes slideOutRight) {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(100%);
    }
  }
</style>

<script>
  // åŠ è½½SessionSidebar Reactç»„ä»¶
  const SessionSidebarScript = document.createElement("script");
  SessionSidebarScript.type = "text/babel";
  SessionSidebarScript.innerHTML = `
    // SessionSidebarç»„ä»¶å°†åœ¨è¿™é‡Œå®šä¹‰
    // ç”±äºå†…å®¹è¾ƒé•¿ï¼Œæˆ‘ä»¬å°†é€šè¿‡åŠ¨æ€åŠ è½½çš„æ–¹å¼å¤„ç†
  `;

  // ç¼–è¾‘å™¨é¡µé¢ä¸»æ§åˆ¶å™¨
  class EditorController {
    constructor() {
      this.currentMode = "generate";
      this.isProcessing = false;
      this.hasUnsavedWork = false;
      this.history = [];
      this.historyIndex = -1;

      this.init();
    }

    init() {
      // ç›‘å¬æ¨¡å¼åˆ‡æ¢
      window.addEventListener("editorModeChange", (e) => {
        this.handleModeChange(e.detail);
      });

      // ç›‘å¬AIå“åº”ï¼ˆç”±BananaAIProcessorå¤„ç†ï¼‰
      window.addEventListener("aiResponse", (e) => {
        this.handleAIResponse(e.detail);
      });

      // ç›‘å¬å†å²å›¾ç‰‡é€‰æ‹©
      window.addEventListener("historyImageSelected", (e) => {
        this.displayImage(e.detail);
      });

      // ç›‘å¬ä½¿ç”¨å†å²å›¾ç‰‡
      window.addEventListener("useHistoryImage", (e) => {
        this.useHistoryImage(e.detail);
      });

      // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®ï¼ˆå¼€å‘ç”¨ï¼‰- å·²ç¦ç”¨ï¼Œä½¿ç”¨çœŸå®ä¼šè¯æ•°æ®
      // this.initExampleData();
    }

    // å¤„ç†æ¨¡å¼åˆ‡æ¢
    handleModeChange(detail) {
      const { mode, icon, text } = detail;
      this.currentMode = mode;

      // æ›´æ–°ç”»å¸ƒæ ‡é¢˜
      const canvasIcon = document.getElementById("canvas-title-icon");
      const canvasText = document.getElementById("canvas-title-text");

      if (canvasIcon) canvasIcon.textContent = icon;
      if (canvasText) {
        const modeTexts = {
          generate: "å¼€å§‹åˆ›ä½œ",
          modify: "ç¼–è¾‘å›¾ç‰‡",
          fusion: "èåˆå›¾ç‰‡",
        };
        canvasText.textContent = modeTexts[mode] || "å¼€å§‹åˆ›ä½œ";
      }

      // æ›´æ–°å¿«æ·å»ºè®®
      this.updateQuickSuggestions(mode);

      // æ¸…ç©ºå½“å‰çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
      // this.clearCurrentState();
    }

    // å¤„ç†AIå“åº”
    handleAIResponse(responseData) {
      const { status, imageUrl, text, metadata } = responseData;

      if (status === "success" && imageUrl) {
        // åˆ›å»ºå›¾ç‰‡æ•°æ®å¯¹è±¡
        const imageData = {
          id: this.generateId(),
          imageUrl,
          thumbnailUrl: responseData.thumbnailUrl || imageUrl,
          prompt: responseData.prompt || text,
          timestamp: Date.now(),
          size: metadata?.dimensions
            ? `${metadata.dimensions.width}x${metadata.dimensions.height}`
            : "512x512",
          mode: this.currentMode,
          metadata,
        };

        // æ˜¾ç¤ºå›¾ç‰‡
        this.displayImage(imageData);

        // æ·»åŠ åˆ°å†å²
        this.addToHistory(imageData);

        console.log("âœ… AIå“åº”å¤„ç†å®Œæˆ:", imageData);
      } else if (status === "error") {
        console.error("âŒ AIç”Ÿæˆå¤±è´¥:", text);
        this.hideCanvasLoading();
        this.showToast(text || "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
      }
    }

    // æ˜¾ç¤ºå›¾ç‰‡
    displayImage(imageData) {
      const canvasEmpty = document.getElementById("canvas-empty");
      const canvasImage = document.getElementById("canvas-image");
      const currentImage = document.getElementById("current-image");
      const imageDimensions = document.getElementById("image-dimensions");
      const imageSize = document.getElementById("image-size");

      if (canvasEmpty) canvasEmpty.style.display = "none";
      if (canvasImage) canvasImage.style.display = "flex";

      if (currentImage) {
        currentImage.src = imageData.imageUrl;
        currentImage.alt = imageData.prompt || "ç”Ÿæˆçš„å›¾ç‰‡";
      }

      if (imageDimensions) {
        imageDimensions.textContent = imageData.size || "--";
      }

      if (imageSize) {
        // è®¡ç®—æ–‡ä»¶å¤§å°ï¼ˆæ¨¡æ‹Ÿï¼‰
        const sizeKB = Math.floor(Math.random() * 500 + 100);
        imageSize.textContent = `${sizeKB}KB`;
      }
    }

    // æ·»åŠ åˆ°å†å²
    addToHistory(imageData) {
      window.dispatchEvent(
        new CustomEvent("imageGenerated", {
          detail: imageData,
        })
      );
    }

    // ä½¿ç”¨å†å²å›¾ç‰‡
    useHistoryImage(imageData) {
      this.displayImage(imageData);

      // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
      if (window.chatManager) {
        window.chatManager.addSystemMessage(
          `å·²åˆ‡æ¢åˆ°å›¾ç‰‡: ${imageData.prompt}`
        );
      }
    }

    // æ˜¾ç¤ºç”»å¸ƒåŠ è½½çŠ¶æ€
    showCanvasLoading() {
      const canvasEmpty = document.getElementById("canvas-empty");
      const canvasImage = document.getElementById("canvas-image");
      const canvasLoading = document.getElementById("canvas-loading");

      if (canvasEmpty) canvasEmpty.style.display = "none";
      if (canvasImage) canvasImage.style.display = "none";
      if (canvasLoading) canvasLoading.style.display = "flex";

      // é‡ç½®è¿›åº¦
      const progressFill = document.getElementById("loading-progress-fill");
      const progressText = document.getElementById("loading-progress-text");
      if (progressFill) progressFill.style.width = "0%";
      if (progressText) progressText.textContent = "0%";
    }

    // éšè—ç”»å¸ƒåŠ è½½çŠ¶æ€
    hideCanvasLoading() {
      const canvasLoading = document.getElementById("canvas-loading");
      if (canvasLoading) canvasLoading.style.display = "none";
    }

    // æ›´æ–°å¿«æ·å»ºè®®
    updateQuickSuggestions(mode) {
      const suggestions = document.querySelector(".suggestions-list");
      if (!suggestions) return;

      const suggestionsByMode = {
        generate: [
          { text: "ğŸ± å¯çˆ±å°çŒ«", prompt: "ä¸€åªå¯çˆ±çš„æ©™è‰²å°çŒ«" },
          { text: "ğŸï¸ é£æ™¯ç”»", prompt: "ç¾ä¸½çš„å±±æ°´é£æ™¯ç”»" },
          { text: "ğŸ  å®¤å†…è®¾è®¡", prompt: "ç°ä»£ç®€çº¦çš„å®¤å†…è®¾è®¡" },
          { text: "ğŸ¨ æŠ½è±¡è‰ºæœ¯", prompt: "è‰²å½©ä¸°å¯Œçš„æŠ½è±¡è‰ºæœ¯ä½œå“" },
        ],
        modify: [
          { text: "ğŸŒ… æ”¹å˜å¤©ç©º", prompt: "æŠŠå¤©ç©ºæ”¹æˆå¤•é˜³è‰²" },
          { text: "ğŸ¨ æ”¹å˜é¢œè‰²", prompt: "æ”¹å˜ä¸»ä½“é¢œè‰²" },
          { text: "âœ¨ æ·»åŠ æ•ˆæœ", prompt: "æ·»åŠ å…‰å½±æ•ˆæœ" },
          { text: "ğŸ”„ æ”¹å˜é£æ ¼", prompt: "æ”¹æˆå¡é€šé£æ ¼" },
        ],
        fusion: [
          { text: "ğŸŒŠ è‡ªç„¶èåˆ", prompt: "è‡ªç„¶è¿‡æ¸¡ï¼Œæ— ç¼èåˆ" },
          { text: "ğŸ¨ è‰ºæœ¯èåˆ", prompt: "åˆ›é€ è‰ºæœ¯æ•ˆæœçš„èåˆ" },
          { text: "ğŸ’« æ¢¦å¹»æ•ˆæœ", prompt: "è¥é€ æ¢¦å¹»çš„è§†è§‰æ•ˆæœ" },
          { text: "ğŸ”¥ åˆ›æ„æ··åˆ", prompt: "å¤§èƒ†çš„åˆ›æ„æ··åˆæ•ˆæœ" },
        ],
      };

      const modeSuggestions =
        suggestionsByMode[mode] || suggestionsByMode.generate;

      suggestions.innerHTML = "";
      modeSuggestions.forEach((item) => {
        const button = document.createElement("button");
        button.className = "suggestion-tag";
        button.textContent = item.text;
        button.dataset.prompt = item.prompt;

        button.addEventListener("click", () => {
          const chatInput = document.getElementById("chat-input");
          if (chatInput) {
            chatInput.value = item.prompt;
            chatInput.focus();
          }
        });

        suggestions.appendChild(button);
      });
    }

    // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
    initExampleData() {
      // å»¶è¿Ÿæ·»åŠ ç¤ºä¾‹å†å²æ•°æ®
      setTimeout(() => {
        const exampleHistory = [
          {
            id: "example-1",
            imageUrl: "https://picsum.photos/seed/cat/512/512",
            prompt: "ä¸€åªå¯çˆ±çš„æ©™è‰²å°çŒ«ååœ¨èŠ±å›­é‡Œ",
            timestamp: Date.now() - 3600000, // 1å°æ—¶å‰
            size: "512x512",
            mode: "generate",
          },
          {
            id: "example-2",
            imageUrl: "https://picsum.photos/seed/landscape/512/512",
            prompt: "ç¾ä¸½çš„å±±æ°´é£æ™¯ç”»ï¼Œæ°´å¢¨ç”»é£æ ¼",
            timestamp: Date.now() - 7200000, // 2å°æ—¶å‰
            size: "512x512",
            mode: "generate",
          },
        ];

        // æ·»åŠ ç¤ºä¾‹å†å²
        exampleHistory.forEach((item) => {
          this.addToHistory(item);
        });

        // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
        this.displayImage(exampleHistory[0]);
      }, 1000);
    }

    // ç”ŸæˆID
    generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ä¿å­˜å½“å‰å·¥ä½œ
    saveCurrentWork() {
      // å®ç°ä¿å­˜é€»è¾‘
      console.log("ä¿å­˜å½“å‰å·¥ä½œ");
      this.hasUnsavedWork = false;

      // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
      this.showToast("å·¥ä½œå·²ä¿å­˜");
    }

    // æ’¤é”€æ“ä½œ
    undo() {
      if (this.historyIndex > 0) {
        this.historyIndex--;
        const previousState = this.history[this.historyIndex];
        this.restoreState(previousState);
        console.log("æ’¤é”€æ“ä½œ");
      }
    }

    // é‡åšæ“ä½œ
    redo() {
      if (this.historyIndex < this.history.length - 1) {
        this.historyIndex++;
        const nextState = this.history[this.historyIndex];
        this.restoreState(nextState);
        console.log("é‡åšæ“ä½œ");
      }
    }

    // å–æ¶ˆå½“å‰æ“ä½œ
    cancelCurrentOperation() {
      if (this.isProcessing) {
        this.isProcessing = false;
        this.hideCanvasLoading();
        console.log("å–æ¶ˆå½“å‰æ“ä½œ");

        // æ˜¾ç¤ºå–æ¶ˆæç¤º
        this.showToast("æ“ä½œå·²å–æ¶ˆ");
      }
    }

    // æ¢å¤çŠ¶æ€
    restoreState(state) {
      // å®ç°çŠ¶æ€æ¢å¤é€»è¾‘
      console.log("æ¢å¤çŠ¶æ€:", state);
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    showToast(message) {
      // ç®€å•çš„æç¤ºå®ç°
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #2d1810;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        animation: slideInRight 0.3s ease-out;
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = "slideOutRight 0.3s ease-in";
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 2000);
    }
  }

  // åˆå§‹åŒ–ç¼–è¾‘å™¨æ§åˆ¶å™¨
  document.addEventListener("DOMContentLoaded", function () {
    window.editorController = new EditorController();
  });
</script>
