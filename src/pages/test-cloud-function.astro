---
// äº‘å‡½æ•°æµ‹è¯•é¡µé¢
import Layout from "../layouts/Layout.astro";
---

<Layout title="äº‘å‡½æ•°æµ‹è¯•">
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">
        ğŸŒ Banana AI äº‘å‡½æ•°æµ‹è¯•
      </h1>

      <!-- é…ç½®çŠ¶æ€ -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">ğŸ“‹ é…ç½®çŠ¶æ€</h2>
        <div id="config-status" class="space-y-2">
          <div class="flex justify-between">
            <span>äº‘å‡½æ•° URL:</span>
            <span id="function-url" class="font-mono text-sm">æ£€æŸ¥ä¸­...</span>
          </div>
          <div class="flex justify-between">
            <span>é¡¹ç›® ID:</span>
            <span id="project-id" class="font-mono text-sm">æ£€æŸ¥ä¸­...</span>
          </div>
          <div class="flex justify-between">
            <span>é…ç½®çŠ¶æ€:</span>
            <span id="config-valid" class="font-mono text-sm">æ£€æŸ¥ä¸­...</span>
          </div>
        </div>
      </div>

      <!-- æµ‹è¯•è¡¨å• -->
      <div class="bg-white border border-gray-200 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>

        <form id="test-form" class="space-y-4">
          <div>
            <label
              for="test-prompt"
              class="block text-sm font-medium text-gray-700 mb-2">
              æµ‹è¯•æç¤ºè¯
            </label>
            <textarea
              id="test-prompt"
              name="prompt"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="è¾“å…¥æµ‹è¯•æç¤ºè¯ï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„æ©™è‰²å°çŒ«ååœ¨èŠ±å›­é‡Œ"
            ></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label
                for="test-style"
                class="block text-sm font-medium text-gray-700 mb-2">
                é£æ ¼
              </label>
              <select
                id="test-style"
                name="style"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="realistic">å†™å®é£æ ¼</option>
                <option value="artistic">è‰ºæœ¯é£æ ¼</option>
                <option value="cartoon">å¡é€šé£æ ¼</option>
                <option value="watercolor">æ°´å½©é£æ ¼</option>
              </select>
            </div>

            <div>
              <label
                for="test-quality"
                class="block text-sm font-medium text-gray-700 mb-2">
                è´¨é‡
              </label>
              <select
                id="test-quality"
                name="quality"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="standard">æ ‡å‡†</option>
                <option value="high">é«˜è´¨é‡</option>
                <option value="ultra">è¶…é«˜è´¨é‡</option>
              </select>
            </div>

            <div>
              <label
                for="test-creativity"
                class="block text-sm font-medium text-gray-700 mb-2">
                åˆ›æ„ç¨‹åº¦
              </label>
              <input
                type="range"
                id="test-creativity"
                name="creativity"
                min="0"
                max="100"
                value="50"
                class="w-full"
              />
              <div class="text-center text-sm text-gray-500">
                <span id="creativity-value">50</span>%
              </div>
            </div>
          </div>

          <div class="flex gap-4">
            <button
              type="submit"
              id="test-button"
              class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
              ğŸš€ æµ‹è¯•äº‘å‡½æ•°
            </button>

            <button
              type="button"
              id="health-check-button"
              class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
              ğŸ¥ å¥åº·æ£€æŸ¥
            </button>
          </div>
        </form>
      </div>

      <!-- æµ‹è¯•ç»“æœ -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="test-results" class="space-y-4">
          <div class="text-gray-500 text-center py-8">
            ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æµ‹è¯•...
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // äº‘å‡½æ•°æµ‹è¯•è„šæœ¬
  class CloudFunctionTester {
    constructor() {
      // ä¼˜å…ˆä½¿ç”¨Firebaseäº‘å‡½æ•°URL
      this.functionUrl =
        import.meta.env.PUBLIC_FIREBASE_FUNCTION_URL ||
        import.meta.env.PUBLIC_CLOUD_FUNCTION_URL ||
        "https://us-central1-bananaeditor-927be.cloudfunctions.net/bananaAIGenerator";
      this.init();
    }

    init() {
      this.checkConfiguration();
      this.bindEvents();
    }

    // æ£€æŸ¥é…ç½®
    checkConfiguration() {
      const functionUrlElement = document.getElementById("function-url");
      const projectIdElement = document.getElementById("project-id");
      const configValidElement = document.getElementById("config-valid");

      if (functionUrlElement) {
        functionUrlElement.textContent = this.functionUrl || "æœªé…ç½®";
      }

      if (projectIdElement) {
        const projectId = import.meta.env.GOOGLE_CLOUD_PROJECT_ID;
        projectIdElement.textContent = projectId || "æœªé…ç½®";
      }

      if (configValidElement) {
        const isValid =
          this.functionUrl && !this.functionUrl.includes("your-project-id");
        configValidElement.textContent = isValid ? "âœ… å·²é…ç½®" : "âŒ éœ€è¦é…ç½®";
        configValidElement.className = `font-mono text-sm ${isValid ? "text-green-600" : "text-red-600"}`;
      }
    }

    // ç»‘å®šäº‹ä»¶
    bindEvents() {
      const testForm = document.getElementById("test-form");
      const healthCheckButton = document.getElementById("health-check-button");
      const creativitySlider = document.getElementById("test-creativity");
      const creativityValue = document.getElementById("creativity-value");

      if (testForm) {
        testForm.addEventListener("submit", (e) => {
          e.preventDefault();
          this.runTest();
        });
      }

      if (healthCheckButton) {
        healthCheckButton.addEventListener("click", () => {
          this.runHealthCheck();
        });
      }

      if (creativitySlider && creativityValue) {
        creativitySlider.addEventListener("input", (e) => {
          creativityValue.textContent = e.target.value;
        });
      }
    }

    // æ˜¾ç¤ºç»“æœ
    showResult(title, content, type = "info") {
      const resultsContainer = document.getElementById("test-results");
      if (!resultsContainer) return;

      const resultElement = document.createElement("div");
      resultElement.className = `p-4 rounded-md border ${this.getResultClasses(type)}`;

      resultElement.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            ${this.getResultIcon(type)}
          </div>
          <div class="flex-1">
            <h3 class="font-semibold mb-2">${title}</h3>
            <div class="text-sm">${content}</div>
          </div>
          <div class="text-xs text-gray-500">
            ${new Date().toLocaleTimeString()}
          </div>
        </div>
      `;

      // æ¸…ç©ºä¹‹å‰çš„ç»“æœæˆ–æ·»åŠ åˆ°é¡¶éƒ¨
      if (
        resultsContainer.children.length === 1 &&
        resultsContainer.children[0].textContent.includes("ç‚¹å‡»æµ‹è¯•æŒ‰é’®")
      ) {
        resultsContainer.innerHTML = "";
      }

      resultsContainer.insertBefore(resultElement, resultsContainer.firstChild);
    }

    getResultClasses(type) {
      switch (type) {
        case "success":
          return "bg-green-50 border-green-200 text-green-800";
        case "error":
          return "bg-red-50 border-red-200 text-red-800";
        case "warning":
          return "bg-yellow-50 border-yellow-200 text-yellow-800";
        default:
          return "bg-blue-50 border-blue-200 text-blue-800";
      }
    }

    getResultIcon(type) {
      switch (type) {
        case "success":
          return "âœ…";
        case "error":
          return "âŒ";
        case "warning":
          return "âš ï¸";
        default:
          return "â„¹ï¸";
      }
    }

    // å¥åº·æ£€æŸ¥
    async runHealthCheck() {
      this.showResult("å¥åº·æ£€æŸ¥", "æ­£åœ¨æ£€æŸ¥äº‘å‡½æ•°çŠ¶æ€...", "info");

      if (!this.functionUrl || this.functionUrl.includes("your-project-id")) {
        this.showResult(
          "å¥åº·æ£€æŸ¥å¤±è´¥",
          "äº‘å‡½æ•° URL æœªæ­£ç¡®é…ç½®ã€‚è¯·è¿è¡Œ: <code>npm run config:frontend</code>",
          "error"
        );
        return;
      }

      try {
        const startTime = Date.now();
        const response = await fetch(this.functionUrl, {
          method: "GET",
          headers: {
            "User-Agent": "CloudFunction-Tester/1.0",
          },
        });

        const responseTime = Date.now() - startTime;

        if (response.ok) {
          this.showResult(
            "å¥åº·æ£€æŸ¥æˆåŠŸ",
            `äº‘å‡½æ•°å“åº”æ­£å¸¸<br>
             çŠ¶æ€ç : ${response.status}<br>
             å“åº”æ—¶é—´: ${responseTime}ms<br>
             URL: <code>${this.functionUrl}</code>`,
            "success"
          );
        } else {
          this.showResult(
            "å¥åº·æ£€æŸ¥è­¦å‘Š",
            `äº‘å‡½æ•°å“åº”å¼‚å¸¸<br>
             çŠ¶æ€ç : ${response.status}<br>
             å“åº”æ—¶é—´: ${responseTime}ms`,
            "warning"
          );
        }
      } catch (error) {
        this.showResult(
          "å¥åº·æ£€æŸ¥å¤±è´¥",
          `ç½‘ç»œé”™è¯¯: ${error.message}<br>
           è¯·æ£€æŸ¥äº‘å‡½æ•°æ˜¯å¦å·²éƒ¨ç½²`,
          "error"
        );
      }
    }

    // è¿è¡ŒåŠŸèƒ½æµ‹è¯•
    async runTest() {
      const testButton = document.getElementById("test-button");
      const form = document.getElementById("test-form");

      if (!testButton || !form) return;

      // ç¦ç”¨æŒ‰é’®
      testButton.disabled = true;
      testButton.textContent = "ğŸ”„ æµ‹è¯•ä¸­...";

      this.showResult("åŠŸèƒ½æµ‹è¯•", "æ­£åœ¨æµ‹è¯•åŠ å¯† AI å›¾ç‰‡ç”ŸæˆåŠŸèƒ½...", "info");

      try {
        // ä½¿ç”¨åŠ å¯†å®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•
        const { SecureBananaAIProcessor } = await import(
          "../utils/secure-api-client.ts"
        );
        const secureProcessor = new SecureBananaAIProcessor(this.functionUrl);

        // è·å–è¡¨å•æ•°æ®
        const formData = new FormData(form);
        const prompt = formData.get("prompt") as string;

        // æ·»åŠ è¯·æ±‚ID
        const requestId = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const startTime = Date.now();

        // ä½¿ç”¨åŠ å¯†å®¢æˆ·ç«¯è°ƒç”¨
        const responseData = await secureProcessor.callCloudFunction(
          prompt,
          []
        );

        const responseTime = Date.now() - startTime;

        if (responseData.success) {
          this.showResult(
            "åŠŸèƒ½æµ‹è¯•æˆåŠŸ",
            `AI ç”ŸæˆåŠŸèƒ½æ­£å¸¸<br>
             è¯·æ±‚ID: <code>${responseData.data?.metadata?.requestId || requestId}</code><br>
             å¤„ç†æ—¶é—´: ${responseData.data?.metadata?.processingTime || responseTime}ms<br>
             ä½¿ç”¨æ¨¡å‹: ${responseData.data?.metadata?.model || "unknown"}<br>
             ç”Ÿæˆå†…å®¹é•¿åº¦: ${responseData.data?.generatedPrompt?.length || 0} å­—ç¬¦<br>
             å»ºè®®æ•°é‡: ${responseData.data?.suggestions?.length || 0} ä¸ª`,
            "success"
          );

          // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
          if (responseData.data?.generatedPrompt) {
            this.showResult(
              "ç”Ÿæˆå†…å®¹é¢„è§ˆ",
              `<div class="bg-gray-100 p-3 rounded text-sm">
                ${responseData.data.generatedPrompt.substring(0, 200)}${responseData.data.generatedPrompt.length > 200 ? "..." : ""}
               </div>`,
              "info"
            );
          }
        } else {
          this.showResult(
            "åŠŸèƒ½æµ‹è¯•å¤±è´¥",
            `é”™è¯¯ä¿¡æ¯: ${responseData.error?.message || "æœªçŸ¥é”™è¯¯"}<br>
             é”™è¯¯ä»£ç : ${responseData.error?.code || "UNKNOWN"}<br>
             å“åº”æ—¶é—´: ${responseTime}ms`,
            "error"
          );
        }
      } catch (error) {
        this.showResult(
          "åŠŸèƒ½æµ‹è¯•å¼‚å¸¸",
          `ç½‘ç»œé”™è¯¯: ${error.message}<br>
           è¯·æ£€æŸ¥äº‘å‡½æ•°é…ç½®å’Œç½‘ç»œè¿æ¥`,
          "error"
        );
      } finally {
        // æ¢å¤æŒ‰é’®
        testButton.disabled = false;
        testButton.textContent = "ğŸš€ æµ‹è¯•äº‘å‡½æ•°";
      }
    }
  }

  // åˆå§‹åŒ–æµ‹è¯•å™¨
  document.addEventListener("DOMContentLoaded", () => {
    new CloudFunctionTester();
  });
</script>

<style>
  code {
    background-color: rgba(0, 0, 0, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: "Courier New", monospace;
    font-size: 0.9em;
  }
</style>
